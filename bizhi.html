<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>壁纸与视频设置</title>
    <!-- 引入Cloudinary JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/cloudinary-core@2.13.0/cloudinary-core-shrinkwrap.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .phone {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 状态栏样式 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .status-left, .status-center, .status-right {
            display: flex;
            align-items: center;
        }

        .status-left {
            flex: 1;
        }

        .status-center {
            flex: 2;
            justify-content: center;
        }

        .status-right {
            flex: 1;
            justify-content: flex-end;
        }

        .status-icon {
            width: 18px;
            height: 18px;
            margin: 0 5px;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            padding: 80px 20px 20px 20px;
            overflow-y: auto;
        }

        .wallpaper-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .wallpaper-title {
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .wallpaper-preview {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .wallpaper-preview img, .wallpaper-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .upload-options {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .upload-btn {
            flex: 1;
            padding: 15px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .set-btn {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            background: linear-gradient(45deg, #007AFF, #0A84FF);
            border: none;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .set-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }

        .set-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 返回按钮 */
        .back-btn {
            position: fixed;
            top: 55px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        /* 自定义模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #333;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 80%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .modal-message {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        
        .modal-button {
            padding: 12px 30px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-button:hover {
            background: #0062cc;
        }
        
        /* 上传进度模态框 */
        .progress-modal .modal-content {
            padding: 40px 30px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        /* 响应式设计 */
        @media (max-width: 500px) {
            .modal-content {
                width: 90%;
                padding: 20px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-message {
                font-size: 14px;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-left">
                <span class="time" id="current-time">00:00</span>
            </div>
            <div class="status-center">
                <!-- 中间留空 -->
            </div>
            <div class="status-right">
                <!-- 信号图标 -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 17L5 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 17L12 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19 17L19 2" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <!-- 电池图标 -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="7" width="16" height="10" rx="3" stroke="white" stroke-width="2"/>
                    <path d="M20 10V14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <rect x="4" y="9" width="12" height="6" rx="2" fill="white"/>
                </svg>
            </div>
        </div>

        <!-- 返回按钮 -->
        <div class="back-btn" onclick="goBack()">
            <svg viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="wallpaper-container">
                <h2 class="wallpaper-title">设置壁纸与视频</h2>
                
                <div class="wallpaper-preview" id="wallpaperPreview">
                    <span>预览区域</span>
                </div>
                
                <div class="upload-options">
                    <button class="upload-btn" onclick="document.getElementById('imageUpload').click()">
                        上传图片壁纸
                    </button>
                    <button class="upload-btn" onclick="document.getElementById('videoUpload').click()">
                        上传视频壁纸
                    </button>
                </div>
                
                <div style="color: #aaa; font-size: 12px; text-align: center; margin: 10px 0;">
                    注意：视频文件将上传到Cloudinary存储（需在<a href="shezhi.html" style="color: #007AFF;">设置页面</a>配置密钥），图片文件保存在本地。
                    <br>视频上传后可通过Cloudinary URL访问，不占用本地存储空间。
                </div>
                
                <input type="file" id="imageUpload" class="file-input" accept="image/*" onchange="previewImage(event)">
                <input type="file" id="videoUpload" class="file-input" accept="video/*" onchange="previewVideo(event)">
                
                <button class="set-btn" id="setWallpaperBtn" disabled onclick="setWallpaper()">
                    设置为壁纸
                </button>
            </div>
        </div>
        
        <!-- 自定义模态框 -->
        <div id="customModal" class="modal">
            <div class="modal-content">
                <div class="modal-title" id="modalTitle">提示</div>
                <div class="modal-message" id="modalMessage">这是一条提示信息</div>
                <button class="modal-button" onclick="closeModal()">确定</button>
            </div>
        </div>
        
        <!-- 上传进度模态框 -->
        <div id="progressModal" class="modal progress-modal">
            <div class="modal-content">
                <div class="spinner"></div>
                <div class="modal-message" id="progressMessage">正在上传...</div>
            </div>
        </div>

        <script>
            // 更新时间
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('current-time').textContent = timeString;
            }

            // 每秒更新一次时间
            setInterval(updateTime, 1000);
            updateTime(); // 初始化时间

            // 返回主屏幕
            function goBack() {
                window.location.href = 'index.html';
            }
            
            // 显示自定义模态框
            function showModal(title, message) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').innerHTML = message;
                document.getElementById('customModal').style.display = 'flex';
            }
            
            // 关闭自定义模态框
            function closeModal() {
                document.getElementById('customModal').style.display = 'none';
            }
            
            // 显示进度模态框
            function showProgressModal(message) {
                document.getElementById('progressMessage').innerHTML = message;
                document.getElementById('progressModal').style.display = 'flex';
            }
            
            // 关闭进度模态框
            function closeProgressModal() {
                document.getElementById('progressModal').style.display = 'none';
            }

            // 预览图片
            function previewImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('wallpaperPreview');
                        preview.innerHTML = `<img src="${e.target.result}" alt="壁纸预览" style="width:100%;height:100%;object-fit:cover;">`;
                        preview.dataset.imageUrl = e.target.result;
                        preview.dataset.fileName = file.name;
                        preview.dataset.fileSize = file.size;
                        preview.dataset.isFileVideo = "false";
                        document.getElementById('setWallpaperBtn').disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 上传视频到Cloudinary
            function uploadVideoToCloudinary(file, cloudName, uploadPreset) {
                // 检查文件大小（限制为50MB）
                if (file.size > 50 * 1024 * 1024) {
                    showModal('文件过大', '视频文件过大，请选择小于50MB的文件');
                    return;
                }
                
                // 显示上传进度
                showProgressModal('正在上传视频到Cloudinary...');
                
                // 验证配置
                if (!cloudName || !uploadPreset) {
                    closeProgressModal();
                    showModal('错误', 'Cloudinary配置不完整，请检查设置');
                    return;
                }
                
                // 创建FormData对象
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', uploadPreset);
                // 不需要再添加cloud_name到formData中，因为它已经在URL中了
                
                // 上传到Cloudinary
                console.log('开始上传到Cloudinary，Cloud Name:', cloudName);
                
                // 更新进度模态框消息
                showProgressModal('正在上传视频到Cloudinary...<br>文件大小: ' + (file.size/1024/1024).toFixed(2) + 'MB<br>请耐心等待，大文件上传需要一些时间');
                
                fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Cloudinary响应状态:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Cloudinary错误响应:', text);
                            throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Cloudinary响应数据:', data);
                    closeProgressModal();
                    
                    if (data.secure_url) {
                        closeProgressModal();
                        // 保存视频URL到localStorage
                        const wallpaperData = {
                            type: 'video',
                            src: data.secure_url,
                            // 为视频生成海报，使用视频的第一帧作为海报
                            poster: data.secure_url.replace('/upload/', '/upload/f_auto,q_auto,so_0/').replace(/\.(mp4|webm|ogg|mov)$/, '.jpg'),
                            fileName: file.name,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('wallpaper', JSON.stringify(wallpaperData));
                        console.log('壁纸数据已保存到localStorage:', wallpaperData);
                        showModal('成功', '视频壁纸已成功上传并设置！');
                        
                        // 更新预览显示
                        const preview = document.getElementById('wallpaperPreview');
                        preview.innerHTML = `<video src="${data.secure_url}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`;
                        preview.dataset.videoUrl = data.secure_url;
                        preview.dataset.isFileVideo = "true";
                    } else {
                        throw new Error('上传失败: ' + (data.error?.message || '未知错误'));
                    }
                })
                .catch(error => {
                    closeProgressModal();
                    
                    console.error('上传错误:', error);
                    let errorMessage = '视频上传失败: ' + error.message + '\n\n';
                    errorMessage += '请检查以下配置：\n';
                    errorMessage += '1. Upload Preset是否设置为"Unsigned"模式\n';
                    errorMessage += '2. Cloudinary账户是否有足够的存储空间\n';
                    errorMessage += '3. 网络连接是否正常\n\n';
                    errorMessage += '解决方法：登录Cloudinary控制台 -> Settings -> Upload -> 找到您的Upload Preset -> 设置为Unsigned模式';
                    showModal('上传失败', errorMessage);
                });
            }

            // 预览视频
            function previewVideo(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('wallpaperPreview');
                        preview.innerHTML = `<video src="${e.target.result}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`;
                        preview.dataset.videoFile = file.name; // 保存文件名
                        preview.dataset.isFileVideo = "true";
                        document.getElementById('setWallpaperBtn').disabled = false;
                        
                        // 保存文件对象以便上传时使用
                        window.currentVideoFile = file;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 设置壁纸
            function setWallpaper() {
                const preview = document.getElementById('wallpaperPreview');
                const isFileVideo = preview.dataset.isFileVideo === "true";
                
                if (isFileVideo) {
                    // 视频壁纸 - 上传到Cloudinary
                    if (window.currentVideoFile) {
                        // 检查是否已配置Cloudinary
                        const cloudName = localStorage.getItem('cloudinaryCloudName');
                        const uploadPreset = localStorage.getItem('cloudinaryUploadPreset');
                        
                        if (!cloudName || !uploadPreset) {
                            showModal('配置缺失', '请先在设置页面配置Cloudinary！');
                            window.location.href = 'shezhi.html';
                            return;
                        }
                        
                        // 上传视频到Cloudinary
                        uploadVideoToCloudinary(window.currentVideoFile, cloudName, uploadPreset);
                    }
                } else {
                    // 图片壁纸 - 保存到localStorage
                    const imageUrl = preview.dataset.imageUrl;
                    if (imageUrl) {
                        const wallpaperData = {
                            type: 'image',
                            src: imageUrl,
                            timestamp: new Date().toISOString()
                        };
                        localStorage.setItem('wallpaper', JSON.stringify(wallpaperData));
                        showModal('成功', '图片壁纸已设置！');
                    }
                }
            }

            // 页面加载时检查是否有保存的壁纸
            window.onload = function() {
                updateTime(); // 初始化时间
                
                const savedWallpaper = localStorage.getItem('wallpaper');
                if (savedWallpaper) {
                    try {
                        // 解析壁纸数据
                        const wallpaperData = JSON.parse(savedWallpaper);
                        const preview = document.getElementById('wallpaperPreview');
                        
                        // 显示壁纸
                        if (wallpaperData.type === 'video') {
                            // 视频壁纸 - 从Cloudinary加载
                            if (wallpaperData.src) {
                                preview.innerHTML = `<video src="${wallpaperData.src}" autoplay muted loop style="width:100%;height:100%;object-fit:cover;"></video>`;
                                preview.dataset.videoUrl = wallpaperData.src;
                                preview.dataset.isFileVideo = "true";
                            } else {
                                preview.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;font-size:14px;"><div>视频壁纸: ${wallpaperData.fileName || '未命名视频'}</div></div>`;
                                preview.dataset.isFileVideo = "true";
                            }
                        } else {
                            // 图片壁纸
                            if (wallpaperData.src) {
                                preview.innerHTML = `<img src="${wallpaperData.src}" alt="壁纸预览" style="width:100%;height:100%;object-fit:cover;">`;
                                preview.dataset.imageUrl = wallpaperData.src;
                                preview.dataset.isFileVideo = "false";
                            }
                        }
                        document.getElementById('setWallpaperBtn').disabled = false;
                    } catch (e) {
                        console.error('解析保存的壁纸数据时出错:', e);
                    }
                }
            }
        </script>
    </div>
</body>

</html>
