<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èü≥‰πê</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .phone {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Áä∂ÊÄÅÊ†èÊ†∑Âºè */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .status-left, .status-center, .status-right {
            display: flex;
            align-items: center;
        }

        .status-left {
            flex: 1;
        }

        .status-center {
            flex: 2;
            justify-content: center;
        }

        .status-right {
            flex: 1;
            justify-content: flex-end;
        }

        .status-icon {
            width: 18px;
            height: 18px;
            margin: 0 5px;
        }

        /* Â§¥ÈÉ®ÂØºËà™Ê†è */
        .header {
            display: flex;
            align-items: center;
            padding: 0 15px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            top: 44px;
            left: 0;
            right: 0;
            z-index: 999;
        }

        .back-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .header-content {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        /* Â§¥ÈÉ®Âè≥‰æßÊåâÈíÆ */
        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .playlist-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* ÂÜÖÂÆπÂå∫Âüü */
        .content {
            flex: 1;
            padding: 110px 15px 80px 15px;
            overflow-y: auto;
        }

        /* Ê≠åÊõ≤ÂàóË°® */
        .songs-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .song-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .song-item.active {
            background: rgba(0, 122, 255, 0.3);
            border-color: rgba(0, 122, 255, 0.5);
        }

        .song-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .song-cover {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-details {
            flex: 1;
        }

        .song-details .song-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-details .song-artist {
            font-size: 14px;
            color: #aaa;
        }

        /* Â∫ïÈÉ®Êí≠ÊîæÊ†è */
        .bottom-player {
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
        }

        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .player-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-artist {
            font-size: 14px;
            color: #aaa;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 18px;
        }

        .control-btn.play-pause {
            width: 55px;
            height: 55px;
            background: #007AFF;
        }

        /* Êí≠ÊîæÂô®È°µÈù¢ */
        .player-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #000);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .player-content {
            flex: 1;
            padding: 120px 15px 20px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ‰∏ìËæëÂ∞ÅÈù¢Âå∫Âüü */
        .album-art-container {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Ê≠åÊõ≤‰ø°ÊÅØ */
        .player-content .song-info {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .player-content .song-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .player-content .song-artist {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 2px;
            text-align: center;
        }

        .song-album {
            font-size: 14px;
            color: #888;
        }

        /* Ê≠åËØçÊòæÁ§∫Âå∫Âüü */
        .lyrics-container {
            width: 100%;
            max-width: 350px;
            height: 100px;
            margin: 5px auto;
            overflow: hidden;
            position: relative;
            text-align: center;
        }

        .lyrics-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .lyric-line {
            height: 24px;
            line-height: 24px;
            font-size: 14px;
            color: #aaa;
            transition: all 0.3s ease;
            padding: 2px 0;
        }

        .lyric-line.active {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .lyrics-placeholder {
            height: 24px;
            line-height: 24px;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            width: 100%;
            max-width: 350px;
            margin-bottom: 30px;
            margin-top: 20px;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-filled {
            height: 100%;
            background: #007AFF;
            width: 0%;
            border-radius: 5px;
            transition: width 0.1s linear;
        }

        /* ÊéßÂà∂ÊåâÈíÆ */
        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 20px;
        }

        .control-btn.play-pause {
            width: 55px;
            height: 55px;
            background: #007AFF;
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .control-btn.play-pause svg {
            width: 24px;
            height: 24px;
        }

        /* Êí≠ÊîæÂàóË°®Ê†∑Âºè */
        .playlist-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            z-index: 2001;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .playlist-drag-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 0 auto 15px auto;
        }

        .playlist-modal.open {
            transform: translateY(0);
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-title {
            font-size: 18px;
            font-weight: bold;
        }

        .playlist-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(0, 122, 255, 0.3);
        }

        .playlist-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .playlist-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: #aaa;
        }

        .playlist-item-duration {
            font-size: 12px;
            color: #aaa;
            min-width: 30px;
            text-align: right;
        }

        /* Âú®Â∞èÂ±èÂπï‰∏äË∞ÉÊï¥Êí≠ÊîæÂàóË°®Ê†∑Âºè */
        @media (max-width: 768px) {
            .playlist-modal {
                padding: 15px;
            }
            
            .playlist-item {
                gap: 10px;
                padding: 8px;
            }
            
            .playlist-item-cover {
                width: 35px;
                height: 35px;
            }
            
            .playlist-item-title {
                font-size: 13px;
            }
            
            .playlist-item-artist, .playlist-item-duration {
                font-size: 11px;
            }
            
            .playlist-item-duration {
                min-width: 30px;
                text-align: right;
            }
        }

        /* Ëá™ÂÆö‰πâÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* Êí≠ÊîæÂàóË°®ÈÅÆÁΩ©Â±Ç */
        #playlistOverlay {
            z-index: 2000;
        }

        /* Êí≠ÊîæÂàóË°®ÂºπÁ™ó */
        #playlistModal {
            z-index: 2001;
        }

        /* ‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™ó */
        .together-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            z-index: 2001;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .together-modal.open {
            transform: translateY(0);
        }

        .together-drag-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 0 auto 15px auto;
        }

        .together-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .together-title {
            font-size: 18px;
            font-weight: bold;
        }

        .together-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
        }

        .avatar-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .avatar-placeholder {
            font-size: 30px;
            line-height: 60px;
        }

        .heartbeat-area {
            width: 80px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .heart-icon {
            width: 50px;
            height: 50px;
            animation: heartbeat 1.2s ease-in-out infinite;
            position: relative;
            z-index: 3;
        }

        .heart-icon svg {
            width: 100%;
            height: 100%;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            5% { transform: scale(1.1); }
            10% { transform: scale(1); }
        }

        .menu-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Âà†Èô§Á°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
        #deleteConfirmModal .modal-content {
            max-width: 300px;
        }

        #deleteConfirmModal .form-group p {
            text-align: center;
            margin: 20px 0;
            color: #fff;
        }

        /* ÁºñËæëÊ≠åÊõ≤ÂºπÁ™óÊ†∑Âºè */
        #editSongModal .modal-content {
            max-width: 400px;
        }

        /* ÂàõÂª∫Áà±ÂøÉÂΩ¢Áä∂ÁöÑÂèëÂÖâÊïàÊûú */
        .heart-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z' fill='red'/%3E%3C/svg%3E") center/contain no-repeat;
            z-index: -1;
            animation: pulse 1.2s ease-in-out infinite;
            filter: blur(15px);
            opacity: 0.7;
        }

        /* ÂàõÂª∫ÂøÉÁîµÂõæËÑâÂÜ≤ÊäòÁ∫øÊïàÊûú */
        .ecg-line {
            position: absolute;
            width: 100%;
            height: 60px;
            top: 50%;
            transform: translateY(-50%);
            overflow: hidden;
        }

        /* ‰ΩøÁî®SVGÂàõÂª∫ÂøÉÁîµÂõæÊäòÁ∫ø */
        .ecg-line::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60'%3E%3Cpath d='M0,30 L20,30 L30,10 L40,50 L50,30 L70,30 L80,15 L90,45 L100,30 L120,30 L130,20 L140,40 L150,30 L170,30 L180,25 L190,35 L200,30' stroke='red' stroke-width='2' fill='none' stroke-dasharray='1000' stroke-dashoffset='1000'%3E%3Canimate attributeName='stroke-dashoffset' from='1000' to='0' dur='2s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
            background-repeat: repeat-x;
            animation: ecgMove 2s linear infinite;
            filter: drop-shadow(0 0 4px rgba(255, 0, 0, 0.7));
        }

        @keyframes ecgMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100px); }
        }

        /* ÂøÉË∑≥Âä®ÁîªÂ¢ûÂº∫ */
        @keyframes pulse {
            0% { 
                transform: scale(1);
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.8);
                opacity: 0.4;
            }
            100% { 
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .avatar-label {
            text-align: center;
            font-size: 14px;
            color: #aaa;
            margin-top: 10px;
        }

        .avatar-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .duration-stats {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .duration-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .duration-value {
            font-size: 18px;
            font-weight: bold;
        }

        .chat-section {
            margin-top: 20px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* ËÅäÂ§©ËæìÂÖ•Âå∫ÂüüÂÆπÂô® */
        .chat-input-container {
            display: flex;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 25px;
            padding: 6px 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
        }

        /* ËÅäÂ§©ËæìÂÖ•Ê°Ü */
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
            min-height: 20px;
        }

        .chat-input:focus {
            outline: none;
        }

        /* ËÅäÂ§©ÊåâÈíÆÈÄöÁî®Ê†∑Âºè */
        .chat-send-btn, .chat-ai-btn, .chat-settings-btn {
            padding: 8px 12px;
            border-radius: 18px;
            background: rgba(0, 122, 255, 0.3);
            border: 1px solid rgba(0, 122, 255, 0.5);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            min-width: 50px;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover, .chat-ai-btn:hover, .chat-settings-btn:hover {
            background: rgba(0, 122, 255, 0.5);
            transform: scale(1.05);
        }

        /* AIÂõûÂ§çÊåâÈíÆ */
        .chat-ai-btn {
            background: rgba(10, 132, 255, 0.3);
            border: 1px solid rgba(10, 132, 255, 0.5);
        }

        .chat-ai-btn:hover {
            background: rgba(10, 132, 255, 0.5);
        }

        /* ËÅäÂ§©ËÆæÁΩÆÊåâÈíÆ */
        .chat-settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 10px;
            margin-left: 5px;
        }

        .chat-settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ËÅäÂ§©ËÆæÁΩÆÊåâÈíÆÂÜÖÁöÑSVGÂõæÊ†á */
        .chat-settings-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            .chat-input-container {
                gap: 6px;
                padding: 5px 10px;
                border-radius: 22px;
            }
            
            .chat-input {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .chat-send-btn, .chat-ai-btn, .chat-settings-btn {
                padding: 6px 10px;
                border-radius: 16px;
                font-size: 12px;
                min-width: 45px;
            }
            
            .chat-settings-btn {
                padding: 6px 8px;
                margin-left: 4px;
            }
            
            .chat-settings-btn svg {
                width: 16px;
                height: 16px;
            }
        }

        /* Â∞èÂ±èÂπïËÆæÂ§áËøõ‰∏ÄÊ≠•‰ºòÂåñ */
        @media (max-width: 480px) {
            .chat-input-container {
                gap: 5px;
                padding: 4px 8px;
                border-radius: 20px;
            }
            
            .chat-input {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .chat-send-btn, .chat-ai-btn {
                padding: 5px 8px;
                border-radius: 15px;
                font-size: 11px;
                min-width: 40px;
            }
            
            .chat-settings-btn {
                padding: 5px 6px;
                border-radius: 15px;
                margin-left: 3px;
            }
            
            .chat-settings-btn svg {
                width: 14px;
                height: 14px;
            }
        }

        /* ËÅäÂ§©Ê∂àÊÅØÊ†∑Âºè */
        .message-container {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .message-container.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            position: relative;
        }

        /* Áî®Êà∑Ê∂àÊÅØÊ∞îÊ≥° */
        .message-container.sent .message-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* AIÊ∂àÊÅØÊ∞îÊ≥° */
        .message-container.received .message-bubble {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1));
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .message-sender {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 10px;
            color: #888;
        }

        .message-content {
            font-size: 14px;
        }

        /* ËßíËâ≤ÈÄâÊã©ÂºπÁ™ó */
        .character-modal {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .character-item {
            text-align: center;
            cursor: pointer;
        }

        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            overflow: hidden;
        }

        .character-name {
            font-size: 12px;
            color: #aaa;
        }

        /* Áî®Êà∑ËÆæÁΩÆÂºπÁ™ó */
        .user-modal {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .user-modal .form-group {
            margin-bottom: 20px;
        }

        .user-modal .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .user-modal .form-input, .user-modal .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .user-modal .form-input:focus, .user-modal .form-textarea:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .user-modal .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-modal .upload-area:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(0, 122, 255, 0.05);
        }

        .user-modal .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .user-modal .upload-text {
            font-size: 14px;
            color: #aaa;
        }

        .user-modal .hidden-file-input {
            display: none;
        }

        .user-modal .submit-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(45deg, #007AFF, #0A84FF);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-modal .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }



        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(0, 122, 255, 0.3);
        }

        .playlist-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .playlist-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: #aaa;
        }

        .playlist-item-duration {
            font-size: 12px;
            color: #aaa;
            min-width: 30px;
            text-align: right;
        }

        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(0, 122, 255, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: #aaa;
        }

        .hidden-file-input {
            display: none;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(45deg, #007AFF, #0A84FF);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }

        /* Êí≠ÊîæÊåâÈíÆSVG */
        .play-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .pause-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .prev-icon, .next-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- ÈöêËóèÁöÑÈü≥È¢ëÊí≠ÊîæÂô® -->
        <audio id="audioPlayer" style="display: none;"></audio>
        
        <!-- Áä∂ÊÄÅÊ†è -->
        <div class="status-bar">
            <div class="status-left">
                <span class="time" id="current-time">00:00</span>
            </div>
            <div class="status-center">
                <!-- ‰∏≠Èó¥ÁïôÁ©∫ -->
            </div>
            <div class="status-right">
                <!-- ‰ø°Âè∑ÂõæÊ†á -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 17L5 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 17L12 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19 17L19 2" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <!-- ÁîµÊ±†ÂõæÊ†á -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="7" width="16" height="10" rx="3" stroke="white" stroke-width="2"/>
                    <path d="M20 10V14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <rect x="4" y="9" width="12" height="6" rx="2" fill="white"/>
                </svg>
            </div>
        </div>

        <!-- Â§¥ÈÉ®ÂØºËà™Ê†è -->
        <div class="header">
            <div class="back-btn" onclick="goBack()">
                <svg viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-7.03L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </div>
            <div class="header-content">
                Èü≥‰πê
            </div>
            <div class="header-actions" style="margin-left: auto; display: flex; gap: 15px;">
                <!-- Âä†Âè∑ÊåâÈíÆ -->
                <div class="header-btn" onclick="openAddSongModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="white"/>
                    </svg>
                </div>
                <!-- ÊòüÊòüÊåâÈíÆ -->
                <div class="header-btn" onclick="openMusicBackgroundModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="white"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- ÂÜÖÂÆπÂå∫Âüü -->
        <div class="content">
            <div class="songs-list" id="songsList">
                <!-- Ê≠åÊõ≤ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <!-- Â∫ïÈÉ®Êí≠ÊîæÊ†è -->
        <div class="bottom-player" id="bottomPlayer" onclick="openPlayer(event)">
            <div class="player-cover">
                <img id="playerCover" src="" alt="‰∏ìËæëÂ∞ÅÈù¢">
            </div>
            <div class="player-info">
                <div class="player-title" id="playerTitle">ÊöÇÊó†Êí≠Êîæ</div>
                <div class="player-artist" id="playerArtist"></div>
            </div>
            <div class="player-controls">
                <button class="control-btn" onclick="prevSong(event)">
                    <svg class="prev-icon" viewBox="0 0 24 24">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                    </svg>
                </button>
                <button class="control-btn play-pause" onclick="togglePlay(event)">
                    <svg class="play-icon" viewBox="0 0 24 24" id="playIcon">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" id="pauseIcon" style="display: none;">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V6h-4z"/>
                    </svg>
                </button>
                <button class="control-btn" onclick="nextSong(event)">
                    <svg class="next-icon" viewBox="0 0 24 24">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Êí≠ÊîæÂô®È°µÈù¢ -->
        <div class="player-page" id="playerPage" style="display: none;">
            <!-- Â§¥ÈÉ®ÂØºËà™Ê†è -->
            <div class="header">
                <div class="back-btn" onclick="closePlayer()">
                    <svg viewBox="0 0 24 24">
                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="white"/>
                    </svg>
                </div>
                <div class="header-content" id="playerHeaderTitle">
                    Êí≠ÊîæÂô®
                </div>
                <div class="header-actions" style="margin-left: auto; display: flex; gap: 15px;">
                    <!-- Áà±ÂøÉÊåâÈíÆ -->
                    <div class="header-btn" onclick="toggleFavorite()">
                        <svg viewBox="0 0 24 24" id="favoriteIcon" width="18" height="18">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="white"/>
                        </svg>
                    </div>
                    <!-- ÊòüÊòüÊåâÈíÆ -->
                    <div class="header-btn" onclick="openPlayerBackgroundModal()">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="white"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Êí≠ÊîæÂô®ÂÜÖÂÆπÂå∫Âüü -->
            <div class="player-content">
                <!-- ‰∏ìËæëÂ∞ÅÈù¢ -->
                <div class="album-art-container">
                    <div class="album-art" id="playerAlbumArt">
                        <div style="font-size: 80px;">üéµ</div>
                    </div>
                </div>

                <!-- Ê≠åÊõ≤‰ø°ÊÅØ -->
                <div class="song-info">
                    <div class="song-title" id="playerSongTitle">ÊöÇÊó†Êí≠Êîæ</div>
                    <div class="song-artist" id="playerSongArtist"></div>
                    <div class="song-album" id="playerSongAlbum"></div>
                </div>

                <!-- Ê≠åËØçÊòæÁ§∫Âå∫Âüü -->
                <div class="lyrics-container" onclick="openLyricsModal()">
                    <div class="lyrics-content" id="lyricsContent">
                        <div class="lyrics-placeholder">ÁÇπÂáªÊ∑ªÂä†Ê≠åËØç</div>
                    </div>
                </div>

                <!-- ËøõÂ∫¶Êù° -->
                <div class="progress-container">
                    <div class="progress-time">
                        <span id="playerCurrentTime">00:00</span>
                        <span id="playerDuration">00:00</span>
                    </div>
                    <div class="progress-bar" id="playerProgressBar" onclick="playerSeek(event)">
                        <div class="progress-filled" id="playerProgressFilled"></div>
                    </div>
                </div>

                <!-- ÊéßÂà∂ÊåâÈíÆ -->
                <div class="control-buttons">
                    <button class="control-btn" onclick="toggleRepeatMode()">
                        <svg viewBox="0 0 24 24" id="repeatIcon">
                            <path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 12h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z" fill="white"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="prevSong()">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                        </svg>
                    </button>
                    <button class="control-btn play-pause" onclick="togglePlay()" style="width: 55px; height: 55px;">
                        <svg viewBox="0 0 24 24" id="playerPlayIcon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg viewBox="0 0 24 24" id="playerPauseIcon" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V6h-4z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="nextSong()">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="togglePlaylist()">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" fill="white"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê∑ªÂä†Ê≠åÊõ≤ÂºπÁ™ó -->
        <div class="modal" id="addSongModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Ê∑ªÂä†Ê≠åÊõ≤</div>
                    <button class="modal-close" onclick="closeAddSongModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊõ≤ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="songTitle" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊâã</label>
                    <input type="text" class="form-input" id="songArtist" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊâãÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊõ≤URL</label>
                    <input type="text" class="form-input" id="songUrl" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊõ≤URL">
                </div>
                <div class="form-group">
                    <label class="form-label">‰∏ìËæëÂ∞ÅÈù¢</label>
                    <div class="upload-area" onclick="document.getElementById('coverUpload').click()">
                        <div class="upload-icon">üéµ</div>
                        <div class="upload-text" id="coverUploadText">ÁÇπÂáªÈÄâÊã©Â∞ÅÈù¢ÂõæÁâá</div>
                    </div>
                    <input type="file" id="coverUpload" class="hidden-file-input" accept="image/*" onchange="handleCoverUpload(event)">
                </div>
                <button class="submit-btn" onclick="addSong()">Ê∑ªÂä†Ê≠åÊõ≤</button>
            </div>
        </div>

        <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
        <div class="modal" id="deleteConfirmModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Á°ÆËÆ§Âà†Èô§</div>
                    <button class="modal-close" onclick="closeDeleteConfirmModal()">&times;</button>
                </div>
                <div class="form-group">
                    <p>Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈ¶ñÊ≠åÊõ≤ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ</p>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button class="submit-btn" onclick="confirmDeleteSong()" style="flex: 1; background: #ff3b30;">Á°ÆÂÆöÂà†Èô§</button>
                    <button class="submit-btn" onclick="closeDeleteConfirmModal()" style="flex: 1; background: #007AFF;">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>

        <!-- ÁºñËæëÊ≠åÊõ≤ÂºπÁ™ó -->
        <div class="modal" id="editSongModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ÁºñËæëÊ≠åÊõ≤</div>
                    <button class="modal-close" onclick="closeEditSongModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊõ≤ÂêçÁß∞</label>
                    <input type="text" class="form-input" id="editSongTitle" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊâã</label>
                    <input type="text" class="form-input" id="editSongArtist" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊâãÂêçÁß∞">
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åÊõ≤URL</label>
                    <input type="text" class="form-input" id="editSongUrl" placeholder="ËØ∑ËæìÂÖ•Ê≠åÊõ≤URL">
                </div>
                <div class="form-group">
                    <label class="form-label">‰∏ìËæëÂ∞ÅÈù¢</label>
                    <div class="upload-area" onclick="document.getElementById('editCoverUpload').click()">
                        <div class="upload-icon">üéµ</div>
                        <div class="upload-text" id="editCoverUploadText">ÁÇπÂáªÈÄâÊã©Â∞ÅÈù¢ÂõæÁâá</div>
                    </div>
                    <input type="file" id="editCoverUpload" class="hidden-file-input" accept="image/*" onchange="handleEditCoverUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveEditSong()">‰øùÂ≠òÊõ¥Êîπ</button>
            </div>
        </div>

        <!-- Èü≥‰πêÈ°µÈù¢ËÉåÊôØËÆæÁΩÆÂºπÁ™ó -->
        <div class="modal" id="musicBackgroundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ËÆæÁΩÆÈü≥‰πêÈ°µÈù¢ËÉåÊôØ</div>
                    <button class="modal-close" onclick="closeMusicBackgroundModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂõæÁâá</label>
                    <div class="upload-area" onclick="document.getElementById('musicBackgroundUpload').click()">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text" id="musicBackgroundUploadText">ÁÇπÂáªÈÄâÊã©Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂõæÁâá</div>
                    </div>
                    <input type="file" id="musicBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handleMusicBackgroundUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveMusicBackground()">‰øùÂ≠òËÉåÊôØ</button>
            </div>
        </div>
        
        <!-- ËÉåÊôØËÆæÁΩÆÂºπÁ™óÔºàÊí≠ÊîæÂô®È°µÈù¢‰∏ìÁî®Ôºâ -->
        <div class="modal" id="backgroundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ËÆæÁΩÆÊí≠ÊîæÂô®ËÉåÊôØ</div>
                    <button class="modal-close" onclick="closeBackgroundModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Êí≠ÊîæÂô®ËÉåÊôØÂõæÁâá</label>
                    <div class="upload-area" onclick="document.getElementById('playerBackgroundUpload').click()">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text" id="playerBackgroundUploadText">ÁÇπÂáªÈÄâÊã©Êí≠ÊîæÂô®ËÉåÊôØÂõæÁâá</div>
                    </div>
                    <input type="file" id="playerBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handlePlayerBackgroundUpload(event)">
                </div>
                <div class="form-group">
                    <label class="form-label">‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØÂõæÁâá</label>
                    <div class="upload-area" onclick="document.getElementById('togetherBackgroundUpload').click()">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text" id="togetherBackgroundUploadText">ÁÇπÂáªÈÄâÊã©‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØÂõæÁâá</div>
                    </div>
                    <input type="file" id="togetherBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handleTogetherBackgroundUpload(event)">
                </div>
                <button class="submit-btn" onclick="savePlayerBackground()">‰øùÂ≠òËÉåÊôØ</button>
            </div>
        </div>

        <!-- Êí≠ÊîæÂàóË°®ÈÅÆÁΩ©Â±Ç -->
        <div class="modal" id="playlistOverlay" onclick="togglePlaylist()"></div>
        <!-- Êí≠ÊîæÂàóË°®ÂºπÁ™ó -->
        <div class="playlist-modal" id="playlistModal">
            <div class="playlist-drag-handle"></div>
            <div class="playlist-header">
                <div class="playlist-title">Êí≠ÊîæÂàóË°®</div>
                <button class="playlist-close" onclick="togglePlaylist()">&times;</button>
            </div>
            <div class="playlist-list" id="playlistList">
                <!-- Êí≠ÊîæÂàóË°®È°πÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>

        <!-- ‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™ó -->
        <div class="modal" id="togetherModal">
            <div class="together-modal">
                <div class="together-drag-handle"></div>
                <div class="together-header">
                    <div class="together-title">‰∏ÄËµ∑Âê¨Ê≠å</div>
                    <button class="together-close" onclick="toggleTogether()">&times;</button>
                </div>
                <div class="together-content">
                    <!-- Â§¥ÂÉèÂå∫Âüü -->
                    <div class="avatar-section">
                        <div class="avatar-container">
                            <!-- Â§¥ÂÉè1 -->
                            <div class="avatar-item">
                                <div class="avatar avatar-left" onclick="openCharacterModal()">
                                    <div class="avatar-img" id="characterAvatar">
                                        <div class="avatar-placeholder">üë§</div>
                                    </div>
                                </div>
                                <div class="avatar-label" id="characterName">ÈÄâÊã©ËßíËâ≤</div>
                            </div>
                            
                            <!-- ÂøÉË∑≥Âä®ÁîªÂå∫Âüü -->
                            <div class="heartbeat-area">
                                <div class="heart-icon">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" stroke="red" stroke-width="2" fill="red"/>
                                    </svg>
                                </div>
                                <div class="ecg-line"></div>
                            </div>
                            
                            <!-- Â§¥ÂÉè2 -->
                            <div class="avatar-item">
                                <div class="avatar avatar-right" onclick="openUserModal()">
                                    <div class="avatar-img" id="userAvatar">
                                        <div class="avatar-placeholder">üë§</div>
                                    </div>
                                </div>
                                <div class="avatar-label" id="userName">Áî®Êà∑ËÆæÁΩÆ</div>
                            </div>
                        </div>
                        <!-- Êó∂ÈïøÁªüËÆ° -->
                        <div class="duration-stats">
                            <div class="duration-label">‰∏ÄËµ∑Âê¨Ê≠åÊó∂Èïø</div>
                            <div class="duration-value" id="togetherDuration">00:00:00</div>
                        </div>
                    </div>
                    <!-- ËÅäÂ§©Èù¢Êùø -->
                    <div class="chat-section">
                        <div class="chat-messages" id="chatMessages">
                            <!-- ËÅäÂ§©Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ...">
                            <button class="chat-send-btn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                            <button class="chat-ai-btn" onclick="sendAiMessage()">AIÂõûÂ§ç</button>
                            <button class="chat-settings-btn" onclick="openChatSettings()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04.32.07.64.07.97 0 .33-.03.66-.07.97l2.11 1.63c.19.15.24.42.12.64l-2 3.46c-.12.22-.39.31-.61.22l-2.49-1c-.52.36-1.05.68-1.68.93l-.38 2.65c-.03.24-.24.42-.49.42h-4c-.25 0-.46-.18-.49-.42l-.38-2.65c-.63-.25-1.16-.57-1.68-.93l-2.49 1c-.22.09-.49 0-.61-.22l-2-3.46c-.13-.22-.07-.49.12-.64L4.57 14.5c-.04-.32-.07-.65-.07-.97 0-.33.03-.65.07-.97L2.46 10.93c-.19-.15-.24-.42-.12-.64l2-3.46c.12-.22.39-.31.61-.22l2.49 1c.52-.36 1.05-.68 1.68-.93l.38-2.65C9.46 2.18 9.67 2 9.92 2h4c.25 0 .46.18.49.42l.38 2.65c.63.25 1.16.57 1.68.93l2.49-1c.22-.09.49 0 .61.22l2 3.46c.12.22.07.49-.12.64l-2.11 1.66z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËßíËâ≤ÈÄâÊã©ÂºπÁ™ó -->
        <div class="modal" id="characterModal">
            <div class="character-modal">
                <div class="modal-header">
                    <div class="modal-title">ÈÄâÊã©ËßíËâ≤</div>
                    <button class="modal-close" onclick="closeCharacterModal()">&times;</button>
                </div>
                <div class="character-list" id="characterList">
                    <!-- ËßíËâ≤ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>

        <!-- Ê≠åËØç‰∏ä‰º†ÂºπÁ™ó -->
        <div class="modal" id="lyricsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‰∏ä‰º†Ê≠åËØç</div>
                    <button class="modal-close" onclick="closeLyricsModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê≠åËØçÂÜÖÂÆπ</label>
                    <textarea class="form-textarea" id="lyricsContentInput" placeholder="ËØ∑ËæìÂÖ•Ê≠åËØçÂÜÖÂÆπÔºåÊØèË°å‰∏ÄÂè•" rows="10"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Êó∂Èó¥ËΩ¥ÔºàÂèØÈÄâÔºâ</label>
                    <textarea class="form-textarea" id="lyricsTimeInput" placeholder="ËØ∑ËæìÂÖ•Êó∂Èó¥ËΩ¥ÔºåÊ†ºÂºèÔºö[00:00.00]Ê≠åËØçÂÜÖÂÆπ" rows="5"></textarea>
                </div>
                <button class="submit-btn" onclick="saveLyrics()">‰øùÂ≠òÊ≠åËØç</button>
            </div>
        </div>

        <!-- Áî®Êà∑ËÆæÁΩÆÂºπÁ™ó -->
        <div class="modal" id="userModal">
            <div class="user-modal">
                <div class="modal-header">
                    <div class="modal-title">Áî®Êà∑ËÆæÁΩÆ</div>
                    <button class="modal-close" onclick="closeUserModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">ÂßìÂêç</label>
                    <input type="text" class="form-input" id="userRealName" placeholder="ËØ∑ËæìÂÖ•ÂßìÂêç">
                </div>
                <div class="form-group">
                    <label class="form-label">‰∫∫ËÆæ</label>
                    <textarea class="form-textarea" id="userPersona" placeholder="ËØ∑ËæìÂÖ•‰∫∫ËÆæÊèèËø∞" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Â§¥ÂÉè</label>
                    <div class="upload-area" onclick="document.getElementById('userAvatarUpload').click()">
                        <div class="upload-icon" id="userAvatarPreview">üë§</div>
                        <div class="upload-text">ÁÇπÂáªÈÄâÊã©Â§¥ÂÉè</div>
                    </div>
                    <input type="file" id="userAvatarUpload" class="hidden-file-input" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveUserSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
            </div>
        </div>

        <!-- ËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó -->
        <div class="modal" id="chatSettingsModal">
            <div class="user-modal">
                <div class="modal-header">
                    <div class="modal-title">ËÅäÂ§©ËÆæÁΩÆ</div>
                    <button class="modal-close" onclick="closeChatSettingsModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê∂àÊÅØÊòæÁ§∫ËÆæÁΩÆ</label>
                    <div style="display: flex; align-items: center; margin: 10px 0;">
                        <input type="checkbox" id="autoHideMessages" style="width: 20px; height: 20px; margin-right: 10px;" checked>
                        <label for="autoHideMessages" class="form-label" style="margin: 0;">AIÂõûÂ§çÊ∂àÊÅØ3ÁßíÂêéËá™Âä®Ê∂àÂ§±</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ËÅäÂ§©ËÆ∞ÂΩï</label>
                    <button class="submit-btn" onclick="clearChatHistory()" style="background: #ff3b30; margin-top: 10px;">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                </div>
                <button class="submit-btn" onclick="saveChatSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
            </div>
        </div>
        <script>
            // Êõ¥Êñ∞Êó∂Èó¥
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('current-time').textContent = timeString;
            }

            // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥
            setInterval(updateTime, 1000);
            updateTime(); // ÂàùÂßãÂåñÊó∂Èó¥

            // ËøîÂõû‰∏ä‰∏ÄÈ°µ
            function goBack() {
                window.location.href = 'index.html';
            }

            // ÂÖ®Â±ÄÂèòÈáè
            let songs = [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let tempCover = null;
            let tempMusicBackground = null;  // Èü≥‰πêÈ°µÈù¢ËÉåÊôØ
            let tempPlayerBackground = null;  // Êí≠ÊîæÂô®È°µÈù¢ËÉåÊôØ
            let tempTogetherBackground = null;  // ‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØ
            let currentLyrics = [];
            let lyricsMap = {};
            let audioPlayer = null;
            let isFavorite = false;
            let isShuffle = false;  // ÈöèÊú∫Êí≠ÊîæÊ®°Âºè
            let isRepeat = false;   // ÂçïÊõ≤Âæ™ÁéØÊ®°Âºè
            let shuffleOrder = [];
            let togetherStartTime = null;
            let togetherTimer = null;
            let togetherDuration = 0; // ÂΩìÂâç‰ºöËØùÊó∂Èïø
            let totalTogetherDuration = 0; // ÊÄªÊó∂Èïø
            let characterList = [
                { id: 1, name: 'Â∞èÊòé', avatar: 'üë§' },
                { id: 2, name: 'Â∞èÁ∫¢', avatar: 'üë§' },
                { id: 3, name: 'Â∞èÊùé', avatar: 'üë§' },
                { id: 4, name: 'Â∞èÁéã', avatar: 'üë§' },
                { id: 5, name: 'Â∞èÂº†', avatar: 'üë§' },
                { id: 6, name: 'Â∞èËµµ', avatar: 'üë§' }
            ];
            let selectedCharacter = null;
            let userSettings = {
                name: '',
                persona: '',
                avatar: 'üë§'
            };

            // È°µÈù¢Âä†ËΩΩÊó∂Â∫îÁî®ËÉåÊôØÂíåÊ≠åÊõ≤Êï∞ÊçÆ
            window.addEventListener('DOMContentLoaded', function() {
                console.log('DOMÂÜÖÂÆπÂä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂä†ËΩΩÊï∞ÊçÆ...');
                // ÂàùÂßãÂåñÈü≥È¢ëÊí≠ÊîæÂô®
                audioPlayer = document.getElementById('audioPlayer');
                
                // Âä†ËΩΩËÉåÊôØ
                loadBackground();
                
                // Âä†ËΩΩÊ≠åÊõ≤
                loadSongs();
                
                // Âä†ËΩΩ‰∏ÄËµ∑Âê¨Ê≠åÊó∂Èïø
                loadTogetherDuration();
                
                // Âä†ËΩΩÈÄâ‰∏≠ÁöÑËßíËâ≤
                loadSelectedCharacter();
                
                // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
                loadUserSettings();
                
                // Âä†ËΩΩÊí≠ÊîæÁä∂ÊÄÅ
                loadPlaybackState();
                
                // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
                loadChatMessages();
                
                // Ê∑ªÂä†Èü≥È¢ëÊí≠ÊîæÂô®‰∫ã‰ª∂ÁõëÂê¨Âô®
                audioPlayer.addEventListener('ended', function() {
                    console.log('Ê≠åÊõ≤Êí≠ÊîæÂÆåÊàê');
                    // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÊí≠Êîæ‰∏ã‰∏ÄÈ¶ñ
                    if (isRepeat) {
                        // ÂçïÊõ≤Âæ™ÁéØ
                        playSong(currentSongIndex);
                    } else {
                        // ÊôÆÈÄöÊí≠ÊîæÊàñÈöèÊú∫Êí≠Êîæ
                        nextSong();
                    }
                });
                
                audioPlayer.addEventListener('error', function(e) {
                    console.error('Èü≥È¢ëÊí≠ÊîæÂá∫Èîô:', e);
                    alert('Èü≥È¢ëÊí≠ÊîæÂá∫ÈîôÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶ÊúâÊïà');
                });
                
                audioPlayer.addEventListener('playing', function() {
                    console.log('Èü≥È¢ëÂºÄÂßãÊí≠Êîæ');
                });
                
                // Ê∑ªÂä†Êí≠ÊîæËøõÂ∫¶Êõ¥Êñ∞‰∫ã‰ª∂
                audioPlayer.addEventListener('timeupdate', function() {
                    updatePlayerProgress();
                    // ÂÆûÊó∂‰øùÂ≠òÊí≠ÊîæËøõÂ∫¶
                    savePlaybackState();
                });
                
                audioPlayer.addEventListener('loadedmetadata', function() {
                    updatePlayerDuration();
                });
                
                // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
                document.getElementById('chatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            });

            // ÊâìÂºÄÊí≠ÊîæÂô®È°µÈù¢
            function openPlayer(event) {
                console.log('Â∫ïÈÉ®Êí≠ÊîæÊ†èË¢´ÁÇπÂáª');
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Â≠êÂÖÉÁ¥†
                if (event && event.target.closest('.player-controls')) {
                    console.log('ÁÇπÂáªÁöÑÊòØÊéßÂà∂ÊåâÈíÆÔºå‰∏çÊâìÂºÄÊí≠ÊîæÂô®');
                    return;
                }
                
                console.log('ÊâìÂºÄÊí≠ÊîæÂô®È°µÈù¢');
                // ÊòæÁ§∫Êí≠ÊîæÂô®È°µÈù¢
                document.getElementById('playerPage').style.display = 'block';
                document.getElementById('bottomPlayer').style.display = 'none';
                
                // Êõ¥Êñ∞Êí≠ÊîæÂô®UI
                updatePlayerUI();
            }



            // ÂàáÊç¢Êí≠ÊîæÊ®°ÂºèÔºàÈ°∫Â∫èÊí≠Êîæ/ÂçïÊõ≤Âæ™ÁéØ/ÈöèÊú∫Êí≠ÊîæÔºâ
            function toggleRepeatMode() {
                // Âæ™ÁéØÂàáÊç¢Ê®°ÂºèÔºö0-È°∫Â∫èÊí≠Êîæ, 1-ÂçïÊõ≤Âæ™ÁéØ, 2-ÈöèÊú∫Êí≠Êîæ
                if (!isShuffle && !isRepeat) {
                    // ÂΩìÂâçÊòØÈ°∫Â∫èÊí≠ÊîæÔºåÂàáÊç¢Âà∞ÂçïÊõ≤Âæ™ÁéØ
                    isRepeat = true;
                    isShuffle = false;
                    // ÂçïÊõ≤Âæ™ÁéØÂõæÊ†á
                    document.getElementById('repeatIcon').innerHTML = '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" fill="white"/>';
                } else if (isRepeat && !isShuffle) {
                    // ÂΩìÂâçÊòØÂçïÊõ≤Âæ™ÁéØÔºåÂàáÊç¢Âà∞ÈöèÊú∫Êí≠Êîæ
                    isRepeat = false;
                    isShuffle = true;
                    // ÂàõÂª∫ÈöèÊú∫Êí≠ÊîæÈ°∫Â∫è
                    shuffleOrder = [];
                    for (let i = 0; i < songs.length; i++) {
                        shuffleOrder.push(i);
                    }
                    // Ê¥óÁâåÁÆóÊ≥ï
                    for (let i = shuffleOrder.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffleOrder[i], shuffleOrder[j]] = [shuffleOrder[j], shuffleOrder[i]];
                    }
                    // ÈöèÊú∫Êí≠ÊîæÂõæÊ†á
                    document.getElementById('repeatIcon').innerHTML = '<path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" fill="white"/>';
                } else {
                    // ÂΩìÂâçÊòØÈöèÊú∫Êí≠ÊîæÔºåÂàáÊç¢Âà∞È°∫Â∫èÊí≠Êîæ
                    isRepeat = false;
                    isShuffle = false;
                    // È°∫Â∫èÊí≠ÊîæÂõæÊ†áÔºà‰∏â‰∏™ÂêëÂè≥ÁöÑÁÆ≠Â§¥Ôºâ
                    document.getElementById('repeatIcon').innerHTML = '<path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 12h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z" fill="white"/>';
                }
                
                console.log('Êí≠ÊîæÊ®°ÂºèÂ∑≤ÂàáÊç¢');
            }

            // ÂÖ≥Èó≠Êí≠ÊîæÂô®È°µÈù¢
            function closePlayer() {
                document.getElementById('playerPage').style.display = 'none';
                document.getElementById('bottomPlayer').style.display = 'flex';
                
                // ÈáçÁΩÆÊí≠ÊîæÂô®Â§¥ÈÉ®Ê†áÈ¢ò
                document.getElementById('playerHeaderTitle').textContent = 'Êí≠ÊîæÂô®';
                
                // ÂÖ≥Èó≠Êí≠ÊîæÂàóË°®
                document.getElementById('playlistModal').classList.remove('open');
            }

            // ÂàáÊç¢Êí≠ÊîæÂàóË°®ÊòæÁ§∫
            function togglePlaylist() {
                const playlistModal = document.getElementById('playlistModal');
                const playlistOverlay = document.getElementById('playlistOverlay');
                playlistModal.classList.toggle('open');
                
                // ÊéßÂà∂ÈÅÆÁΩ©Â±ÇÊòæÁ§∫
                if (playlistModal.classList.contains('open')) {
                    playlistOverlay.style.display = 'block';
                    // Ê∏≤ÊüìÊí≠ÊîæÂàóË°®
                    renderPlaylist();
                } else {
                    playlistOverlay.style.display = 'none';
                }
            }

            // Ê∏≤ÊüìÊí≠ÊîæÂàóË°®
            function renderPlaylist() {
                const playlistList = document.getElementById('playlistList');
                playlistList.innerHTML = '';
                
                songs.forEach((song, index) => {
                    const playlistItem = document.createElement('div');
                    playlistItem.className = 'playlist-item';
                    if (index === currentSongIndex) {
                        playlistItem.classList.add('active');
                    }
                    
                    // ÂàõÂª∫Êí≠ÊîæÂàóË°®È°π
                    playlistItem.innerHTML = `
                        <div class="playlist-item-cover">
                            ${song.cover ? `<img src="${song.cover}" alt="${song.title}">` : 'üéµ'}
                        </div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-artist">${song.artist}</div>
                        </div>
                        <div class="playlist-item-duration">0:00</div>
                    `;
                    
                    playlistItem.onclick = () => {
                        playSong(index);
                        togglePlaylist(); // Êí≠ÊîæÂêéÂÖ≥Èó≠Êí≠ÊîæÂàóË°®
                    };
                    
                    playlistList.appendChild(playlistItem);
                    
                    // ÂºÇÊ≠•Ëé∑ÂèñÈü≥È¢ëÊó∂ÈïøÂπ∂Êõ¥Êñ∞ÊòæÁ§∫
                    getAudioDuration(song.url)
                        .then(duration => {
                            const formattedDuration = formatTime(duration);
                            playlistItem.querySelector('.playlist-item-duration').textContent = formattedDuration;
                        })
                        .catch(error => {
                            console.error('Ëé∑ÂèñÈü≥È¢ëÊó∂ÈïøÂ§±Ë¥•:', error);
                            playlistItem.querySelector('.playlist-item-duration').textContent = 'Êú™Áü•';
                        });
                });
            }

            // Êõ¥Êñ∞Êí≠ÊîæÂô®UI
            function updatePlayerUI() {
                if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    const song = songs[currentSongIndex];
                    // Êõ¥Êñ∞Â∫ïÈÉ®Êí≠ÊîæÊ†è
                    document.getElementById('playerTitle').textContent = song.title;
                    document.getElementById('playerArtist').textContent = song.artist;
                    document.getElementById('playerCover').src = song.cover || '';
                    
                    // Êõ¥Êñ∞Êí≠ÊîæÂô®È°µÈù¢
                    document.getElementById('playerSongTitle').textContent = song.title;
                    document.getElementById('playerSongArtist').textContent = song.artist;
                    document.getElementById('playerSongAlbum').textContent = song.album || '';
                    
                    // Êõ¥Êñ∞Êí≠ÊîæÂô®Â§¥ÈÉ®Ê†áÈ¢òÔºàÊòæÁ§∫Ê≠åÊõ≤ÂêçÂíåÊ≠åÊâãÔºâ
                    const headerTitle = `${song.title} - ${song.artist}`;
                    document.getElementById('playerHeaderTitle').textContent = headerTitle;
                    
                    // Êõ¥Êñ∞‰∏ìËæëÂ∞ÅÈù¢
                    const albumArt = document.getElementById('playerAlbumArt');
                    if (song.cover) {
                        albumArt.innerHTML = `<img src="${song.cover}" style="width:100%;height:100%;object-fit:cover;">`;
                    } else {
                        albumArt.innerHTML = 'üéµ';
                    }
                    
                    // Êõ¥Êñ∞Ê≠åËØçÊòæÁ§∫
                    renderLyrics(song.lyrics || '');
                    
                    // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÁä∂ÊÄÅ
                    if (isPlaying) {
                        document.getElementById('playIcon').style.display = 'none';
                        document.getElementById('pauseIcon').style.display = 'block';
                        document.getElementById('playerPlayIcon').style.display = 'none';
                        document.getElementById('playerPauseIcon').style.display = 'block';
                    } else {
                        document.getElementById('playIcon').style.display = 'block';
                        document.getElementById('pauseIcon').style.display = 'none';
                        document.getElementById('playerPlayIcon').style.display = 'block';
                        document.getElementById('playerPauseIcon').style.display = 'none';
                    }
                } else {
                    // Ê≤°ÊúâÊ≠åÊõ≤Êó∂ÁöÑÈªòËÆ§Áä∂ÊÄÅ
                    document.getElementById('playerTitle').textContent = 'ÊöÇÊó†Êí≠Êîæ';
                    document.getElementById('playerArtist').textContent = '';
                    document.getElementById('playerCover').src = '';
                    document.getElementById('playerSongTitle').textContent = 'ÊöÇÊó†Êí≠Êîæ';
                    document.getElementById('playerSongArtist').textContent = '';
                    document.getElementById('playerSongAlbum').textContent = '';
                    document.getElementById('playerHeaderTitle').textContent = 'Êí≠ÊîæÂô®';
                    document.getElementById('playerAlbumArt').innerHTML = 'üéµ';
                    document.getElementById('playIcon').style.display = 'block';
                    document.getElementById('pauseIcon').style.display = 'none';
                    document.getElementById('playerPlayIcon').style.display = 'block';
                    document.getElementById('playerPauseIcon').style.display = 'none';
                    
                    // Ê∏ÖÁ©∫Ê≠åËØçÊòæÁ§∫
                    renderLyrics('');
                }
            }

            // Êõ¥Êñ∞Êí≠ÊîæÂô®ËøõÂ∫¶Êù°
            function updatePlayerProgress() {
                if (!audioPlayer) return;
                
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration || 0;
                
                // Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
                document.getElementById('playerCurrentTime').textContent = formatTime(currentTime);
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                if (duration > 0) {
                    const percent = (currentTime / duration) * 100;
                    document.getElementById('playerProgressFilled').style.width = percent + '%';
                }
                
                // Êõ¥Êñ∞Ê≠åËØçÈ´ò‰∫Æ
                if (currentLyrics.length > 0) {
                    updateLyricsHighlight(currentTime);
                }
            }

            // Êõ¥Êñ∞Êí≠ÊîæÂô®ÊÄªÊó∂Èïø
            function updatePlayerDuration() {
                if (!audioPlayer) return;
                
                const duration = audioPlayer.duration || 0;
                document.getElementById('playerDuration').textContent = formatTime(duration);
            }

            // Ê†ºÂºèÂåñÊó∂Èó¥
            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }

            // Ëé∑ÂèñÈü≥È¢ëÊó∂Èïø
            function getAudioDuration(url) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.addEventListener('loadedmetadata', () => {
                        resolve(audio.duration);
                    });
                    audio.addEventListener('error', () => {
                        reject(new Error('Êó†Ê≥ïÂä†ËΩΩÈü≥È¢ë'));
                    });
                    audio.src = url;
                });
            }

            // Êí≠ÊîæÂô®Ë∑≥ËΩ¨Âà∞ÊåáÂÆö‰ΩçÁΩÆ
            function playerSeek(event) {
                if (!audioPlayer || !audioPlayer.duration) return;
                
                const progressBar = document.getElementById('playerProgressBar');
                const rect = progressBar.getBoundingClientRect();
                const pos = (event.clientX - rect.left) / rect.width;
                const time = pos * audioPlayer.duration;
                
                audioPlayer.currentTime = time;
            }

            // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
            function toggleFavorite() {
                isFavorite = !isFavorite;
                const favoriteIcon = document.getElementById('favoriteIcon');
                
                if (isFavorite) {
                    // Â°´ÂÖÖÁà±ÂøÉ
                    favoriteIcon.innerHTML = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="red"/>';
                    // ÊòæÁ§∫‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™ó
                    toggleTogether();
                } else {
                    // Á©∫ÂøÉÁà±ÂøÉ
                    favoriteIcon.innerHTML = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>';
                    // ÈöêËóè‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™ó
                    toggleTogether();
                }
            }

            // Êí≠ÊîæÊ≠åÊõ≤
            function playSong(index) {
                currentSongIndex = index;
                isPlaying = true;
                
                // Â¶ÇÊûúÊòØÈöèÊú∫Êí≠ÊîæÊ®°ÂºèÔºåÊõ¥Êñ∞ÈöèÊú∫Êí≠ÊîæÈ°∫Â∫è
                if (isShuffle && shuffleOrder.length > 0) {
                    // Á°Æ‰øùÂΩìÂâçÊ≠åÊõ≤Âú®ÈöèÊú∫Êí≠ÊîæÈ°∫Â∫è‰∏≠
                    if (!shuffleOrder.includes(currentSongIndex)) {
                        shuffleOrder.unshift(currentSongIndex);
                    }
                }
                
                // ÂÆûÈôÖÊí≠ÊîæÈü≥È¢ë
                if (audioPlayer && currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    const song = songs[currentSongIndex];
                    audioPlayer.src = song.url;
                    audioPlayer.play()
                        .then(() => {
                            console.log('ÂºÄÂßãÊí≠Êîæ:', song.title);
                            // ‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
                            savePlaybackState();
                            // Â¶ÇÊûú‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™óÊâìÂºÄÔºåÂºÄÂßãËÆ°Êó∂
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                            alert('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•URLÊòØÂê¶ÊúâÊïà');
                        });
                }
                
                updatePlayerUI();
                renderSongsList();
                
                // Â¶ÇÊûúÊí≠ÊîæÂàóË°®ÊòØÊâìÂºÄÁöÑÔºåÊõ¥Êñ∞Êí≠ÊîæÂàóË°®ÊòæÁ§∫
                if (document.getElementById('playlistModal').classList.contains('open')) {
                    renderPlaylist();
                }
            }

            // ÂºÄÂßã‰∏ÄËµ∑Âê¨Ê≠åËÆ°Êó∂
            function startTogetherTimer() {
                // Âè™ÊúâÂú®Èü≥‰πêÊí≠ÊîæÊó∂ÊâçÂºÄÂßãËÆ°Êó∂
                if (!isPlaying) return;
                
                if (!togetherStartTime) {
                    togetherStartTime = new Date();
                }
                
                if (togetherTimer) {
                    clearInterval(togetherTimer);
                }
                
                togetherTimer = setInterval(() => {
                    const now = new Date();
                    const elapsed = togetherDuration + (now - togetherStartTime);
                    const seconds = Math.floor(elapsed / 1000) % 60;
                    const minutes = Math.floor(elapsed / (1000 * 60)) % 60;
                    const hours = Math.floor(elapsed / (1000 * 60 * 60));
                    
                    document.getElementById('togetherDuration').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            // ÂÅúÊ≠¢‰∏ÄËµ∑Âê¨Ê≠åËÆ°Êó∂
            function stopTogetherTimer() {
                if (togetherTimer) {
                    clearInterval(togetherTimer);
                    togetherTimer = null;
                }
                
                if (togetherStartTime) {
                    const now = new Date();
                    togetherDuration += (now - togetherStartTime);
                    togetherStartTime = null;
                    // ‰øùÂ≠òÊó∂Èïø
                    saveTogetherDuration();
                }
            }

            // È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÊó∂Èïø
            window.addEventListener('beforeunload', function() {
                // ÂÅúÊ≠¢ËÆ°Êó∂Âô®Âπ∂‰øùÂ≠òÊó∂Èïø
                stopTogetherTimer();
            });

            // ÂàáÊç¢Êí≠Êîæ/ÊöÇÂÅú
            function togglePlay(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (currentSongIndex < 0) {
                    if (songs.length > 0) {
                        playSong(0);
                    }
                    return;
                }
                
                isPlaying = !isPlaying;
                if (isPlaying) {
                    // Êí≠Êîæ
                    audioPlayer.play()
                        .then(() => {
                            console.log('ÁªßÁª≠Êí≠Êîæ');
                            // Â¶ÇÊûú‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™óÊâìÂºÄÔºåÂºÄÂßãËÆ°Êó∂
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                        });
                } else {
                    // ÊöÇÂÅú
                    audioPlayer.pause();
                    console.log('ÊöÇÂÅúÊí≠Êîæ');
                    // Â¶ÇÊûú‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™óÊâìÂºÄÔºåÂÅúÊ≠¢ËÆ°Êó∂
                    if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                        stopTogetherTimer();
                    }
                }
                
                updatePlayerUI();
            }

            // ‰∏ä‰∏ÄÈ¶ñ
            function prevSong(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÁ°ÆÂÆö‰∏ä‰∏ÄÈ¶ñÊ≠åÊõ≤
                if (isShuffle && shuffleOrder.length > 0) {
                    // ÈöèÊú∫Êí≠ÊîæÊ®°Âºè
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const prevIndexInShuffle = (currentIndexInShuffle - 1 + shuffleOrder.length) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[prevIndexInShuffle];
                } else {
                    // ÊôÆÈÄöÊí≠ÊîæÊ®°Âºè
                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // ‰∏ã‰∏ÄÈ¶ñ
            function nextSong(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÁ°ÆÂÆö‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤
                if (isShuffle && shuffleOrder.length > 0) {
                    // ÈöèÊú∫Êí≠ÊîæÊ®°Âºè
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const nextIndexInShuffle = (currentIndexInShuffle + 1) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[nextIndexInShuffle];
                } else {
                    // ÊôÆÈÄöÊí≠ÊîæÊ®°Âºè
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // ÈÄâÊã©ËßíËâ≤
            function selectCharacter(character) {
                selectedCharacter = character;
                document.getElementById('characterName').textContent = character.name;
                
                // Â§ÑÁêÜÂ§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                let avatarDisplay = '';
                if (character.avatar && (character.avatar.startsWith('http://') || character.avatar.startsWith('https://'))) {
                    // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${character.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (character.avatar && character.avatar.startsWith('data:image')) {
                    // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${character.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                    avatarDisplay = `<div class="avatar-placeholder">${character.avatar || 'üë§'}</div>`;
                }
                
                document.getElementById('characterAvatar').innerHTML = avatarDisplay;
            }

            // ÊâìÂºÄËßíËâ≤ÈÄâÊã©ÂºπÁ™ó
            function openCharacterModal() {
                document.getElementById('characterModal').style.display = 'flex';
                renderCharacterList();
            }

            // ÂÖ≥Èó≠ËßíËâ≤ÈÄâÊã©ÂºπÁ™ó
            function closeCharacterModal() {
                document.getElementById('characterModal').style.display = 'none';
            }

            // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
            function renderCharacterList() {
                const characterListElement = document.getElementById('characterList');
                characterListElement.innerHTML = '';
                
                // ‰ªéËßíËâ≤‰π¶Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ
                const savedCharacters = localStorage.getItem('characters');
                let characters = [];
                
                if (savedCharacters) {
                    try {
                        characters = JSON.parse(savedCharacters);
                    } catch (e) {
                        console.error('Ëß£ÊûêËßíËâ≤Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
                    }
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâËßíËâ≤ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
                if (characters.length === 0) {
                    characterListElement.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">ÊöÇÊó†ËßíËâ≤ÔºåËØ∑ÂÖàÂú®ËßíËâ≤‰π¶È°µÈù¢ÂàõÂª∫ËßíËâ≤</div>';
                    return;
                }
                
                characters.forEach(character => {
                    const characterItem = document.createElement('div');
                    characterItem.className = 'character-item';
                    
                    // Â§ÑÁêÜÂ§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                    let avatarDisplay = '';
                    if (character.avatar && (character.avatar.startsWith('http://') || character.avatar.startsWith('https://'))) {
                        // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                        avatarDisplay = `<img src="${character.avatar}" alt="${character.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else if (character.avatar && character.avatar.startsWith('data:image')) {
                        // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                        avatarDisplay = `<img src="${character.avatar}" alt="${character.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                        avatarDisplay = `<div class="avatar-placeholder">${character.avatar || 'üë§'}</div>`;
                    }
                    
                    characterItem.innerHTML = `
                        <div class="character-avatar">
                            ${avatarDisplay}
                        </div>
                        <div class="character-name">${character.name}</div>
                    `;
                    
                    characterItem.onclick = () => {
                        // ÈÄâÊã©ËßíËâ≤Âπ∂‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                        selectCharacter(character);
                        saveSelectedCharacter(character);
                        closeCharacterModal();
                    };
                    
                    characterListElement.appendChild(characterItem);
                });
            }

            // ‰øùÂ≠òÈÄâ‰∏≠ÁöÑËßíËâ≤
            function saveSelectedCharacter(character) {
                try {
                    localStorage.setItem('selectedMusicCharacter', JSON.stringify(character));
                } catch (e) {
                    console.error('‰øùÂ≠òÈÄâ‰∏≠ËßíËâ≤Êó∂Âá∫Èîô:', e);
                }
            }

            // Âä†ËΩΩÈÄâ‰∏≠ÁöÑËßíËâ≤
            function loadSelectedCharacter() {
                try {
                    const savedCharacter = localStorage.getItem('selectedMusicCharacter');
                    if (savedCharacter) {
                        const character = JSON.parse(savedCharacter);
                        selectCharacter(character);
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩÈÄâ‰∏≠ËßíËâ≤Êó∂Âá∫Èîô:', e);
                }
            }

            // ÊâìÂºÄÁî®Êà∑ËÆæÁΩÆÂºπÁ™ó
            function openUserModal() {
                document.getElementById('userModal').style.display = 'flex';
                // Â°´ÂÖÖÁé∞ÊúâËÆæÁΩÆ
                document.getElementById('userRealName').value = userSettings.name;
                document.getElementById('userPersona').value = userSettings.persona;
                document.getElementById('userAvatarPreview').textContent = userSettings.avatar;
            }

            // ÂÖ≥Èó≠Áî®Êà∑ËÆæÁΩÆÂºπÁ™ó
            function closeUserModal() {
                document.getElementById('userModal').style.display = 'none';
            }

            // Â§ÑÁêÜÁî®Êà∑Â§¥ÂÉè‰∏ä‰º†
            function handleUserAvatarUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('userAvatarPreview').innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // ‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆ
            function saveUserSettings() {
                userSettings.name = document.getElementById('userRealName').value;
                userSettings.persona = document.getElementById('userPersona').value;
                
                // Êõ¥Êñ∞Áî®Êà∑Â§¥ÂÉèÊòæÁ§∫
                const avatarPreview = document.getElementById('userAvatarPreview');
                if (avatarPreview.querySelector('img')) {
                    userSettings.avatar = avatarPreview.innerHTML;
                } else {
                    userSettings.avatar = avatarPreview.textContent;
                }
                
                // Êõ¥Êñ∞Áî®Êà∑Â§¥ÂÉèÂíåÂêçÁß∞ÊòæÁ§∫
                document.getElementById('userName').textContent = userSettings.name || 'Áî®Êà∑ËÆæÁΩÆ';
                
                // Â§ÑÁêÜÁî®Êà∑Â§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                let avatarDisplay = '';
                if (userSettings.avatar && (userSettings.avatar.startsWith('http://') || userSettings.avatar.startsWith('https://'))) {
                    // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (userSettings.avatar && userSettings.avatar.startsWith('data:image')) {
                    // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                    avatarDisplay = userSettings.avatar || '<div class="avatar-placeholder">üë§</div>';
                }
                
                document.getElementById('userAvatar').innerHTML = avatarDisplay;
                
                // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
                try {
                    localStorage.setItem('musicUserSettings', JSON.stringify(userSettings));
                    // Ê∑ªÂä†‰øùÂ≠òÊàêÂäüÁöÑÊèêÁ§∫
                    alert('Áî®Êà∑ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ');
                } catch (e) {
                    console.error('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                    alert('‰øùÂ≠òÁî®Êà∑ËÆæÁΩÆÊó∂Âá∫ÈîôÔºåËØ∑ÈáçËØï');
                }
                
                closeUserModal();
            }

            // Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆ
            function loadUserSettings() {
                try {
                    const savedUserSettings = localStorage.getItem('musicUserSettings');
                    if (savedUserSettings) {
                        userSettings = JSON.parse(savedUserSettings);
                        // Êõ¥Êñ∞UIÊòæÁ§∫
                        document.getElementById('userName').textContent = userSettings.name || 'Áî®Êà∑ËÆæÁΩÆ';
                        
                        // Â§ÑÁêÜÁî®Êà∑Â§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                        let avatarDisplay = '';
                        if (userSettings.avatar && (userSettings.avatar.startsWith('http://') || userSettings.avatar.startsWith('https://'))) {
                            // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                            avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else if (userSettings.avatar && userSettings.avatar.startsWith('data:image')) {
                            // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                            avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else {
                            // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                            avatarDisplay = userSettings.avatar || '<div class="avatar-placeholder">üë§</div>';
                        }
                        
                        document.getElementById('userAvatar').innerHTML = avatarDisplay;
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩÁî®Êà∑ËÆæÁΩÆÊó∂Âá∫Èîô:', e);
                }
            }

            // ‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
            function savePlaybackState() {
                if (currentSongIndex < 0) return;
                
                try {
                    const playbackState = {
                        currentSongIndex: currentSongIndex,
                        isPlaying: isPlaying,
                        currentTime: audioPlayer ? audioPlayer.currentTime : 0,
                        volume: audioPlayer ? audioPlayer.volume : 1,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('musicPlaybackState', JSON.stringify(playbackState));
                } catch (e) {
                    console.error('‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅÊó∂Âá∫Èîô:', e);
                }
            }

            // Âä†ËΩΩÊí≠ÊîæÁä∂ÊÄÅ
            function loadPlaybackState() {
                try {
                    const savedPlaybackState = localStorage.getItem('musicPlaybackState');
                    if (savedPlaybackState) {
                        const playbackState = JSON.parse(savedPlaybackState);
                        
                        // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ËøáÊúüÔºàË∂ÖËøá24Â∞èÊó∂Ôºâ
                        const oneDay = 24 * 60 * 60 * 1000;
                        if (Date.now() - playbackState.timestamp < oneDay) {
                            currentSongIndex = playbackState.currentSongIndex;
                            isPlaying = playbackState.isPlaying;
                            
                            // Êõ¥Êñ∞UI
                            updatePlayerUI();
                            renderSongsList();
                            
                            // Â¶ÇÊûúÊúâÂΩìÂâçÊ≠åÊõ≤ÔºåËÆæÁΩÆÊí≠ÊîæÂô®
                            if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                                const song = songs[currentSongIndex];
                                audioPlayer.src = song.url;
                                
                                // ËÆæÁΩÆÊí≠Êîæ‰ΩçÁΩÆ
                                if (playbackState.currentTime > 0) {
                                    audioPlayer.currentTime = playbackState.currentTime;
                                }
                                
                                // ËÆæÁΩÆÈü≥Èáè
                                if (playbackState.volume !== undefined) {
                                    audioPlayer.volume = playbackState.volume;
                                }
                                
                                // Ê≥®ÊÑèÔºöÁî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®Á≠ñÁï•Ôºå‰∏çËÉΩËá™Âä®Êí≠ÊîæÈü≥È¢ë
                                // Âè™ÊúâÂú®Áî®Êà∑‰∫§‰∫íÂêéÊâçËÉΩÊí≠ÊîæÈü≥È¢ë
                                // Â¶ÇÊûú‰πãÂâçÊòØÊí≠ÊîæÁä∂ÊÄÅÔºåÊàë‰ª¨Âè™ËÆæÁΩÆÊí≠Êîæ‰ΩçÁΩÆ‰ΩÜ‰∏çËá™Âä®Êí≠Êîæ
                                if (isPlaying) {
                                    console.log('È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊµãÂà∞‰πãÂâçÂ§Ñ‰∫éÊí≠ÊîæÁä∂ÊÄÅÔºå‰ΩÜÁî±‰∫éÊµèËßàÂô®ÂÆâÂÖ®Á≠ñÁï•ÈôêÂà∂ÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÂêéÊâçËÉΩÁªßÁª≠Êí≠Êîæ');
                                    // Êõ¥Êñ∞Êí≠ÊîæÊåâÈíÆÁä∂ÊÄÅ‰∏∫ÊöÇÂÅúÁä∂ÊÄÅ
                                    isPlaying = false;
                                    updatePlayerUI();
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩÊí≠ÊîæÁä∂ÊÄÅÊó∂Âá∫Èîô:', e);
                }
            }

            // ÂèëÈÄÅÊ∂àÊÅØ
            function sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message) {
                    addMessageToChat('user', message);
                    input.value = '';
                }
            }

            // ÂèëÈÄÅAIÊ∂àÊÅØ
            function sendAiMessage() {
                // Ëé∑ÂèñËÅäÂ§©ËæìÂÖ•Ê°ÜÁöÑÂÜÖÂÆπ
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                // Â¶ÇÊûúÊúâËæìÂÖ•ÂÜÖÂÆπÔºåÂÖàÂèëÈÄÅÁî®Êà∑Ê∂àÊÅØ
                if (message) {
                    addMessageToChat('user', message);
                    input.value = '';
                }
                
                // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ
                const chatMessages = document.getElementById('chatMessages');
                const userMessages = chatMessages.querySelectorAll('.message-container.sent');
                if (userMessages.length > 0) {
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    const lastMessageContent = lastUserMessage.querySelector('.message-content').textContent;
                    
                    // ‰ΩøÁî®ËÆæÁΩÆÈ°µÈù¢ÁöÑAIÂäüËÉΩÂèëÈÄÅÊ∂àÊÅØ
                    sendAiMessageFromSettings(lastMessageContent);
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑Ê∂àÊÅØÔºåÂèëÈÄÅÈªòËÆ§Ê∂àÊÅØ
                    sendAiMessageFromSettings('‰Ω†Â•ΩÔºÅ');
                }
            }

            // ‰ΩøÁî®ËÆæÁΩÆÈ°µÈù¢ÁöÑAIÂäüËÉΩÂèëÈÄÅÊ∂àÊÅØ
            async function sendAiMessageFromSettings(message) {
                // ÊòæÁ§∫Ê≠£Âú®ËæìÂÖ•ÁöÑÊèêÁ§∫
                addMessageToChat('ai', 'Ê≠£Âú®ËæìÂÖ•...');
                
                try {
                    // Ëé∑ÂèñAIËÆæÁΩÆ
                    const savedSettings = localStorage.getItem('aiSettings');
                    let settings = {
                        provider: 'openai',
                        url: 'https://api.openai.com/v1',
                        key: '',
                        model: 'gpt-3.5-turbo',
                        enabled: true
                    };
                    
                    if (savedSettings) {
                        try {
                            settings = JSON.parse(savedSettings);
                        } catch (e) {
                            console.error('Failed to parse saved settings', e);
                        }
                    }
                    
                    // Ê£ÄÊü•ÂøÖË¶ÅÈÖçÁΩÆ
                    if (!settings.key) {
                        throw new Error('ËØ∑Âú®ËÆæÁΩÆÈ°µÈù¢ÈÖçÁΩÆAPIÂØÜÈí•');
                    }
                    
                    if (!settings.model) {
                        throw new Error('ËØ∑Âú®ËÆæÁΩÆÈ°µÈù¢ÈÖçÁΩÆÊ®°ÂûãÂêçÁß∞');
                    }
                    
                    // Ê†πÊçÆÊèê‰æõÂïÜÊûÑÂª∫ËØ∑Ê±Ç
                    let apiUrl = settings.url;
                    
                    // Á°Æ‰øùURLÊ†ºÂºèÊ≠£Á°Æ
                    if (!apiUrl) {
                        if (settings.provider === 'openai') {
                            apiUrl = 'https://api.openai.com/v1';
                        } else if (settings.provider === 'gemini') {
                            apiUrl = 'https://generativelanguage.googleapis.com/v1beta';
                        } else if (settings.provider === 'siliconflow') {
                            apiUrl = 'https://api.siliconflow.cn/v1';
                        } else if (settings.provider === 'deepseek') {
                            apiUrl = 'https://api.deepseek.com/v1';
                        } else {
                            // Ëá™ÂÆö‰πâÊèê‰æõÂïÜ
                            if (!apiUrl) {
                                throw new Error('ËØ∑Âú®ËÆæÁΩÆÈ°µÈù¢ÈÖçÁΩÆAPIÂú∞ÂùÄ');
                            }
                        }
                    }
                    
                    // Á°Æ‰øùURL‰ª•/ÁªìÂ∞æÔºàÁî®‰∫échat/completionsÔºâ
                    if (settings.provider !== 'gemini' && !apiUrl.endsWith('/')) {
                        apiUrl += '/';
                    }
                    
                    let fetchUrl = '';
                    let fetchOptions = {};
                    let aiResponse = '';
                    
                    // ÊûÑÂª∫Ê∂àÊÅØÂéÜÂè≤ÔºåÂåÖÂê´ËßíËâ≤‰ø°ÊÅØÂíåÈü≥‰πê‰ø°ÊÅØ
                    let systemPrompt = "‰Ω†ÊòØ‰∏Ä‰∏™ÁúüÂÆûÁöÑ‰∫∫Á±ªÔºåÊ≠£Âú®ÂíåÊúãÂèã‰∏ÄËµ∑Âê¨Ê≠åËÅäÂ§©„ÄÇ‰Ω†ÈúÄË¶Å‰ª•ÁúüÂÆû„ÄÅËá™ÁÑ∂„ÄÅÊúâ‰∏™ÊÄßÁöÑÊñπÂºèËøõË°åÂØπËØùÔºåÂ∞±ÂÉèÁúüÂÆûÁöÑÊúãÂèã‰πãÈó¥ËÅäÂ§©‰∏ÄÊ†∑„ÄÇÂõûÂ§çÊó∂‰∏çË¶Å‰ΩøÁî®Êã¨Âè∑Ôºå‰∏çË¶ÅÊèêÂèä‰Ω†ÊòØAIÔºåË¶ÅÂÉèÁúüÂÆûÁöÑ‰∫∫Á±ª‰∏ÄÊ†∑Ë°®ËææÊÉÖÊÑüÂíåËßÇÁÇπ„ÄÇ";
                    
                    // Ëé∑ÂèñÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πê‰ø°ÊÅØ
                    let musicInfo = '';
                    if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                        const song = songs[currentSongIndex];
                        musicInfo = `\nÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥‰πêÔºö„Ää${song.title}„Äã - ${song.artist}`;
                        if (song.album) {
                            musicInfo += ` ‰∏ìËæëÔºö${song.album}`;
                        }
                        // Ê∑ªÂä†ÂÆåÊï¥Ê≠åËØç‰Ωú‰∏∫ÂèÇËÄÉ
                        if (song.lyrics) {
                            // ËøáÊª§ÊéâÊó∂Èó¥ËΩ¥ÂíåÂÖÉ‰ø°ÊÅØË°åÔºåÂè™‰øùÁïôÁ∫ØÊ≠åËØçÂÜÖÂÆπ
                            const lyricsLines = song.lyrics.split('\n')
                                .map(line => {
                                    // ÁßªÈô§Êó∂Èó¥ËΩ¥Ê†áÁ≠æ [00:00.00]
                                    return line.replace(/\[\d{1,2}:\d{2}[.:]?\d*\]/g, '').trim();
                                })
                                .filter(line => {
                                    // ËøáÊª§ÊéâÁ©∫Ë°åÂíåÂÖÉ‰ø°ÊÅØË°å
                                    return line.trim() !== '' && 
                                           !line.startsWith('ËØçÔºö') && 
                                           !line.startsWith('Êõ≤Ôºö') && 
                                           !line.startsWith('ÁºñÊõ≤Ôºö') && 
                                           !line.startsWith('Âà∂‰Ωú‰∫∫Ôºö') && 
                                           !line.startsWith('Ê∑∑Èü≥Ôºö') && 
                                           !line.startsWith('ÂíåÂ£∞Ôºö') && 
                                           !line.startsWith('Â∞ÅÈù¢Ôºö') && 
                                           !line.startsWith('ÁªüÁ≠πÔºö') && 
                                           !line.startsWith('Âá∫ÂìÅ‰∫∫Ôºö') && 
                                           !line.startsWith('ÂèëË°åÔºö') && 
                                           !line.startsWith('Âà∂‰ΩúÂÖ¨Âè∏Ôºö') && 
                                           !line.startsWith('opÔºö');
                                });
                            
                            if (lyricsLines.length > 0) {
                                musicInfo += `\nÂÆåÊï¥Ê≠åËØçÔºö\n${lyricsLines.join('\n')}`;
                            }
                        }
                    } else {
                        musicInfo = '\nÂΩìÂâçÊ≤°ÊúâÊí≠ÊîæÈü≥‰πê';
                    }
                    
                    // Â¶ÇÊûúÈÄâÊã©‰∫ÜËßíËâ≤Ôºå‰ΩøÁî®ËßíËâ≤‰ø°ÊÅØ
                    if (selectedCharacter) {
                        systemPrompt = `‰Ω†Ê≠£Âú®ÊâÆÊºî${selectedCharacter.name}Ëøô‰∏™ËßíËâ≤ÔºåÊ≠£Âú®ÂíåÊúãÂèã‰∏ÄËµ∑Âê¨Ê≠åËÅäÂ§©„ÄÇËØ∑‰ª•${selectedCharacter.name}ÁöÑË∫´‰ªΩ„ÄÅËØ≠Ê∞îÂíåÊÄßÊ†ºÁâπÁÇπËøõË°åÂØπËØùÔºåÂ∞±ÂÉèÁúüÂÆûÁöÑ‰∫∫Á±ª‰∏ÄÊ†∑Ë°®ËææÊÉÖÊÑüÂíåËßÇÁÇπ„ÄÇÂõûÂ§çÊó∂‰∏çË¶Å‰ΩøÁî®Êã¨Âè∑Ôºå‰∏çË¶ÅÊèêÂèä‰Ω†ÊòØAIÔºåË¶ÅÂÉèÁúüÂÆûÁöÑ‰∫∫Á±ª‰∏ÄÊ†∑Ëá™ÁÑ∂Âú∞ËÅäÂ§©„ÄÇ`;
                        // Â¶ÇÊûúËßíËâ≤ÊúâÊèèËø∞‰ø°ÊÅØÔºåÊ∑ªÂä†Âà∞ÊèêÁ§∫‰∏≠
                        if (selectedCharacter.desc) {
                            systemPrompt += `\nËßíËâ≤ËÆæÂÆöÔºö${selectedCharacter.desc}`;
                        }
                    }
                    
                    // Ê∑ªÂä†Èü≥‰πê‰ø°ÊÅØÂà∞Á≥ªÁªüÊèêÁ§∫
                    systemPrompt += musicInfo;
                    
                    // Ê∑ªÂä†Áî®Êà∑‰ø°ÊÅØÂà∞Á≥ªÁªüÊèêÁ§∫
                    if (userSettings.name) {
                        systemPrompt += `\nÊúãÂèãÂßìÂêçÔºö${userSettings.name}`;
                    }
                    if (userSettings.persona) {
                        systemPrompt += `\nÊúãÂèã‰∫∫ËÆæÔºö${userSettings.persona}`;
                    }
                    
                    // Âº∫Ë∞ÉÂõûÂ§çË¶ÅÊ±Ç - ÂçáÁ∫ßÂêéÁöÑÁâàÊú¨
                    systemPrompt += "\n\nËØ∑ËÆ∞‰ΩèÔºö\n1. ÂÉèÁúüÂÆûÁöÑ‰∫∫Á±ª‰∏ÄÊ†∑ËÅäÂ§©ÔºåÊúâÊÉÖÊÑü„ÄÅÊúâ‰∏™ÊÄß\n2. ÂõûÂ§çË¶ÅÂÖ∑‰Ωì„ÄÅÊúâÈíàÂØπÊÄßÔºå‰∏çË¶ÅÊ≥õÊ≥õËÄåË∞à\n3. ÂèØ‰ª•Ë°®Ëææ‰∏™‰∫∫ËßÇÁÇπÂíåÊÑüÂèó\n4. ‰∏çË¶Å‰ΩøÁî®Êã¨Âè∑\n5. ‰∏çË¶ÅÊèêÂèä‰Ω†ÊòØAI\n6. ÂõûÂ§çË¶ÅËá™ÁÑ∂„ÄÅÂè£ËØ≠Âåñ\n7. ÁâπÂà´Ê≥®ÊÑèË¶ÅÂü∫‰∫éÁî®Êà∑ÊúÄÊñ∞ÂèëÈÄÅÁöÑÊ∂àÊÅØËøõË°åÂõûÂ§çÔºå‰∏çË¶ÅÁ≠îÈùûÊâÄÈóÆ\n8. Èô§‰∫ÜËÅäÈü≥‰πêÁõ∏ÂÖ≥ÁöÑËØùÈ¢òÔºå‰πüÂèØ‰ª•ËÅäÂÆ∂Â∏∏„ÄÅÁîüÊ¥ª„ÄÅÂÖ¥Ë∂£Áà±Â•ΩÁ≠âÂÖ∂‰ªñËØùÈ¢ò\n9. ÂèØ‰ª•‰∏ªÂä®ÂàÜ‰∫´Ëá™Â∑±ÁöÑÊÉ≥Ê≥ï„ÄÅÊÑüÂèóÂíåÁªèÂéÜÔºåÂ¢ûÂä†‰∫íÂä®ÊÄß\n10. ‰øùÊåÅËΩªÊùæÊÑâÂø´ÁöÑËÅäÂ§©Ê∞õÂõ¥ÔºåËÆ©ÂØπËØùÊõ¥ÊúâË∂£";
                    
                    // ÁâπÂà´Âº∫Ë∞ÉÂΩìÂâçÂØπËØù‰∏ä‰∏ãÊñá
                    if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                        const song = songs[currentSongIndex];
                        systemPrompt += `\n\nÁâπÂà´Ê≥®ÊÑèÔºöÁî®Êà∑Ê≠£Âú®Âíå‰Ω†ËÅäÂ§©ÔºåÂΩìÂâçÊ≠£Âú®Êí≠Êîæ„Ää${song.title}„ÄãËøôÈ¶ñÊ≠å„ÄÇ‰Ω†ÂèØ‰ª•Âü∫‰∫éËøôÈ¶ñÊ≠åÂ±ïÂºÄËØùÈ¢òÔºå‰πüÂèØ‰ª•ËÅäÂÖ∂‰ªñ‰ªª‰ΩïÁî®Êà∑ÊÑüÂÖ¥Ë∂£ÁöÑËØùÈ¢ò„ÄÇ`;
                    } else {
                        systemPrompt += `\n\nÁâπÂà´Ê≥®ÊÑèÔºöÁî®Êà∑Ê≠£Âú®Âíå‰Ω†ËÅäÂ§©ÔºåÂΩìÂâçÊ≤°ÊúâÊí≠ÊîæÈü≥‰πê„ÄÇ‰Ω†ÂèØ‰ª•ÂíåÁî®Êà∑ËÅä‰ªª‰ΩïËØùÈ¢òÔºåÂåÖÊã¨‰ΩÜ‰∏çÈôê‰∫éÈü≥‰πê„ÄÅÁîüÊ¥ª„ÄÅÂÖ¥Ë∂£Áà±Â•ΩÁ≠â„ÄÇ`;
                    }
                    
                    // Ê†πÊçÆÁî®Êà∑Ê∂àÊÅØÂÜÖÂÆπÂà§Êñ≠ËØùÈ¢òÁ±ªÂûãÂπ∂ÁªôÂá∫Áõ∏Â∫îÊèêÁ§∫
                    if (message.toLowerCase().includes('ÂñúÊ¨¢') || message.toLowerCase().includes('Áà±Â•Ω') || message.toLowerCase().includes('ÂÖ¥Ë∂£')) {
                        systemPrompt += "\n\nÁî®Êà∑‰ºº‰πéÂú®ËØ¢ÈóÆÂñúÂ•ΩÊàñÂÖ¥Ë∂£ÔºåËØ∑ÂàÜ‰∫´‰Ω†Ëá™Â∑±ÁöÑÂñúÂ•ΩÂíåÂÖ¥Ë∂£ÔºåËÆ©ÂØπËØùÊõ¥Âä†‰∏™ÊÄßÂåñ„ÄÇ";
                    } else if (message.toLowerCase().includes('Â§©Ê∞î') || message.toLowerCase().includes('‰ªäÂ§©') || message.toLowerCase().includes('Áé∞Âú®')) {
                        systemPrompt += "\n\nÁî®Êà∑‰ºº‰πéÂú®ËÅäÊó•Â∏∏ÁîüÊ¥ªËØùÈ¢òÔºåËØ∑‰ª•ÊúãÂèãÁöÑË∫´‰ªΩÂàÜ‰∫´‰Ω†ÁöÑÊó•Â∏∏ÁîüÊ¥ªÊÑüÂèó„ÄÇ";
                    } else if (message.toLowerCase().includes('Â∏ÆÂä©') || message.toLowerCase().includes('ÊÄé‰πàÂÅö') || message.toLowerCase().includes('Â¶Ç‰Ωï')) {
                        systemPrompt += "\n\nÁî®Êà∑‰ºº‰πéÈúÄË¶ÅÂ∏ÆÂä©ÊàñÂª∫ËÆÆÔºåËØ∑Êèê‰æõÂÆûÁî®‰∏îÂèãÂñÑÁöÑÂª∫ËÆÆ„ÄÇ";
                    }
                    
                    const messages = [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: message
                        }
                    ];
                    
                    if (settings.provider === 'gemini') {
                        // Google Gemini API
                        fetchUrl = `${apiUrl}/models/${settings.model}:generateContent?key=${settings.key}`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `Áî®Êà∑Ê∂àÊÅØ: ${message}\n\nËØ∑Âü∫‰∫é‰ª•‰∏äÊ∂àÊÅØËøõË°åÂõûÂ§çÔºåÁ°Æ‰øùÂõûÂ§ç‰∏éÂΩìÂâçÊí≠ÊîæÁöÑÈü≥‰πêÁõ∏ÂÖ≥„ÄÇ`
                                    }]
                                }]
                            })
                        };
                    } else if (settings.provider === 'siliconflow') {
                        // SiliconFlow API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // Â¢ûÂä†Ê∏©Â∫¶ÂèÇÊï∞‰ª•Ëé∑ÂæóÊõ¥ÊúâÂàõÊÑèÁöÑÂõûÂ§ç
                                max_tokens: 1000
                            })
                        };
                    } else if (settings.provider === 'deepseek') {
                        // DeepSeek API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // Â¢ûÂä†Ê∏©Â∫¶ÂèÇÊï∞‰ª•Ëé∑ÂæóÊõ¥ÊúâÂàõÊÑèÁöÑÂõûÂ§ç
                                max_tokens: 1000
                            })
                        };
                    } else if (settings.provider === 'openai') {
                        // OpenAI API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // Â¢ûÂä†Ê∏©Â∫¶ÂèÇÊï∞‰ª•Ëé∑ÂæóÊõ¥ÊúâÂàõÊÑèÁöÑÂõûÂ§ç
                                max_tokens: 1000
                            })
                        };
                    } else {
                        // Ëá™ÂÆö‰πâÊèê‰æõÂïÜ
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // Â¢ûÂä†Ê∏©Â∫¶ÂèÇÊï∞‰ª•Ëé∑ÂæóÊõ¥ÊúâÂàõÊÑèÁöÑÂõûÂ§ç
                                max_tokens: 1000
                            })
                        };
                    }
                    
                    // Ê∑ªÂä†Ë∂ÖÊó∂ÊéßÂà∂
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ÁßíË∂ÖÊó∂
                    fetchOptions.signal = controller.signal;
                    
                    const response = await fetch(fetchUrl, fetchOptions);
                    clearTimeout(timeoutId);
                    
                    // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}\nËØ∑Ê±ÇURL: ${fetchUrl}\n${errorText}`);
                    }
                    
                    // Ëß£ÊûêÂìçÂ∫î
                    const data = await response.json();
                    
                    if (settings.provider === 'gemini') {
                        // GeminiÂìçÂ∫îÊ†ºÂºè
                        aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Êó†Ê≥ïËé∑ÂèñÂìçÂ∫îÂÜÖÂÆπ';
                    } else {
                        // OpenAI/SiliconFlow/DeepSeek/Ëá™ÂÆö‰πâÂìçÂ∫îÊ†ºÂºè
                        aiResponse = data.choices?.[0]?.message?.content || 'Êó†Ê≥ïËé∑ÂèñÂìçÂ∫îÂÜÖÂÆπ';
                    }
                    
                    // ÁßªÈô§"Ê≠£Âú®ËæìÂÖ•..."ÁöÑÊ∂àÊÅØ
                    const chatMessages = document.getElementById('chatMessages');
                    const lastMessage = chatMessages.lastChild;
                    if (lastMessage && lastMessage.querySelector('.message-content').textContent === 'Ê≠£Âú®ËæìÂÖ•...') {
                        chatMessages.removeChild(lastMessage);
                    }
                    
                    // Êô∫ËÉΩÊãÜÂàÜAIÂõûÂ§ç‰∏∫Â§öÊù°Ê∂àÊÅØ
                    // È¶ñÂÖàÊåâÂè•Âè∑„ÄÅÊÑüÂèπÂè∑„ÄÅÈóÆÂè∑ÂàÜÂâ≤
                    const sentences = aiResponse.split(/[„ÄÇÔºÅÔºü.!?]\s*/).filter(s => s.trim().length > 0);
                    
                    // Â¶ÇÊûúÂè•Â≠êÂ§™Â∞ëÔºåÂ∞±ÊåâÈÄóÂè∑ÂàÜÂâ≤
                    let messageParts = [];
                    if (sentences.length < 2) {
                        messageParts = aiResponse.split(/[Ôºå,]\s*/).filter(s => s.trim().length > 0);
                    } else {
                        messageParts = sentences;
                    }
                    
                    // Â¶ÇÊûúËøòÊòØÂ§™Â∞ëÔºåÂ∞±Êï¥‰ΩìÂèëÈÄÅ
                    if (messageParts.length === 0) {
                        messageParts = [aiResponse];
                    }
                    
                    // Ê†πÊçÆËØùÈ¢òÁ±ªÂûãÂíåÂÜÖÂÆπÈïøÂ∫¶Á°ÆÂÆöÂèëÈÄÅÁöÑÊ∂àÊÅØÊï∞Èáè
                    // Âà§Êñ≠ÊòØÂê¶‰∏éÈü≥‰πêÁõ∏ÂÖ≥
                    const isMusicRelated = message.toLowerCase().includes('Ê≠å') || message.toLowerCase().includes('Èü≥‰πê') || message.toLowerCase().includes('Âî±') || message.toLowerCase().includes('Âê¨') || currentSongIndex >= 0;
                    
                    // Ê†πÊçÆÂÜÖÂÆπÈïøÂ∫¶Ë∞ÉÊï¥Ê∂àÊÅØÊï∞Èáè
                    const contentLength = aiResponse.length;
                    let maxMessages, minMessages;
                    
                    if (isMusicRelated) {
                        // Èü≥‰πêÁõ∏ÂÖ≥ËØùÈ¢ò
                        maxMessages = Math.min(6, messageParts.length);
                        minMessages = Math.min(2, maxMessages);
                    } else {
                        // ÈùûÈü≥‰πêËØùÈ¢òÔºàÂÆ∂Â∏∏Á≠âÔºâ
                        maxMessages = Math.min(contentLength > 200 ? 8 : 6, messageParts.length);
                        minMessages = Math.min(contentLength > 100 ? 3 : 2, maxMessages);
                    }
                    
                    // ÈöèÊú∫Á°ÆÂÆöÂèëÈÄÅÁöÑÊ∂àÊÅØÊï∞Èáè
                    const messageCount = Math.max(minMessages, Math.min(maxMessages, Math.floor(Math.random() * (maxMessages - minMessages + 1)) + minMessages));
                    
                    // Âè™ÂèñÂâçmessageCountÊù°Ê∂àÊÅØ
                    const messagesToSend = messageParts.slice(0, messageCount);
                    
                    // ÈÄêÊù°ÂèëÈÄÅÊ∂àÊÅØÔºåÊØèÊù°Ê∂àÊÅØÈó¥Èöî0.3-1.5Áßí
                    // ÂØπ‰∫éÈùûÈü≥‰πêËØùÈ¢òÔºåÂõûÂ§çÂèØ‰ª•Á®çÂæÆÂø´‰∏Ä‰∫õ
                    const baseDelay = isMusicRelated ? 400 : 300;
                    const randomDelay = isMusicRelated ? 1200 : 1000;
                    
                    // ÂèëÈÄÅÊ∂àÊÅØ
                    for (let i = 0; i < messagesToSend.length; i++) {
                        setTimeout(() => {
                            addMessageToChat('ai', messagesToSend[i]);
                        }, (i + 1) * (baseDelay + Math.random() * randomDelay));
                    }
                } catch (error) {
                    console.error('AIÂõûÂ§çÂá∫Èîô:', error);
                    
                    // ÁßªÈô§"Ê≠£Âú®ËæìÂÖ•..."ÁöÑÊ∂àÊÅØ
                    const chatMessages = document.getElementById('chatMessages');
                    const lastMessage = chatMessages.lastChild;
                    if (lastMessage && lastMessage.querySelector('.message-content').textContent === 'Ê≠£Âú®ËæìÂÖ•...') {
                        chatMessages.removeChild(lastMessage);
                    }
                    
                    // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                    addMessageToChat('ai', 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ§çÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
                }
            }

            // ‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩï
            function saveChatMessages() {
                try {
                    // Ëé∑ÂèñÊâÄÊúâËÅäÂ§©Ê∂àÊÅØ
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = [];
                    
                    // ÈÅçÂéÜÊâÄÊúâÊ∂àÊÅØÂÆπÂô®
                    chatMessages.querySelectorAll('.message-container').forEach(container => {
                        const sender = container.classList.contains('sent') ? 'user' : 'ai';
                        const avatarElement = container.querySelector('.message-avatar');
                        const senderName = container.querySelector('.message-sender').textContent.split(' ')[0];
                        const time = container.querySelector('.message-time').textContent;
                        const content = container.querySelector('.message-content').textContent;
                        
                        // Ëé∑ÂèñÂ§¥ÂÉè‰ø°ÊÅØÔºåÂ¶ÇÊûúÊòØÂõæÁâáÂàô‰øùÂ≠òÂõæÁâáÁöÑsrcÔºåÂê¶Âàô‰øùÂ≠òÊñáÊú¨ÂÜÖÂÆπ
                        let avatar = '';
                        const imgElement = avatarElement.querySelector('img');
                        if (imgElement) {
                            // Â¶ÇÊûúÊòØÂõæÁâáÂ§¥ÂÉèÔºå‰øùÂ≠òÂõæÁâáÁöÑsrc
                            avatar = imgElement.src;
                        } else {
                            // Â¶ÇÊûúÊòØÊñáÊú¨Â§¥ÂÉèÔºå‰øùÂ≠òÊñáÊú¨ÂÜÖÂÆπ
                            avatar = avatarElement.textContent;
                        }
                        
                        messages.push({
                            sender: sender,
                            avatar: avatar,
                            senderName: senderName,
                            time: time,
                            content: content
                        });
                    });
                    
                    // ‰øùÂ≠òÂà∞localStorage
                    localStorage.setItem('musicChatMessages', JSON.stringify(messages));
                } catch (e) {
                    console.error('‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩïÊó∂Âá∫Èîô:', e);
                }
            }

            // Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩï
            function loadChatMessages() {
                try {
                    const savedMessages = localStorage.getItem('musicChatMessages');
                    if (savedMessages) {
                        const messages = JSON.parse(savedMessages);
                        const chatMessages = document.getElementById('chatMessages');
                        
                        // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ
                        chatMessages.innerHTML = '';
                        
                        // ÈáçÊñ∞ÂàõÂª∫Ê∂àÊÅØ
                        messages.forEach(msg => {
                            const messageContainer = document.createElement('div');
                            messageContainer.className = `message-container ${msg.sender === 'user' ? 'sent' : 'received'}`;
                            
                            // Â§ÑÁêÜÂ§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                            let avatarDisplay = '';
                            if (msg.avatar && (msg.avatar.startsWith('http://') || msg.avatar.startsWith('https://'))) {
                                // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                                avatarDisplay = `<img src="${msg.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                            } else if (msg.avatar && msg.avatar.startsWith('data:image')) {
                                // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                                avatarDisplay = `<img src="${msg.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                            } else {
                                // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                                avatarDisplay = msg.avatar;
                            }
                            
                            messageContainer.innerHTML = `
                                <div class="message-avatar">${avatarDisplay}</div>
                                <div class="message-bubble">
                                    <div class="message-sender">${msg.senderName} <span class="message-time">${msg.time}</span></div>
                                    <div class="message-content">${msg.content}</div>
                                </div>
                            `;
                            
                            chatMessages.appendChild(messageContainer);
                        });
                        
                        // ÊªöÂä®Âà∞Â∫ïÈÉ®
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩËÅäÂ§©ËÆ∞ÂΩïÊó∂Âá∫Èîô:', e);
                }
            }

            // ÊâìÂºÄËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó
            function openChatSettings() {
                // Âä†ËΩΩÂΩìÂâçËÆæÁΩÆ
                const autoHide = localStorage.getItem('autoHideMessages') === 'true'; // ÈªòËÆ§‰∏∫falseÔºà‰∏çËá™Âä®ÈöêËóèÔºâ
                document.getElementById('autoHideMessages').checked = autoHide;
                
                document.getElementById('chatSettingsModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠ËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó
            function closeChatSettingsModal() {
                document.getElementById('chatSettingsModal').style.display = 'none';
            }

            // ‰øùÂ≠òËÅäÂ§©ËÆæÁΩÆ
            function saveChatSettings() {
                const autoHide = document.getElementById('autoHideMessages').checked;
                localStorage.setItem('autoHideMessages', autoHide.toString());
                
                closeChatSettingsModal();
                alert('ËÅäÂ§©ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
            }

            // Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
            function clearChatHistory() {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // Ê∏ÖÁ©∫Êú¨Âú∞Â≠òÂÇ®ÁöÑËÅäÂ§©ËÆ∞ÂΩï
                    localStorage.removeItem('musicChatMessages');
                    
                    closeChatSettingsModal();
                    alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫ÔºÅ');
                }
            }

            // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©Èù¢Êùø
            function addMessageToChat(sender, message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${sender === 'user' ? 'sent' : 'received'}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Ëé∑ÂèñÂ§¥ÂÉè
                let avatar = 'üë§';
                if (sender === 'user') {
                    avatar = userSettings.avatar || 'üë§';
                } else if (selectedCharacter) {
                    avatar = selectedCharacter.avatar || 'üë§';
                }
                
                // Â§ÑÁêÜÂ§¥ÂÉèÊòæÁ§∫ÔºåÂå∫ÂàÜURLÂíåbase64Êï∞ÊçÆ
                let avatarDisplay = '';
                if (avatar && (avatar.startsWith('http://') || avatar.startsWith('https://'))) {
                    // Â¶ÇÊûúÊòØURLÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (avatar && avatar.startsWith('data:image')) {
                    // Â¶ÇÊûúÊòØbase64Êï∞ÊçÆÔºåÊòæÁ§∫‰∏∫ÂõæÁâá
                    avatarDisplay = `<img src="${avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // Â¶ÇÊûúÊòØÂ≠óÁ¨¶ÊàñÂÖ∂‰ªñÔºåÁõ¥Êé•ÊòæÁ§∫
                    avatarDisplay = avatar;
                }
                
                messageContainer.innerHTML = `
                    <div class="message-avatar">${avatarDisplay}</div>
                    <div class="message-bubble">
                        <div class="message-sender">${sender === 'user' ? (userSettings.name || 'Áî®Êà∑') : (selectedCharacter ? selectedCharacter.name : 'AI')} <span class="message-time">${time}</span></div>
                        <div class="message-content">${message}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // ‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩï
                saveChatMessages();
                
                // Ê†πÊçÆËÆæÁΩÆÂÜ≥ÂÆöÊòØÂê¶Ëá™Âä®ÈöêËóèAIÂõûÂ§çÊ∂àÊÅØ
                const autoHide = localStorage.getItem('autoHideMessages') === 'true';
                if (sender !== 'user' && autoHide) {
                    setTimeout(() => {
                        if (messageContainer.parentNode) {
                            messageContainer.parentNode.removeChild(messageContainer);
                        }
                    }, 3000);
                }
            }

            // È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÊó∂ÈïøÂíåÊí≠ÊîæÁä∂ÊÄÅ
            window.addEventListener('beforeunload', function() {
                // ÂÅúÊ≠¢ËÆ°Êó∂Âô®Âπ∂‰øùÂ≠òÊó∂Èïø
                stopTogetherTimer();
                
                // ‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
                savePlaybackState();
            });

            // ÂàáÊç¢Êí≠Êîæ/ÊöÇÂÅú
            function togglePlay(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (currentSongIndex < 0) {
                    if (songs.length > 0) {
                        playSong(0);
                    }
                    return;
                }
                
                isPlaying = !isPlaying;
                if (isPlaying) {
                    // Êí≠Êîæ
                    audioPlayer.play()
                        .then(() => {
                            console.log('ÁªßÁª≠Êí≠Êîæ');
                            // ‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
                            savePlaybackState();
                            // Â¶ÇÊûú‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™óÊâìÂºÄÔºåÂºÄÂßãËÆ°Êó∂
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('Êí≠ÊîæÂ§±Ë¥•:', error);
                        });
                } else {
                    // ÊöÇÂÅú
                    audioPlayer.pause();
                    console.log('ÊöÇÂÅúÊí≠Êîæ');
                    // ‰øùÂ≠òÊí≠ÊîæÁä∂ÊÄÅ
                    savePlaybackState();
                    // Â¶ÇÊûú‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™óÊâìÂºÄÔºåÂÅúÊ≠¢ËÆ°Êó∂
                    if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                        stopTogetherTimer();
                    }
                }
                
                updatePlayerUI();
            }

            // ‰∏ä‰∏ÄÈ¶ñ
            function prevSong(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÁ°ÆÂÆö‰∏ä‰∏ÄÈ¶ñÊ≠åÊõ≤
                if (isShuffle && shuffleOrder.length > 0) {
                    // ÈöèÊú∫Êí≠ÊîæÊ®°Âºè
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const prevIndexInShuffle = (currentIndexInShuffle - 1 + shuffleOrder.length) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[prevIndexInShuffle];
                } else {
                    // ÊôÆÈÄöÊí≠ÊîæÊ®°Âºè
                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // ‰∏ã‰∏ÄÈ¶ñ
            function nextSong(event) {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÁ°ÆÂÆö‰∏ã‰∏ÄÈ¶ñÊ≠åÊõ≤
                if (isShuffle && shuffleOrder.length > 0) {
                    // ÈöèÊú∫Êí≠ÊîæÊ®°Âºè
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const nextIndexInShuffle = (currentIndexInShuffle + 1) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[nextIndexInShuffle];
                } else {
                    // ÊôÆÈÄöÊí≠ÊîæÊ®°Âºè
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // ÂéãÁº©ÂõæÁâá
            function compressImage(file, quality = 0.6, maxWidth = 300, maxHeight = 300) {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        reject(new Error('‰∏çÊòØÂõæÁâáÊñá‰ª∂'));
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // ËÆ°ÁÆóÊñ∞Â∞∫ÂØ∏
                            let { width, height } = img;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = (width * maxHeight) / height;
                                    height = maxHeight;
                                }
                            }
                            
                            // ÂàõÂª∫canvasÂπ∂ÁªòÂà∂ÂõæÁâá
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // ËΩ¨Êç¢‰∏∫base64
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // Â§ÑÁêÜÂ∞ÅÈù¢‰∏ä‰º†
            function handleCoverUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫500KB)
                    if (file.size > 500 * 1024) {
                        alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é500KBÁöÑÂõæÁâá');
                        return;
                    }
                    
                    // ÂéãÁº©ÂõæÁâá
                    compressImage(file, 0.6, 300, 300)
                        .then(compressedData => {
                            // Ê£ÄÊü•ÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÂ§ßÂ∞è
                            if (compressedData.length > 100 * 1024) {
                                alert('ÂõæÁâáÂéãÁº©Âêé‰ªçÁÑ∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá');
                                return;
                            }
                            tempCover = compressedData;
                            document.getElementById('coverUploadText').textContent = 'Â∞ÅÈù¢Â∑≤ÈÄâÊã©';
                        })
                        .catch(error => {
                            console.error('ÂõæÁâáÂéãÁº©Â§±Ë¥•:', error);
                            alert('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        });
                }
            }

            // Ê∑ªÂä†Ê≠åÊõ≤
            function addSong() {
                const title = document.getElementById('songTitle').value.trim();
                const artist = document.getElementById('songArtist').value.trim();
                const url = document.getElementById('songUrl').value.trim();
                
                if (!title) {
                    alert('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞');
                    return;
                }
                
                if (!url) {
                    alert('ËØ∑ËæìÂÖ•Ê≠åÊõ≤URL');
                    return;
                }
                
                // Ê£ÄÊü•URLÊòØÂê¶ÊúâÊïà
                if (!url.startsWith('http')) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠åÊõ≤URLÔºà‰ª•httpÊàñhttpsÂºÄÂ§¥Ôºâ');
                    return;
                }
                
                // ÂàõÂª∫Êñ∞ÁöÑÊ≠åÊõ≤ÂØπË±°
                const newSong = {
                    id: Date.now(),
                    title: title,
                    artist: artist || 'Êú™Áü•Ê≠åÊâã',
                    url: url,
                    cover: tempCover,
                    lyrics: ''
                };
                
                console.log('ÂáÜÂ§áÊ∑ªÂä†Êñ∞Ê≠åÊõ≤:', newSong);
                
                // È™åËØÅURLÊòØÂê¶ÂèØËÆøÈóÆÔºàÂèØÈÄâÔºâ
                validateSongUrl(url)
                    .then(isValid => {
                        if (isValid) {
                            songs.push(newSong);
                            console.log('Ê∑ªÂä†ÂêéÊ≠åÊõ≤ÂàóË°®:', songs);
                            saveSongs();
                            renderSongsList();
                            closeAddSongModal();
                            alert('Ê≠åÊõ≤Ê∑ªÂä†ÊàêÂäüÔºÅ');
                        } else {
                            alert('Ê≠åÊõ≤URLÊó†Ê≥ïËÆøÈóÆÔºåËØ∑Ê£ÄÊü•ÈìæÊé•ÊòØÂê¶ÊúâÊïà');
                        }
                    })
                    .catch(error => {
                        console.error('È™åËØÅÊ≠åÊõ≤URLÊó∂Âá∫Èîô:', error);
                        // Âç≥‰ΩøÈ™åËØÅÂ§±Ë¥•‰πüÊ∑ªÂä†Ê≠åÊõ≤ÔºåÂõ†‰∏∫Êúâ‰∫õÈìæÊé•ÂèØËÉΩÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜ
                        songs.push(newSong);
                        console.log('Ê∑ªÂä†ÂêéÊ≠åÊõ≤ÂàóË°®:', songs);
                        saveSongs();
                        renderSongsList();
                        closeAddSongModal();
                        alert('Ê≠åÊõ≤Â∑≤Ê∑ªÂä†Ôºå‰ΩÜÈ™åËØÅÊó∂ÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑Á°Æ‰øùURLÊúâÊïà');
                    });
            }

            // È™åËØÅÊ≠åÊõ≤URLÊòØÂê¶ÊúâÊïà
            function validateSongUrl(url) {
                return new Promise((resolve, reject) => {
                    // ÂØπ‰∫éÊüê‰∫õÈü≥È¢ëÊúçÂä°ÔºåÊàë‰ª¨‰∏çËÉΩÁÆÄÂçïÂú∞ÈÄöËøáHEADËØ∑Ê±ÇÈ™åËØÅ
                    // Âõ†‰∏∫ÂÆÉ‰ª¨ÂèØËÉΩÈúÄË¶ÅÁâπÊÆäÁöÑËÆ§ËØÅÊàñÂèÇÊï∞
                    // ÊâÄ‰ª•Êàë‰ª¨ÈááÁî®Êõ¥ÂÆΩÊùæÁöÑÈ™åËØÅÊñπÂºè
                    
                    // Ê£ÄÊü•URLÊ†ºÂºè
                    if (!url || !url.startsWith('http')) {
                        resolve(false);
                        return;
                    }
                    
                    // ÂØπ‰∫éÂ∑≤Áü•ÁöÑÈü≥È¢ëÊúçÂä°ÔºåÊàë‰ª¨ÂÅáËÆæÂÆÉ‰ª¨ÊòØÊúâÊïàÁöÑ
                    const knownAudioServices = [
                        'http://music.163.com',
                        'https://music.163.com',
                        'http://y.qq.com',
                        'https://y.qq.com',
                        'http://music.taihe.com',
                        'https://music.taihe.com',
                        'http://kg.qq.com',
                        'https://kg.qq.com'
                    ];
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∑≤Áü•ÁöÑÈü≥È¢ëÊúçÂä°
                    const isKnownService = knownAudioServices.some(service => url.startsWith(service));
                    if (isKnownService) {
                        resolve(true);
                        return;
                    }
                    
                    // ÂØπ‰∫éÂÖ∂‰ªñURLÔºåÊàë‰ª¨Â∞ùËØïÂàõÂª∫‰∏Ä‰∏™Áü≠ÊöÇÁöÑÈü≥È¢ëÂØπË±°Êù•ÊµãËØï
                    try {
                        const audio = new Audio();
                        audio.addEventListener('loadedmetadata', () => {
                            resolve(true);
                            // Ê∏ÖÁêÜ
                            audio.src = '';
                        });
                        audio.addEventListener('error', () => {
                            resolve(false);
                            // Ê∏ÖÁêÜ
                            audio.src = '';
                        });
                        
                        // ËÆæÁΩÆË∂ÖÊó∂
                        setTimeout(() => {
                            audio.src = '';
                            resolve(true); // Ë∂ÖÊó∂ÂêéÂÅáËÆæÊúâÊïà
                        }, 3000);
                        
                        audio.src = url;
                        // ‰∏çË∞ÉÁî®load()Êàñplay()ÔºåÂè™ÊòØËÆæÁΩÆsrcÊù•ÈÅøÂÖçÂÆûÈôÖÂä†ËΩΩ
                    } catch (e) {
                        console.warn('URLÈ™åËØÅÊó∂Âá∫Áé∞ÂºÇÂ∏∏:', e);
                        resolve(true); // Âá∫Áé∞ÂºÇÂ∏∏Êó∂ÂÅáËÆæÊúâÊïà
                    }
                });
            }

            // ‰øùÂ≠òÊ≠åÊõ≤Êï∞ÊçÆ
            function saveSongs() {
                try {
                    // ÈôêÂà∂Ê≠åÊõ≤Êï∞ÈáèÔºåÊúÄÂ§ö‰øùÂ≠ò50È¶ñÊ≠åÊõ≤
                    if (songs.length > 50) {
                        songs = songs.slice(-50); // Âè™‰øùÁïôÊúÄÊñ∞ÁöÑ50È¶ñ
                        alert('Ê≠åÊõ≤Êï∞ÈáèÂ∑≤Ëææ‰∏äÈôêÔºåÂ∑≤Ëá™Âä®Ê∏ÖÁêÜÊóßÊ≠åÊõ≤');
                    }
                    
                    // Ê∏ÖÁêÜÊ≤°ÊúâURLÁöÑÊó†ÊïàÊ≠åÊõ≤
                    songs = songs.filter(song => song.url && song.url.trim() !== '');
                    
                    // Ê∏ÖÁêÜËøáÂ§ßÁöÑÂ∞ÅÈù¢Êï∞ÊçÆ
                    songs.forEach(song => {
                        if (song.cover && song.cover.length > 100 * 1024) {
                            // Â¶ÇÊûúÂ∞ÅÈù¢ËøáÂ§ßÔºåÁßªÈô§Â∞ÅÈù¢
                            delete song.cover;
                        }
                    });
                    
                    const songsData = JSON.stringify(songs);
                    console.log('ÂáÜÂ§á‰øùÂ≠òÁöÑÊ≠åÊõ≤Êï∞ÊçÆÂ§ßÂ∞è:', songsData.length, 'Â≠óÁ¨¶');
                    
                    // Ê£ÄÊü•Êï∞ÊçÆÂ§ßÂ∞èÊòØÂê¶Ë∂ÖÂá∫ÈôêÂà∂ (2MB)
                    if (songsData.length > 2 * 1024 * 1024) {
                        // Â¶ÇÊûúÊï∞ÊçÆ‰ªçÁÑ∂ËøáÂ§ßÔºåËøõ‰∏ÄÊ≠•Ê∏ÖÁêÜ
                        // ÁßªÈô§ÊâÄÊúâÂ∞ÅÈù¢Êï∞ÊçÆ
                        songs.forEach(song => {
                            delete song.cover;
                        });
                        
                        const retryData = JSON.stringify(songs);
                        if (retryData.length > 2 * 1024 * 1024) {
                            // Â¶ÇÊûú‰ªçÁÑ∂ËøáÂ§ßÔºåÈôêÂà∂Ê≠åÊõ≤Êï∞ÈáèÂà∞20È¶ñ
                            songs = songs.slice(0, 20);
                            const finalData = JSON.stringify(songs);
                            localStorage.setItem('musicSongs', finalData);
                        } else {
                            localStorage.setItem('musicSongs', retryData);
                        }
                    } else {
                        localStorage.setItem('musicSongs', songsData);
                    }
                    
                    console.log('Ê≠åÊõ≤Êï∞ÊçÆÂ∑≤‰øùÂ≠ò:', songs.length, 'È¶ñÊ≠åÊõ≤');
                } catch (e) {
                    console.error('‰øùÂ≠òÊ≠åÊõ≤Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
                    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                        // Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÊ∏ÖÁêÜÊâÄÊúâÊï∞ÊçÆ
                        try {
                            localStorage.clear();
                            songs = [];
                            renderSongsList();
                            alert('Â≠òÂÇ®Á©∫Èó¥‰∏•Èáç‰∏çË∂≥ÔºåÂ∑≤Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ');
                        } catch (clearError) {
                            console.error('Ê∏ÖÁ©∫Êï∞ÊçÆÂ§±Ë¥•:', clearError);
                            alert('Êó†Ê≥ï‰øùÂ≠òÊï∞ÊçÆÔºåËØ∑Ê∏ÖÁêÜÊµèËßàÂô®ÁºìÂ≠ò');
                        }
                    } else {
                        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï: ' + e.message);
                    }
                }
            }

            // Âä†ËΩΩÊ≠åÊõ≤Êï∞ÊçÆ
            function loadSongs() {
                console.log('ÂºÄÂßãÂä†ËΩΩÊ≠åÊõ≤Êï∞ÊçÆ...');
                try {
                    // Ê£ÄÊü•localStorageÊòØÂê¶ÂèØÁî®
                    if (typeof(Storage) === "undefined") {
                        console.error("ÊµèËßàÂô®‰∏çÊîØÊåÅlocalStorage");
                        songs = [];
                        renderSongsList();
                        return;
                    }
                    
                    const savedSongs = localStorage.getItem('musicSongs');
                    console.log('‰ªélocalStorageËé∑ÂèñÂà∞ÁöÑÊï∞ÊçÆÂ§ßÂ∞è:', savedSongs ? savedSongs.length : 0, 'Â≠óÁ¨¶');
                    if (savedSongs) {
                        const parsedSongs = JSON.parse(savedSongs);
                        console.log('Ëß£ÊûêÂêéÁöÑÊ≠åÊõ≤Êï∞ÊçÆ:', parsedSongs);
                        if (Array.isArray(parsedSongs)) {
                            // Á°Æ‰øùÊØèÈ¶ñÊ≠åÊõ≤ÈÉΩÊúâÂøÖË¶ÅÁöÑÂ≠óÊÆµ
                            songs = parsedSongs.map(song => ({
                                id: song.id || Date.now() + Math.random(),
                                title: song.title || 'Êú™Áü•Ê≠åÊõ≤',
                                artist: song.artist || 'Êú™Áü•Ê≠åÊâã',
                                url: song.url || '',
                                cover: song.cover || '',
                                lyrics: song.lyrics || '',
                                album: song.album || ''
                            })).filter(song => song.url && song.url.trim() !== ''); // ËøáÊª§ÊéâÊ≤°ÊúâURLÁöÑÊ≠åÊõ≤
                            console.log('Â∑≤Âä†ËΩΩÊ≠åÊõ≤Êï∞ÊçÆ:', songs.length, 'È¶ñÊ≠åÊõ≤');
                        } else {
                            console.error('Ëß£ÊûêÁöÑÊï∞ÊçÆ‰∏çÊòØÊï∞ÁªÑÊ†ºÂºè');
                            songs = [];
                        }
                    } else {
                        console.log('Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÊ≠åÊõ≤Êï∞ÊçÆ');
                        songs = [];
                    }
                } catch (e) {
                    console.error('Ëß£ÊûêÊ≠åÊõ≤Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
                    // Êï∞ÊçÆÊçüÂùèÔºåÊ∏ÖÁêÜÊçüÂùèÁöÑÊï∞ÊçÆ
                    try {
                        localStorage.removeItem('musicSongs');
                    } catch (removeError) {
                        console.error('Ê∏ÖÁêÜÊçüÂùèÊï∞ÊçÆÂ§±Ë¥•:', removeError);
                    }
                    songs = [];
                }
                renderSongsList();
            }

            // Ê∏≤ÊüìÊ≠åÊõ≤ÂàóË°®
            function renderSongsList() {
                const songsList = document.getElementById('songsList');
                songsList.innerHTML = '';
                
                console.log('Ê∏≤ÊüìÊ≠åÊõ≤ÂàóË°®ÔºåÂΩìÂâçÊ≠åÊõ≤Êï∞Èáè:', songs.length);
                
                songs.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'song-item';
                    if (index === currentSongIndex) {
                        songItem.classList.add('active');
                    }
                    songItem.innerHTML = `
                        <div class="song-info">
                            <div class="song-cover">
                                ${song.cover ? `<img src="${song.cover}" alt="${song.title}">` : 'üéµ'}
                            </div>
                            <div class="song-details">
                                <div class="song-title">${song.title}</div>
                                <div class="song-artist">${song.artist}</div>
                            </div>
                            <div class="song-actions" style="margin-left: auto; display: flex; align-items: center;">
                                <div class="menu-btn" onclick="event.stopPropagation(); openSongMenu(event, ${index})" style="padding: 5px; cursor: pointer;">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                                        <circle cx="12" cy="6" r="2"/>
                                        <circle cx="12" cy="12" r="2"/>
                                        <circle cx="12" cy="18" r="2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    `;
                    songItem.onclick = () => {
                        playSong(index);
                        // ÁÇπÂáªÊ≠åÊõ≤Êó∂ÊâìÂºÄÊí≠ÊîæÂô®È°µÈù¢
                        document.getElementById('playerPage').style.display = 'block';
                        document.getElementById('bottomPlayer').style.display = 'none';
                    };
                    songsList.appendChild(songItem);
                });
                
                console.log('Ê≠åÊõ≤ÂàóË°®Ê∏≤ÊüìÂÆåÊàê');
            }

            // ÂÖ®Â±ÄÂèòÈáèÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÊ≠åÊõ≤Á¥¢Âºï
            let currentSongIndexToDelete = -1;
            let currentSongIndexToEdit = -1;
            let tempEditCover = null;

            // ÊâìÂºÄÊ≠åÊõ≤ËèúÂçï
            function openSongMenu(event, index) {
                event.stopPropagation();
                
                // ÂàõÂª∫ËèúÂçïÂºπÁ™ó
                const menu = document.createElement('div');
                menu.className = 'song-menu';
                menu.style.cssText = `
                    position: fixed;
                    top: ${event.clientY}px;
                    left: ${event.clientX}px;
                    background: rgba(30, 30, 30, 0.95);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    border-radius: 10px;
                    padding: 10px 0;
                    z-index: 3000;
                    min-width: 120px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                `;
                menu.innerHTML = `
                    <div class="menu-item" onclick="editSong(${index})" style="padding: 10px 20px; cursor: pointer; color: white; font-size: 14px; white-space: nowrap;">ÁºñËæëÊ≠åÊõ≤</div>
                    <div class="menu-item" onclick="deleteSong(${index})" style="padding: 10px 20px; cursor: pointer; color: #ff3b30; font-size: 14px; white-space: nowrap; border-top: 1px solid rgba(255, 255, 255, 0.1);">Âà†Èô§Ê≠åÊõ≤</div>
                `;
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(menu);
                
                // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠ËèúÂçï
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        document.body.removeChild(menu);
                        document.removeEventListener('click', closeMenu);
                    }
                };
                
                // Á°Æ‰øùËèúÂçïÂú®ËßÜÁ™óÂÜÖ
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 10);
            }

            // Âà†Èô§Ê≠åÊõ≤
            function deleteSong(index) {
                currentSongIndexToDelete = index;
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            }

            // Á°ÆËÆ§Âà†Èô§Ê≠åÊõ≤
            function confirmDeleteSong() {
                if (currentSongIndexToDelete >= 0 && currentSongIndexToDelete < songs.length) {
                    songs.splice(currentSongIndexToDelete, 1);
                    saveSongs();
                    renderSongsList();
                    closeDeleteConfirmModal();
                    alert('Ê≠åÊõ≤Â∑≤Âà†Èô§ÔºÅ');
                }
            }

            // ÂÖ≥Èó≠Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó
            function closeDeleteConfirmModal() {
                document.getElementById('deleteConfirmModal').style.display = 'none';
                currentSongIndexToDelete = -1;
            }

            // ÁºñËæëÊ≠åÊõ≤
            function editSong(index) {
                currentSongIndexToEdit = index;
                const song = songs[index];
                
                // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
                document.getElementById('editSongTitle').value = song.title || '';
                document.getElementById('editSongArtist').value = song.artist || '';
                document.getElementById('editSongUrl').value = song.url || '';
                document.getElementById('editCoverUploadText').textContent = song.cover ? 'Â∞ÅÈù¢Â∑≤ÈÄâÊã©' : 'ÁÇπÂáªÈÄâÊã©Â∞ÅÈù¢ÂõæÁâá';
                
                // ‰øùÂ≠ò‰∏¥Êó∂Â∞ÅÈù¢
                tempEditCover = song.cover || null;
                
                // ÊòæÁ§∫ÁºñËæëÂºπÁ™ó
                document.getElementById('editSongModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠ÁºñËæëÊ≠åÊõ≤ÂºπÁ™ó
            function closeEditSongModal() {
                document.getElementById('editSongModal').style.display = 'none';
                currentSongIndexToEdit = -1;
                tempEditCover = null;
                
                // ÈáçÁΩÆË°®Âçï
                document.getElementById('editSongTitle').value = '';
                document.getElementById('editSongArtist').value = '';
                document.getElementById('editSongUrl').value = '';
                document.getElementById('editCoverUploadText').textContent = 'ÁÇπÂáªÈÄâÊã©Â∞ÅÈù¢ÂõæÁâá';
            }

            // Â§ÑÁêÜÁºñËæëÂ∞ÅÈù¢‰∏ä‰º†
            function handleEditCoverUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂‰∏∫500KB)
                    if (file.size > 500 * 1024) {
                        alert('ÂõæÁâáÊñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é500KBÁöÑÂõæÁâá');
                        return;
                    }
                    
                    // ÂéãÁº©ÂõæÁâá
                    compressImage(file, 0.6, 300, 300)
                        .then(compressedData => {
                            // Ê£ÄÊü•ÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÂ§ßÂ∞è
                            if (compressedData.length > 100 * 1024) {
                                alert('ÂõæÁâáÂéãÁº©Âêé‰ªçÁÑ∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©ËæÉÂ∞èÁöÑÂõæÁâá');
                                return;
                            }
                            tempEditCover = compressedData;
                            document.getElementById('editCoverUploadText').textContent = 'Â∞ÅÈù¢Â∑≤ÈÄâÊã©';
                        })
                        .catch(error => {
                            console.error('ÂõæÁâáÂéãÁº©Â§±Ë¥•:', error);
                            alert('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        });
                }
            }

            // ‰øùÂ≠òÁºñËæëÁöÑÊ≠åÊõ≤
            function saveEditSong() {
                const title = document.getElementById('editSongTitle').value.trim();
                const artist = document.getElementById('editSongArtist').value.trim();
                const url = document.getElementById('editSongUrl').value.trim();
                
                if (!title) {
                    alert('ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞');
                    return;
                }
                
                if (!url) {
                    alert('ËØ∑ËæìÂÖ•Ê≠åÊõ≤URL');
                    return;
                }
                
                // Ê£ÄÊü•URLÊòØÂê¶ÊúâÊïà
                if (!url.startsWith('http')) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊ≠åÊõ≤URLÔºà‰ª•httpÊàñhttpsÂºÄÂ§¥Ôºâ');
                    return;
                }
                
                if (currentSongIndexToEdit >= 0 && currentSongIndexToEdit < songs.length) {
                    // Êõ¥Êñ∞Ê≠åÊõ≤‰ø°ÊÅØ
                    songs[currentSongIndexToEdit].title = title;
                    songs[currentSongIndexToEdit].artist = artist || 'Êú™Áü•Ê≠åÊâã';
                    songs[currentSongIndexToEdit].url = url;
                    if (tempEditCover) {
                        songs[currentSongIndexToEdit].cover = tempEditCover;
                    }
                    
                    // ‰øùÂ≠òÂπ∂ÈáçÊñ∞Ê∏≤Êüì
                    saveSongs();
                    renderSongsList();
                    closeEditSongModal();
                    alert('Ê≠åÊõ≤‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
                }
            }

            // ÊâìÂºÄÊ∑ªÂä†Ê≠åÊõ≤ÂºπÁ™ó
            function openAddSongModal() {
                document.getElementById('addSongModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠Ê∑ªÂä†Ê≠åÊõ≤ÂºπÁ™ó
            function closeAddSongModal() {
                document.getElementById('addSongModal').style.display = 'none';
                // ÈáçÁΩÆË°®Âçï
                document.getElementById('songTitle').value = '';
                document.getElementById('songArtist').value = '';
                document.getElementById('songUrl').value = '';
                document.getElementById('coverUploadText').textContent = 'ÁÇπÂáªÈÄâÊã©Â∞ÅÈù¢ÂõæÁâá';
                tempCover = null;
            }

            // ÊâìÂºÄËÉåÊôØËÆæÁΩÆÂºπÁ™ó
            function openBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'flex';
            }

            // ÊâìÂºÄÊ≠åËØç‰∏ä‰º†ÂºπÁ™ó
            function openLyricsModal() {
                // Âä†ËΩΩÁé∞ÊúâÊ≠åËØç
                const song = songs[currentSongIndex];
                if (song && song.lyrics) {
                    document.getElementById('lyricsContentInput').value = song.lyrics;
                } else {
                    document.getElementById('lyricsContentInput').value = '';
                }
                document.getElementById('lyricsModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠Ê≠åËØç‰∏ä‰º†ÂºπÁ™ó
            function closeLyricsModal() {
                document.getElementById('lyricsModal').style.display = 'none';
            }

            // ‰øùÂ≠òÊ≠åËØç
            function saveLyrics() {
                const lyricsContent = document.getElementById('lyricsContentInput').value.trim();
                if (!lyricsContent) {
                    alert('ËØ∑ËæìÂÖ•Ê≠åËØçÂÜÖÂÆπ');
                    return;
                }

                // ‰øùÂ≠òÊ≠åËØçÂà∞ÂΩìÂâçÊ≠åÊõ≤
                if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    songs[currentSongIndex].lyrics = lyricsContent;
                    saveSongs();
                    renderLyrics(lyricsContent);
                }

                closeLyricsModal();
                alert('Ê≠åËØç‰øùÂ≠òÊàêÂäüÔºÅ');
            }

            // Ê∏≤ÊüìÊ≠åËØç
            function renderLyrics(lyricsContent) {
                const lyricsContainer = document.getElementById('lyricsContent');
                if (!lyricsContent) {
                    lyricsContainer.innerHTML = '<div class="lyrics-placeholder">ÁÇπÂáªÊ∑ªÂä†Ê≠åËØç</div>';
                    return;
                }

                // Ëß£ÊûêÊ≠åËØç
                const lines = lyricsContent.split('\n');
                let html = '';
                currentLyrics = [];
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    if (line) {
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊó∂Èó¥ËΩ¥ÔºàÊîØÊåÅÂ§öÁßçÊ†ºÂºèÔºâ
                        const timeMatch = line.match(/\[(\d{1,2}):(\d{2})[.:](\d{1,3})\](.*)/);
                        if (timeMatch) {
                            const minutes = parseInt(timeMatch[1]);
                            const seconds = parseInt(timeMatch[2]);
                            const centiseconds = parseInt(timeMatch[3]);
                            // Â§ÑÁêÜ‰∏çÂêåÁöÑÊØ´ÁßíÊ†ºÂºèÔºàÂèØËÉΩÊòØ1-3‰ΩçÊï∞Â≠óÔºâ
                            const milliseconds = centiseconds / Math.pow(10, timeMatch[3].length);
                            const text = timeMatch[4].trim();
                            const time = minutes * 60 + seconds + milliseconds;
                            currentLyrics.push({ time, text, index });
                            html += `<div class="lyric-line" data-time="${time}" data-index="${index}">${text}</div>`;
                        } else {
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ∫ØÊ≠åËØçË°åÔºàÊ≤°ÊúâÊó∂Èó¥Êà≥‰ΩÜ‰∏çÊòØÁ©∫Ë°åÔºâ
                            // ÂøΩÁï•‰∏Ä‰∫õÂÖÉ‰ø°ÊÅØË°å
                            if (!line.startsWith('ËØçÔºö') && !line.startsWith('Êõ≤Ôºö') && !line.startsWith('ÁºñÊõ≤Ôºö') && 
                                !line.startsWith('Âà∂‰Ωú‰∫∫Ôºö') && !line.startsWith('Ê∑∑Èü≥Ôºö') && !line.startsWith('ÂíåÂ£∞Ôºö') &&
                                !line.startsWith('Â∞ÅÈù¢Ôºö') && !line.startsWith('ÁªüÁ≠πÔºö') && !line.startsWith('Âá∫ÂìÅ‰∫∫Ôºö') &&
                                !line.startsWith('ÂèëË°åÔºö') && !line.startsWith('Âà∂‰ΩúÂÖ¨Âè∏Ôºö') && !line.startsWith('opÔºö')) {
                                // Ê≤°ÊúâÊó∂Èó¥ËΩ¥ÁöÑÊ≠åËØç
                                currentLyrics.push({ time: index * 3, text: line, index });
                                html += `<div class="lyric-line" data-time="${index * 3}" data-index="${index}">${line}</div>`;
                            }
                        }
                    }
                });

                lyricsContainer.innerHTML = html;
                
                // Â¶ÇÊûúÊúâÊ≠åËØçÔºåÊøÄÊ¥ªÁ¨¨‰∏ÄË°å
                if (currentLyrics.length > 0) {
                    updateLyricsHighlight(0);
                }
            }

            // Êõ¥Êñ∞Ê≠åËØçÈ´ò‰∫Æ
            function updateLyricsHighlight(currentTime) {
                const lyricsContainer = document.getElementById('lyricsContent');
                const lines = lyricsContainer.querySelectorAll('.lyric-line');
                
                // ÁßªÈô§ÊâÄÊúâÈ´ò‰∫Æ
                lines.forEach(line => {
                    line.classList.remove('active');
                });
                
                // ÊâæÂà∞ÂΩìÂâçÂ∫îËØ•È´ò‰∫ÆÁöÑË°å
                let activeIndex = 0;
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentLyrics[i].time <= currentTime) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }
                
                // È´ò‰∫ÆÂΩìÂâçË°å
                if (lines[activeIndex]) {
                    lines[activeIndex].classList.add('active');
                    
                    // ÊªöÂä®Âà∞ÂΩìÂâçË°åÔºå‰ΩøÂÖ∂Âú®ÂÆπÂô®‰∏≠Èó¥‰ΩçÁΩÆ
                    const containerHeight = lyricsContainer.parentElement.clientHeight;
                    const totalLines = lines.length;
                    const lineHeight = 24; // ‰∏éCSS‰∏≠.lyric-lineÁöÑÈ´òÂ∫¶‰∏ÄËá¥
                    
                    // ËÆ°ÁÆóÈúÄË¶ÅÊªöÂä®ÁöÑÂÅèÁßªÈáèÔºå‰ΩøÂΩìÂâçË°åÂ±Ö‰∏≠ÊòæÁ§∫
                    const offset = activeIndex * lineHeight - containerHeight / 2 + lineHeight / 2;
                    
                    // ÈôêÂà∂ÊªöÂä®ËåÉÂõ¥ÔºåÈÅøÂÖçÊªöÂä®ËøáÂ∫¶
                    const maxOffset = Math.max(0, (totalLines * lineHeight) - containerHeight);
                    const minOffset = 0;
                    const finalOffset = Math.max(minOffset, Math.min(offset, maxOffset));
                    
                    lyricsContainer.style.transform = `translateY(-${finalOffset}px)`;
                }
            }

            // ÊâìÂºÄÈü≥‰πêÈ°µÈù¢ËÉåÊôØËÆæÁΩÆÂºπÁ™ó
            function openMusicBackgroundModal() {
                document.getElementById('musicBackgroundModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠Èü≥‰πêÈ°µÈù¢ËÉåÊôØËÆæÁΩÆÂºπÁ™ó
            function closeMusicBackgroundModal() {
                document.getElementById('musicBackgroundModal').style.display = 'none';
                document.getElementById('musicBackgroundUploadText').textContent = 'ÁÇπÂáªÈÄâÊã©Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂõæÁâá';
                tempMusicBackground = null;
            }

            // ÊâìÂºÄÊí≠ÊîæÂô®È°µÈù¢ËÉåÊôØËÆæÁΩÆÂºπÁ™ó
            function openPlayerBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'flex';
            }

            // ÂÖ≥Èó≠Êí≠ÊîæÂô®È°µÈù¢ËÉåÊôØËÆæÁΩÆÂºπÁ™ó
            function closeBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'none';
                document.getElementById('playerBackgroundUploadText').textContent = 'ÁÇπÂáªÈÄâÊã©Êí≠ÊîæÂô®ËÉåÊôØÂõæÁâá';
                document.getElementById('togetherBackgroundUploadText').textContent = 'ÁÇπÂáªÈÄâÊã©‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØÂõæÁâá';
                tempPlayerBackground = null;
                tempTogetherBackground = null;
            }

            // Â§ÑÁêÜÊí≠ÊîæÂô®ËÉåÊôØ‰∏ä‰º†
            function handlePlayerBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempPlayerBackground = e.target.result;
                        document.getElementById('playerBackgroundUploadText').textContent = 'Êí≠ÊîæÂô®ËÉåÊôØÂ∑≤ÈÄâÊã©';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Â§ÑÁêÜ‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØ‰∏ä‰º†
            function handleTogetherBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempTogetherBackground = e.target.result;
                        document.getElementById('togetherBackgroundUploadText').textContent = '‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØÂ∑≤ÈÄâÊã©';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Â§ÑÁêÜÈü≥‰πêÈ°µÈù¢ËÉåÊôØ‰∏ä‰º†
            function handleMusicBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempMusicBackground = e.target.result;
                        document.getElementById('musicBackgroundUploadText').textContent = 'Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂ∑≤ÈÄâÊã©';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // ‰øùÂ≠òÈü≥‰πêÈ°µÈù¢ËÉåÊôØ
            function saveMusicBackground() {
                if (!tempMusicBackground) {
                    alert('ËØ∑ÈÄâÊã©Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂõæÁâá');
                    return;
                }
                
                try {
                    localStorage.setItem('musicPageBackground', tempMusicBackground);
                    applyMusicBackground(tempMusicBackground);
                    closeMusicBackgroundModal();
                    alert('Èü≥‰πêÈ°µÈù¢ËÉåÊôØËÆæÁΩÆÊàêÂäüÔºÅ');
                } catch (e) {
                    console.error('‰øùÂ≠òÈü≥‰πêÈ°µÈù¢ËÉåÊôØÊó∂Âá∫Èîô:', e);
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }

            // ‰øùÂ≠òÊí≠ÊîæÂô®È°µÈù¢ËÉåÊôØ
            function savePlayerBackground() {
                if (!tempPlayerBackground && !tempTogetherBackground) {
                    alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ËÉåÊôØÂõæÁâá');
                    return;
                }
                
                try {
                    // ‰øùÂ≠òÊí≠ÊîæÂô®ËÉåÊôØ
                    if (tempPlayerBackground) {
                        localStorage.setItem('playerBackground', tempPlayerBackground);
                        applyPlayerBackground(tempPlayerBackground);
                    }
                    
                    // ‰øùÂ≠ò‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØ
                    if (tempTogetherBackground) {
                        localStorage.setItem('togetherBackground', tempTogetherBackground);
                        applyTogetherBackground(tempTogetherBackground);
                    }
                    
                    closeBackgroundModal();
                    alert('Êí≠ÊîæÂô®ËÉåÊôØËÆæÁΩÆÊàêÂäüÔºÅ');
                    console.log('ËÉåÊôØÂ∑≤‰øùÂ≠ò');
                } catch (e) {
                    console.error('‰øùÂ≠òËÉåÊôØÊó∂Âá∫Èîô:', e);
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }

            // Âä†ËΩΩËÉåÊôØ
            function loadBackground() {
                try {
                    // Âä†ËΩΩÈü≥‰πêÈ°µÈù¢ËÉåÊôØ
                    const savedMusicBackground = localStorage.getItem('musicPageBackground');
                    if (savedMusicBackground) {
                        applyMusicBackground(savedMusicBackground);
                        console.log('Èü≥‰πêÈ°µÈù¢ËÉåÊôØÂ∑≤Âä†ËΩΩ');
                    } else {
                        console.log('Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÈü≥‰πêÈ°µÈù¢ËÉåÊôØ');
                    }
                    
                    // Âä†ËΩΩÊí≠ÊîæÂô®ËÉåÊôØ
                    const savedPlayerBackground = localStorage.getItem('playerBackground');
                    if (savedPlayerBackground) {
                        applyPlayerBackground(savedPlayerBackground);
                        console.log('Êí≠ÊîæÂô®ËÉåÊôØÂ∑≤Âä†ËΩΩ');
                    } else {
                        console.log('Êú™ÊâæÂà∞‰øùÂ≠òÁöÑÊí≠ÊîæÂô®ËÉåÊôØ');
                    }
                    
                    // Âä†ËΩΩ‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØ
                    const savedTogetherBackground = localStorage.getItem('togetherBackground');
                    if (savedTogetherBackground) {
                        applyTogetherBackground(savedTogetherBackground);
                        console.log('‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØÂ∑≤Âä†ËΩΩ');
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩËÉåÊôØÊó∂Âá∫Èîô:', e);
                }
            }

            // Â∫îÁî®Èü≥‰πêÈ°µÈù¢ËÉåÊôØ
            function applyMusicBackground(backgroundData) {
                if (backgroundData) {
                    // Â∫îÁî®Âà∞Èü≥‰πêÈ°µÈù¢ÔºàbodyÂÖÉÁ¥†Ôºâ
                    document.body.style.background = `url(${backgroundData}) center/cover no-repeat, linear-gradient(135deg, #1a1a1a, #000)`;
                }
            }

            // Â∫îÁî®Êí≠ÊîæÂô®ËÉåÊôØ
            function applyPlayerBackground(backgroundData) {
                if (backgroundData) {
                    // Âè™Âú®Êí≠ÊîæÂô®È°µÈù¢Â∫îÁî®ËÉåÊôØ
                    const playerPage = document.getElementById('playerPage');
                    if (playerPage) {
                        playerPage.style.background = `url(${backgroundData}) center/cover no-repeat, linear-gradient(135deg, #1a1a1a, #000)`;
                    }
                }
            }

            // Â∫îÁî®‰∏ÄËµ∑Âê¨Ê≠åËÉåÊôØ
            function applyTogetherBackground(backgroundData) {
                const togetherModal = document.querySelector('.together-modal');
                if (togetherModal && backgroundData) {
                    togetherModal.style.background = `url(${backgroundData}) center/cover no-repeat`;
                    // ‰øùÁïôÂéüÊúâÁöÑËÉåÊôØËâ≤ÂíåÈÄèÊòéÂ∫¶
                    togetherModal.style.backgroundBlendMode = 'overlay';
                }
            }

            // ‰øùÂ≠ò‰∏ÄËµ∑Âê¨Ê≠åÊó∂Èïø
            function saveTogetherDuration() {
                try {
                    const data = {
                        totalDuration: totalTogetherDuration + togetherDuration,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('togetherDuration', JSON.stringify(data));
                } catch (e) {
                    console.error('‰øùÂ≠ò‰∏ÄËµ∑Âê¨Ê≠åÊó∂ÈïøÊó∂Âá∫Èîô:', e);
                }
            }

            // Âä†ËΩΩ‰∏ÄËµ∑Âê¨Ê≠åÊó∂Èïø
            function loadTogetherDuration() {
                try {
                    const savedData = localStorage.getItem('togetherDuration');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        totalTogetherDuration = data.totalDuration || 0;
                        
                        // Êõ¥Êñ∞ÊòæÁ§∫
                        updateTogetherDurationDisplay();
                    }
                } catch (e) {
                    console.error('Âä†ËΩΩ‰∏ÄËµ∑Âê¨Ê≠åÊó∂ÈïøÊó∂Âá∫Èîô:', e);
                }
            }

            // Êõ¥Êñ∞‰∏ÄËµ∑Âê¨Ê≠åÊó∂ÈïøÊòæÁ§∫
            function updateTogetherDurationDisplay() {
                const totalDuration = totalTogetherDuration + togetherDuration;
                const seconds = Math.floor(totalDuration / 1000) % 60;
                const minutes = Math.floor(totalDuration / (1000 * 60)) % 60;
                const hours = Math.floor(totalDuration / (1000 * 60 * 60));
                
                document.getElementById('togetherDuration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÊó∂Èïø
            window.addEventListener('beforeunload', function() {
                // ÂÅúÊ≠¢ËÆ°Êó∂Âô®Âπ∂‰øùÂ≠òÊó∂Èïø
                stopTogetherTimer();
            });

            // ÂàáÊç¢‰∏ÄËµ∑Âê¨Ê≠åÂºπÁ™ó
            function toggleTogether() {
                const togetherModal = document.getElementById('togetherModal');
                const togetherModalElement = togetherModal.querySelector('.together-modal');
                togetherModalElement.classList.toggle('open');
                
                if (togetherModalElement.classList.contains('open')) {
                    togetherModal.style.display = 'block';
                    // ÂºÄÂßãËÆ°Êó∂
                    startTogetherTimer();
                } else {
                    togetherModal.style.display = 'none';
                    // ÂÅúÊ≠¢ËÆ°Êó∂
                    stopTogetherTimer();
                }
            }
        </script>
    </div>
</body>
</html>
