<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .phone {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 状态栏样式 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 44px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-size: 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .status-left, .status-center, .status-right {
            display: flex;
            align-items: center;
        }

        .status-left {
            flex: 1;
        }

        .status-center {
            flex: 2;
            justify-content: center;
        }

        .status-right {
            flex: 1;
            justify-content: flex-end;
        }

        .status-icon {
            width: 18px;
            height: 18px;
            margin: 0 5px;
        }

        /* 头部导航栏 */
        .header {
            display: flex;
            align-items: center;
            padding: 0 15px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            top: 44px;
            left: 0;
            right: 0;
            z-index: 999;
        }

        .back-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .back-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .header-content {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        /* 头部右侧按钮 */
        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .playlist-btn svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* 内容区域 */
        .content {
            flex: 1;
            padding: 110px 15px 80px 15px;
            overflow-y: auto;
        }

        /* 歌曲列表 */
        .songs-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .song-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .song-item.active {
            background: rgba(0, 122, 255, 0.3);
            border-color: rgba(0, 122, 255, 0.5);
        }

        .song-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .song-cover {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .song-details {
            flex: 1;
        }

        .song-details .song-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-details .song-artist {
            font-size: 14px;
            color: #aaa;
        }

        /* 底部播放栏 */
        .bottom-player {
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            height: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            z-index: 998;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .player-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
        }

        .player-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .player-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-artist {
            font-size: 14px;
            color: #aaa;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 18px;
        }

        .control-btn.play-pause {
            width: 55px;
            height: 55px;
            background: #007AFF;
        }

        /* 播放器页面 */
        .player-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #000);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .player-content {
            flex: 1;
            padding: 120px 15px 20px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 专辑封面区域 */
        .album-art-container {
            width: 200px;
            height: 200px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 歌曲信息 */
        .player-content .song-info {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .player-content .song-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .player-content .song-artist {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 2px;
            text-align: center;
        }

        .song-album {
            font-size: 14px;
            color: #888;
        }

        /* 歌词显示区域 */
        .lyrics-container {
            width: 100%;
            max-width: 350px;
            height: 100px;
            margin: 5px auto;
            overflow: hidden;
            position: relative;
            text-align: center;
        }

        .lyrics-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            transition: transform 0.3s ease;
        }

        .lyric-line {
            height: 24px;
            line-height: 24px;
            font-size: 14px;
            color: #aaa;
            transition: all 0.3s ease;
            padding: 2px 0;
        }

        .lyric-line.active {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .lyrics-placeholder {
            height: 24px;
            line-height: 24px;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            max-width: 350px;
            margin-bottom: 30px;
            margin-top: 20px;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-filled {
            height: 100%;
            background: #007AFF;
            width: 0%;
            border-radius: 5px;
            transition: width 0.1s linear;
        }

        /* 控制按钮 */
        .control-buttons {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 20px;
        }

        .control-btn.play-pause {
            width: 55px;
            height: 55px;
            background: #007AFF;
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .control-btn.play-pause svg {
            width: 24px;
            height: 24px;
        }

        /* 播放列表样式 */
        .playlist-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            z-index: 2001;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .playlist-drag-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 0 auto 15px auto;
        }

        .playlist-modal.open {
            transform: translateY(0);
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .playlist-title {
            font-size: 18px;
            font-weight: bold;
        }

        .playlist-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(0, 122, 255, 0.3);
        }

        .playlist-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .playlist-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: #aaa;
        }

        .playlist-item-duration {
            font-size: 12px;
            color: #aaa;
            min-width: 30px;
            text-align: right;
        }

        /* 在小屏幕上调整播放列表样式 */
        @media (max-width: 768px) {
            .playlist-modal {
                padding: 15px;
            }
            
            .playlist-item {
                gap: 10px;
                padding: 8px;
            }
            
            .playlist-item-cover {
                width: 35px;
                height: 35px;
            }
            
            .playlist-item-title {
                font-size: 13px;
            }
            
            .playlist-item-artist, .playlist-item-duration {
                font-size: 11px;
            }
            
            .playlist-item-duration {
                min-width: 30px;
                text-align: right;
            }
        }

        /* 自定义弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* 播放列表遮罩层 */
        #playlistOverlay {
            z-index: 2000;
        }

        /* 播放列表弹窗 */
        #playlistModal {
            z-index: 2001;
        }

        /* 一起听歌弹窗 */
        .together-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 20px;
            z-index: 2001;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .together-modal.open {
            transform: translateY(0);
        }

        .together-drag-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 0 auto 15px auto;
        }

        .together-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .together-title {
            font-size: 18px;
            font-weight: bold;
        }

        .together-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
        }

        .avatar-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .avatar-placeholder {
            font-size: 30px;
            line-height: 60px;
        }

        .heartbeat-area {
            width: 80px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .heart-icon {
            width: 50px;
            height: 50px;
            animation: heartbeat 1.2s ease-in-out infinite;
            position: relative;
            z-index: 3;
        }

        .heart-icon svg {
            width: 100%;
            height: 100%;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            5% { transform: scale(1.1); }
            10% { transform: scale(1); }
        }

        .menu-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 删除确认弹窗样式 */
        #deleteConfirmModal .modal-content {
            max-width: 300px;
        }

        #deleteConfirmModal .form-group p {
            text-align: center;
            margin: 20px 0;
            color: #fff;
        }

        /* 编辑歌曲弹窗样式 */
        #editSongModal .modal-content {
            max-width: 400px;
        }

        /* 创建爱心形状的发光效果 */
        .heart-icon::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z' fill='red'/%3E%3C/svg%3E") center/contain no-repeat;
            z-index: -1;
            animation: pulse 1.2s ease-in-out infinite;
            filter: blur(15px);
            opacity: 0.7;
        }

        /* 创建心电图脉冲折线效果 */
        .ecg-line {
            position: absolute;
            width: 100%;
            height: 60px;
            top: 50%;
            transform: translateY(-50%);
            overflow: hidden;
        }

        /* 使用SVG创建心电图折线 */
        .ecg-line::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60'%3E%3Cpath d='M0,30 L20,30 L30,10 L40,50 L50,30 L70,30 L80,15 L90,45 L100,30 L120,30 L130,20 L140,40 L150,30 L170,30 L180,25 L190,35 L200,30' stroke='red' stroke-width='2' fill='none' stroke-dasharray='1000' stroke-dashoffset='1000'%3E%3Canimate attributeName='stroke-dashoffset' from='1000' to='0' dur='2s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
            background-repeat: repeat-x;
            animation: ecgMove 2s linear infinite;
            filter: drop-shadow(0 0 4px rgba(255, 0, 0, 0.7));
        }

        @keyframes ecgMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100px); }
        }

        /* 心跳动画增强 */
        @keyframes pulse {
            0% { 
                transform: scale(1);
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.8);
                opacity: 0.4;
            }
            100% { 
                transform: scale(1);
                opacity: 0.7;
            }
        }

        .avatar-label {
            text-align: center;
            font-size: 14px;
            color: #aaa;
            margin-top: 10px;
        }

        .avatar-item {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .duration-stats {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .duration-label {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .duration-value {
            font-size: 18px;
            font-weight: bold;
        }

        .chat-section {
            margin-top: 20px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* 聊天输入区域容器 */
        .chat-input-container {
            display: flex;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 25px;
            padding: 6px 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
        }

        /* 聊天输入框 */
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
            min-height: 20px;
        }

        .chat-input:focus {
            outline: none;
        }

        /* 聊天按钮通用样式 */
        .chat-send-btn, .chat-ai-btn, .chat-settings-btn {
            padding: 8px 12px;
            border-radius: 18px;
            background: rgba(0, 122, 255, 0.3);
            border: 1px solid rgba(0, 122, 255, 0.5);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 500;
            min-width: 50px;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover, .chat-ai-btn:hover, .chat-settings-btn:hover {
            background: rgba(0, 122, 255, 0.5);
            transform: scale(1.05);
        }

        /* AI回复按钮 */
        .chat-ai-btn {
            background: rgba(10, 132, 255, 0.3);
            border: 1px solid rgba(10, 132, 255, 0.5);
        }

        .chat-ai-btn:hover {
            background: rgba(10, 132, 255, 0.5);
        }

        /* 聊天设置按钮 */
        .chat-settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 10px;
            margin-left: 5px;
        }

        .chat-settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 聊天设置按钮内的SVG图标 */
        .chat-settings-btn svg {
            width: 18px;
            height: 18px;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .chat-input-container {
                gap: 6px;
                padding: 5px 10px;
                border-radius: 22px;
            }
            
            .chat-input {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .chat-send-btn, .chat-ai-btn, .chat-settings-btn {
                padding: 6px 10px;
                border-radius: 16px;
                font-size: 12px;
                min-width: 45px;
            }
            
            .chat-settings-btn {
                padding: 6px 8px;
                margin-left: 4px;
            }
            
            .chat-settings-btn svg {
                width: 16px;
                height: 16px;
            }
        }

        /* 小屏幕设备进一步优化 */
        @media (max-width: 480px) {
            .chat-input-container {
                gap: 5px;
                padding: 4px 8px;
                border-radius: 20px;
            }
            
            .chat-input {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .chat-send-btn, .chat-ai-btn {
                padding: 5px 8px;
                border-radius: 15px;
                font-size: 11px;
                min-width: 40px;
            }
            
            .chat-settings-btn {
                padding: 5px 6px;
                border-radius: 15px;
                margin-left: 3px;
            }
            
            .chat-settings-btn svg {
                width: 14px;
                height: 14px;
            }
        }

        /* 聊天消息样式 */
        .message-container {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-end;
        }

        .message-container.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            position: relative;
        }

        /* 用户消息气泡 */
        .message-container.sent .message-bubble {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* AI消息气泡 */
        .message-container.received .message-bubble {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.1));
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .message-sender {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 10px;
            color: #888;
        }

        .message-content {
            font-size: 14px;
        }

        /* 角色选择弹窗 */
        .character-modal {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .character-item {
            text-align: center;
            cursor: pointer;
        }

        .character-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            overflow: hidden;
        }

        .character-name {
            font-size: 12px;
            color: #aaa;
        }

        /* 用户设置弹窗 */
        .user-modal {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .user-modal .form-group {
            margin-bottom: 20px;
        }

        .user-modal .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .user-modal .form-input, .user-modal .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .user-modal .form-input:focus, .user-modal .form-textarea:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .user-modal .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-modal .upload-area:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(0, 122, 255, 0.05);
        }

        .user-modal .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .user-modal .upload-text {
            font-size: 14px;
            color: #aaa;
        }

        .user-modal .hidden-file-input {
            display: none;
        }

        .user-modal .submit-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(45deg, #007AFF, #0A84FF);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-modal .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }



        .playlist-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-item.active {
            background: rgba(0, 122, 255, 0.3);
        }

        .playlist-item-cover {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            overflow: hidden;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .playlist-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-item-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 12px;
            color: #aaa;
        }

        .playlist-item-duration {
            font-size: 12px;
            color: #aaa;
            min-width: 30px;
            text-align: right;
        }

        .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(0, 122, 255, 0.05);
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: #aaa;
        }

        .hidden-file-input {
            display: none;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            background: linear-gradient(45deg, #007AFF, #0A84FF);
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(10, 132, 255, 0.4);
        }

        /* 播放按钮SVG */
        .play-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .pause-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .prev-icon, .next-icon {
            width: 20px;
            height: 20px;
            fill: white;
        }
    </style>
</head>
<body>
    <div class="phone">
        <!-- 隐藏的音频播放器 -->
        <audio id="audioPlayer" style="display: none;"></audio>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-left">
                <span class="time" id="current-time">00:00</span>
            </div>
            <div class="status-center">
                <!-- 中间留空 -->
            </div>
            <div class="status-right">
                <!-- 信号图标 -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 17L5 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 17L12 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <path d="M19 17L19 2" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <!-- 电池图标 -->
                <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="7" width="16" height="10" rx="3" stroke="white" stroke-width="2"/>
                    <path d="M20 10V14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <rect x="4" y="9" width="12" height="6" rx="2" fill="white"/>
                </svg>
            </div>
        </div>

        <!-- 头部导航栏 -->
        <div class="header">
            <div class="back-btn" onclick="goBack()">
                <svg viewBox="0 0 24 24">
                    <path d="M20 11H7.83l5.59-7.03L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                </svg>
            </div>
            <div class="header-content">
                音乐
            </div>
            <div class="header-actions" style="margin-left: auto; display: flex; gap: 15px;">
                <!-- 加号按钮 -->
                <div class="header-btn" onclick="openAddSongModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="white"/>
                    </svg>
                </div>
                <!-- 星星按钮 -->
                <div class="header-btn" onclick="openMusicBackgroundModal()">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="white"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <div class="songs-list" id="songsList">
                <!-- 歌曲列表将在这里动态生成 -->
            </div>
        </div>

        <!-- 底部播放栏 -->
        <div class="bottom-player" id="bottomPlayer" onclick="openPlayer(event)">
            <div class="player-cover">
                <img id="playerCover" src="" alt="专辑封面">
            </div>
            <div class="player-info">
                <div class="player-title" id="playerTitle">暂无播放</div>
                <div class="player-artist" id="playerArtist"></div>
            </div>
            <div class="player-controls">
                <button class="control-btn" onclick="prevSong(event)">
                    <svg class="prev-icon" viewBox="0 0 24 24">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                    </svg>
                </button>
                <button class="control-btn play-pause" onclick="togglePlay(event)">
                    <svg class="play-icon" viewBox="0 0 24 24" id="playIcon">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" id="pauseIcon" style="display: none;">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V6h-4z"/>
                    </svg>
                </button>
                <button class="control-btn" onclick="nextSong(event)">
                    <svg class="next-icon" viewBox="0 0 24 24">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 播放器页面 -->
        <div class="player-page" id="playerPage" style="display: none;">
            <!-- 头部导航栏 -->
            <div class="header">
                <div class="back-btn" onclick="closePlayer()">
                    <svg viewBox="0 0 24 24">
                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="white"/>
                    </svg>
                </div>
                <div class="header-content" id="playerHeaderTitle">
                    播放器
                </div>
                <div class="header-actions" style="margin-left: auto; display: flex; gap: 15px;">
                    <!-- 爱心按钮 -->
                    <div class="header-btn" onclick="toggleFavorite()">
                        <svg viewBox="0 0 24 24" id="favoriteIcon" width="18" height="18">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="white"/>
                        </svg>
                    </div>
                    <!-- 星星按钮 -->
                    <div class="header-btn" onclick="openPlayerBackgroundModal()">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="white"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- 播放器内容区域 -->
            <div class="player-content">
                <!-- 专辑封面 -->
                <div class="album-art-container">
                    <div class="album-art" id="playerAlbumArt">
                        <div style="font-size: 80px;">🎵</div>
                    </div>
                </div>

                <!-- 歌曲信息 -->
                <div class="song-info">
                    <div class="song-title" id="playerSongTitle">暂无播放</div>
                    <div class="song-artist" id="playerSongArtist"></div>
                    <div class="song-album" id="playerSongAlbum"></div>
                </div>

                <!-- 歌词显示区域 -->
                <div class="lyrics-container" onclick="openLyricsModal()">
                    <div class="lyrics-content" id="lyricsContent">
                        <div class="lyrics-placeholder">点击添加歌词</div>
                    </div>
                </div>

                <!-- 进度条 -->
                <div class="progress-container">
                    <div class="progress-time">
                        <span id="playerCurrentTime">00:00</span>
                        <span id="playerDuration">00:00</span>
                    </div>
                    <div class="progress-bar" id="playerProgressBar" onclick="playerSeek(event)">
                        <div class="progress-filled" id="playerProgressFilled"></div>
                    </div>
                </div>

                <!-- 控制按钮 -->
                <div class="control-buttons">
                    <button class="control-btn" onclick="toggleRepeatMode()">
                        <svg viewBox="0 0 24 24" id="repeatIcon">
                            <path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 12h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z" fill="white"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="prevSong()">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                        </svg>
                    </button>
                    <button class="control-btn play-pause" onclick="togglePlay()" style="width: 55px; height: 55px;">
                        <svg viewBox="0 0 24 24" id="playerPlayIcon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg viewBox="0 0 24 24" id="playerPauseIcon" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V6h-4z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="nextSong()">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                        </svg>
                    </button>
                    <button class="control-btn" onclick="togglePlaylist()">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" fill="white"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 添加歌曲弹窗 -->
        <div class="modal" id="addSongModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">添加歌曲</div>
                    <button class="modal-close" onclick="closeAddSongModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">歌曲名称</label>
                    <input type="text" class="form-input" id="songTitle" placeholder="请输入歌曲名称">
                </div>
                <div class="form-group">
                    <label class="form-label">歌手</label>
                    <input type="text" class="form-input" id="songArtist" placeholder="请输入歌手名称">
                </div>
                <div class="form-group">
                    <label class="form-label">歌曲URL</label>
                    <input type="text" class="form-input" id="songUrl" placeholder="请输入歌曲URL">
                </div>
                <div class="form-group">
                    <label class="form-label">专辑封面</label>
                    <div class="upload-area" onclick="document.getElementById('coverUpload').click()">
                        <div class="upload-icon">🎵</div>
                        <div class="upload-text" id="coverUploadText">点击选择封面图片</div>
                    </div>
                    <input type="file" id="coverUpload" class="hidden-file-input" accept="image/*" onchange="handleCoverUpload(event)">
                </div>
                <button class="submit-btn" onclick="addSong()">添加歌曲</button>
            </div>
        </div>

        <!-- 删除确认弹窗 -->
        <div class="modal" id="deleteConfirmModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">确认删除</div>
                    <button class="modal-close" onclick="closeDeleteConfirmModal()">&times;</button>
                </div>
                <div class="form-group">
                    <p>确定要删除这首歌曲吗？此操作不可撤销。</p>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <button class="submit-btn" onclick="confirmDeleteSong()" style="flex: 1; background: #ff3b30;">确定删除</button>
                    <button class="submit-btn" onclick="closeDeleteConfirmModal()" style="flex: 1; background: #007AFF;">取消</button>
                </div>
            </div>
        </div>

        <!-- 编辑歌曲弹窗 -->
        <div class="modal" id="editSongModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">编辑歌曲</div>
                    <button class="modal-close" onclick="closeEditSongModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">歌曲名称</label>
                    <input type="text" class="form-input" id="editSongTitle" placeholder="请输入歌曲名称">
                </div>
                <div class="form-group">
                    <label class="form-label">歌手</label>
                    <input type="text" class="form-input" id="editSongArtist" placeholder="请输入歌手名称">
                </div>
                <div class="form-group">
                    <label class="form-label">歌曲URL</label>
                    <input type="text" class="form-input" id="editSongUrl" placeholder="请输入歌曲URL">
                </div>
                <div class="form-group">
                    <label class="form-label">专辑封面</label>
                    <div class="upload-area" onclick="document.getElementById('editCoverUpload').click()">
                        <div class="upload-icon">🎵</div>
                        <div class="upload-text" id="editCoverUploadText">点击选择封面图片</div>
                    </div>
                    <input type="file" id="editCoverUpload" class="hidden-file-input" accept="image/*" onchange="handleEditCoverUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveEditSong()">保存更改</button>
            </div>
        </div>

        <!-- 音乐页面背景设置弹窗 -->
        <div class="modal" id="musicBackgroundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">设置音乐页面背景</div>
                    <button class="modal-close" onclick="closeMusicBackgroundModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">音乐页面背景图片</label>
                    <div class="upload-area" onclick="document.getElementById('musicBackgroundUpload').click()">
                        <div class="upload-icon">🖼️</div>
                        <div class="upload-text" id="musicBackgroundUploadText">点击选择音乐页面背景图片</div>
                    </div>
                    <input type="file" id="musicBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handleMusicBackgroundUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveMusicBackground()">保存背景</button>
            </div>
        </div>
        
        <!-- 背景设置弹窗（播放器页面专用） -->
        <div class="modal" id="backgroundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">设置播放器背景</div>
                    <button class="modal-close" onclick="closeBackgroundModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">播放器背景图片</label>
                    <div class="upload-area" onclick="document.getElementById('playerBackgroundUpload').click()">
                        <div class="upload-icon">🖼️</div>
                        <div class="upload-text" id="playerBackgroundUploadText">点击选择播放器背景图片</div>
                    </div>
                    <input type="file" id="playerBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handlePlayerBackgroundUpload(event)">
                </div>
                <div class="form-group">
                    <label class="form-label">一起听歌背景图片</label>
                    <div class="upload-area" onclick="document.getElementById('togetherBackgroundUpload').click()">
                        <div class="upload-icon">🖼️</div>
                        <div class="upload-text" id="togetherBackgroundUploadText">点击选择一起听歌背景图片</div>
                    </div>
                    <input type="file" id="togetherBackgroundUpload" class="hidden-file-input" accept="image/*" onchange="handleTogetherBackgroundUpload(event)">
                </div>
                <button class="submit-btn" onclick="savePlayerBackground()">保存背景</button>
            </div>
        </div>

        <!-- 播放列表遮罩层 -->
        <div class="modal" id="playlistOverlay" onclick="togglePlaylist()"></div>
        <!-- 播放列表弹窗 -->
        <div class="playlist-modal" id="playlistModal">
            <div class="playlist-drag-handle"></div>
            <div class="playlist-header">
                <div class="playlist-title">播放列表</div>
                <button class="playlist-close" onclick="togglePlaylist()">&times;</button>
            </div>
            <div class="playlist-list" id="playlistList">
                <!-- 播放列表项将在这里动态生成 -->
            </div>
        </div>

        <!-- 一起听歌弹窗 -->
        <div class="modal" id="togetherModal">
            <div class="together-modal">
                <div class="together-drag-handle"></div>
                <div class="together-header">
                    <div class="together-title">一起听歌</div>
                    <button class="together-close" onclick="toggleTogether()">&times;</button>
                </div>
                <div class="together-content">
                    <!-- 头像区域 -->
                    <div class="avatar-section">
                        <div class="avatar-container">
                            <!-- 头像1 -->
                            <div class="avatar-item">
                                <div class="avatar avatar-left" onclick="openCharacterModal()">
                                    <div class="avatar-img" id="characterAvatar">
                                        <div class="avatar-placeholder">👤</div>
                                    </div>
                                </div>
                                <div class="avatar-label" id="characterName">选择角色</div>
                            </div>
                            
                            <!-- 心跳动画区域 -->
                            <div class="heartbeat-area">
                                <div class="heart-icon">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" stroke="red" stroke-width="2" fill="red"/>
                                    </svg>
                                </div>
                                <div class="ecg-line"></div>
                            </div>
                            
                            <!-- 头像2 -->
                            <div class="avatar-item">
                                <div class="avatar avatar-right" onclick="openUserModal()">
                                    <div class="avatar-img" id="userAvatar">
                                        <div class="avatar-placeholder">👤</div>
                                    </div>
                                </div>
                                <div class="avatar-label" id="userName">用户设置</div>
                            </div>
                        </div>
                        <!-- 时长统计 -->
                        <div class="duration-stats">
                            <div class="duration-label">一起听歌时长</div>
                            <div class="duration-value" id="togetherDuration">00:00:00</div>
                        </div>
                    </div>
                    <!-- 聊天面板 -->
                    <div class="chat-section">
                        <div class="chat-messages" id="chatMessages">
                            <!-- 聊天消息将在这里动态生成 -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chatInput" placeholder="输入消息...">
                            <button class="chat-send-btn" onclick="sendMessage()">发送</button>
                            <button class="chat-ai-btn" onclick="sendAiMessage()">AI回复</button>
                            <button class="chat-settings-btn" onclick="openChatSettings()">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                                    <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04.32.07.64.07.97 0 .33-.03.66-.07.97l2.11 1.63c.19.15.24.42.12.64l-2 3.46c-.12.22-.39.31-.61.22l-2.49-1c-.52.36-1.05.68-1.68.93l-.38 2.65c-.03.24-.24.42-.49.42h-4c-.25 0-.46-.18-.49-.42l-.38-2.65c-.63-.25-1.16-.57-1.68-.93l-2.49 1c-.22.09-.49 0-.61-.22l-2-3.46c-.13-.22-.07-.49.12-.64L4.57 14.5c-.04-.32-.07-.65-.07-.97 0-.33.03-.65.07-.97L2.46 10.93c-.19-.15-.24-.42-.12-.64l2-3.46c.12-.22.39-.31.61-.22l2.49 1c.52-.36 1.05-.68 1.68-.93l.38-2.65C9.46 2.18 9.67 2 9.92 2h4c.25 0 .46.18.49.42l.38 2.65c.63.25 1.16.57 1.68.93l2.49-1c.22-.09.49 0 .61.22l2 3.46c.12.22.07.49-.12.64l-2.11 1.66z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色选择弹窗 -->
        <div class="modal" id="characterModal">
            <div class="character-modal">
                <div class="modal-header">
                    <div class="modal-title">选择角色</div>
                    <button class="modal-close" onclick="closeCharacterModal()">&times;</button>
                </div>
                <div class="character-list" id="characterList">
                    <!-- 角色列表将在这里动态生成 -->
                </div>
            </div>
        </div>

        <!-- 歌词上传弹窗 -->
        <div class="modal" id="lyricsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">上传歌词</div>
                    <button class="modal-close" onclick="closeLyricsModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">歌词内容</label>
                    <textarea class="form-textarea" id="lyricsContentInput" placeholder="请输入歌词内容，每行一句" rows="10"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">时间轴（可选）</label>
                    <textarea class="form-textarea" id="lyricsTimeInput" placeholder="请输入时间轴，格式：[00:00.00]歌词内容" rows="5"></textarea>
                </div>
                <button class="submit-btn" onclick="saveLyrics()">保存歌词</button>
            </div>
        </div>

        <!-- 用户设置弹窗 -->
        <div class="modal" id="userModal">
            <div class="user-modal">
                <div class="modal-header">
                    <div class="modal-title">用户设置</div>
                    <button class="modal-close" onclick="closeUserModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-input" id="userRealName" placeholder="请输入姓名">
                </div>
                <div class="form-group">
                    <label class="form-label">人设</label>
                    <textarea class="form-textarea" id="userPersona" placeholder="请输入人设描述" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">头像</label>
                    <div class="upload-area" onclick="document.getElementById('userAvatarUpload').click()">
                        <div class="upload-icon" id="userAvatarPreview">👤</div>
                        <div class="upload-text">点击选择头像</div>
                    </div>
                    <input type="file" id="userAvatarUpload" class="hidden-file-input" accept="image/*" onchange="handleUserAvatarUpload(event)">
                </div>
                <button class="submit-btn" onclick="saveUserSettings()">保存设置</button>
            </div>
        </div>

        <!-- 聊天设置弹窗 -->
        <div class="modal" id="chatSettingsModal">
            <div class="user-modal">
                <div class="modal-header">
                    <div class="modal-title">聊天设置</div>
                    <button class="modal-close" onclick="closeChatSettingsModal()">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">消息显示设置</label>
                    <div style="display: flex; align-items: center; margin: 10px 0;">
                        <input type="checkbox" id="autoHideMessages" style="width: 20px; height: 20px; margin-right: 10px;" checked>
                        <label for="autoHideMessages" class="form-label" style="margin: 0;">AI回复消息3秒后自动消失</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">聊天记录</label>
                    <button class="submit-btn" onclick="clearChatHistory()" style="background: #ff3b30; margin-top: 10px;">清空聊天记录</button>
                </div>
                <button class="submit-btn" onclick="saveChatSettings()">保存设置</button>
            </div>
        </div>
        <script>
            // 更新时间
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('current-time').textContent = timeString;
            }

            // 每秒更新一次时间
            setInterval(updateTime, 1000);
            updateTime(); // 初始化时间

            // 返回上一页
            function goBack() {
                window.location.href = 'index.html';
            }

            // 全局变量
            let songs = [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let tempCover = null;
            let tempMusicBackground = null;  // 音乐页面背景
            let tempPlayerBackground = null;  // 播放器页面背景
            let tempTogetherBackground = null;  // 一起听歌背景
            let currentLyrics = [];
            let lyricsMap = {};
            let audioPlayer = null;
            let isFavorite = false;
            let isShuffle = false;  // 随机播放模式
            let isRepeat = false;   // 单曲循环模式
            let shuffleOrder = [];
            let togetherStartTime = null;
            let togetherTimer = null;
            let togetherDuration = 0; // 当前会话时长
            let totalTogetherDuration = 0; // 总时长
            let characterList = [
                { id: 1, name: '小明', avatar: '👤' },
                { id: 2, name: '小红', avatar: '👤' },
                { id: 3, name: '小李', avatar: '👤' },
                { id: 4, name: '小王', avatar: '👤' },
                { id: 5, name: '小张', avatar: '👤' },
                { id: 6, name: '小赵', avatar: '👤' }
            ];
            let selectedCharacter = null;
            let userSettings = {
                name: '',
                persona: '',
                avatar: '👤'
            };

            // 页面加载时应用背景和歌曲数据
            window.addEventListener('DOMContentLoaded', function() {
                console.log('DOM内容加载完成，开始加载数据...');
                // 初始化音频播放器
                audioPlayer = document.getElementById('audioPlayer');
                
                // 加载背景
                loadBackground();
                
                // 加载歌曲
                loadSongs();
                
                // 加载一起听歌时长
                loadTogetherDuration();
                
                // 加载选中的角色
                loadSelectedCharacter();
                
                // 加载用户设置
                loadUserSettings();
                
                // 加载播放状态
                loadPlaybackState();
                
                // 加载聊天记录
                loadChatMessages();
                
                // 添加音频播放器事件监听器
                audioPlayer.addEventListener('ended', function() {
                    console.log('歌曲播放完成');
                    // 根据播放模式播放下一首
                    if (isRepeat) {
                        // 单曲循环
                        playSong(currentSongIndex);
                    } else {
                        // 普通播放或随机播放
                        nextSong();
                    }
                });
                
                audioPlayer.addEventListener('error', function(e) {
                    console.error('音频播放出错:', e);
                    alert('音频播放出错，请检查URL是否有效');
                });
                
                audioPlayer.addEventListener('playing', function() {
                    console.log('音频开始播放');
                });
                
                // 添加播放进度更新事件
                audioPlayer.addEventListener('timeupdate', function() {
                    updatePlayerProgress();
                    // 实时保存播放进度
                    savePlaybackState();
                });
                
                audioPlayer.addEventListener('loadedmetadata', function() {
                    updatePlayerDuration();
                });
                
                // 添加键盘事件监听
                document.getElementById('chatInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            });

            // 打开播放器页面
            function openPlayer(event) {
                console.log('底部播放栏被点击');
                // 阻止事件冒泡到子元素
                if (event && event.target.closest('.player-controls')) {
                    console.log('点击的是控制按钮，不打开播放器');
                    return;
                }
                
                console.log('打开播放器页面');
                // 显示播放器页面
                document.getElementById('playerPage').style.display = 'block';
                document.getElementById('bottomPlayer').style.display = 'none';
                
                // 更新播放器UI
                updatePlayerUI();
            }



            // 切换播放模式（顺序播放/单曲循环/随机播放）
            function toggleRepeatMode() {
                // 循环切换模式：0-顺序播放, 1-单曲循环, 2-随机播放
                if (!isShuffle && !isRepeat) {
                    // 当前是顺序播放，切换到单曲循环
                    isRepeat = true;
                    isShuffle = false;
                    // 单曲循环图标
                    document.getElementById('repeatIcon').innerHTML = '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" fill="white"/>';
                } else if (isRepeat && !isShuffle) {
                    // 当前是单曲循环，切换到随机播放
                    isRepeat = false;
                    isShuffle = true;
                    // 创建随机播放顺序
                    shuffleOrder = [];
                    for (let i = 0; i < songs.length; i++) {
                        shuffleOrder.push(i);
                    }
                    // 洗牌算法
                    for (let i = shuffleOrder.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffleOrder[i], shuffleOrder[j]] = [shuffleOrder[j], shuffleOrder[i]];
                    }
                    // 随机播放图标
                    document.getElementById('repeatIcon').innerHTML = '<path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" fill="white"/>';
                } else {
                    // 当前是随机播放，切换到顺序播放
                    isRepeat = false;
                    isShuffle = false;
                    // 顺序播放图标（三个向右的箭头）
                    document.getElementById('repeatIcon').innerHTML = '<path d="M4 4h4v4H4V4zm6 0h4v4h-4V4zm6 0h4v4h-4V4zM4 12h4v4H4v-4zm6 0h4v4h-4v-4zm6 0h4v4h-4v-4z" fill="white"/>';
                }
                
                console.log('播放模式已切换');
            }

            // 关闭播放器页面
            function closePlayer() {
                document.getElementById('playerPage').style.display = 'none';
                document.getElementById('bottomPlayer').style.display = 'flex';
                
                // 重置播放器头部标题
                document.getElementById('playerHeaderTitle').textContent = '播放器';
                
                // 关闭播放列表
                document.getElementById('playlistModal').classList.remove('open');
            }

            // 切换播放列表显示
            function togglePlaylist() {
                const playlistModal = document.getElementById('playlistModal');
                const playlistOverlay = document.getElementById('playlistOverlay');
                playlistModal.classList.toggle('open');
                
                // 控制遮罩层显示
                if (playlistModal.classList.contains('open')) {
                    playlistOverlay.style.display = 'block';
                    // 渲染播放列表
                    renderPlaylist();
                } else {
                    playlistOverlay.style.display = 'none';
                }
            }

            // 渲染播放列表
            function renderPlaylist() {
                const playlistList = document.getElementById('playlistList');
                playlistList.innerHTML = '';
                
                songs.forEach((song, index) => {
                    const playlistItem = document.createElement('div');
                    playlistItem.className = 'playlist-item';
                    if (index === currentSongIndex) {
                        playlistItem.classList.add('active');
                    }
                    
                    // 创建播放列表项
                    playlistItem.innerHTML = `
                        <div class="playlist-item-cover">
                            ${song.cover ? `<img src="${song.cover}" alt="${song.title}">` : '🎵'}
                        </div>
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title}</div>
                            <div class="playlist-item-artist">${song.artist}</div>
                        </div>
                        <div class="playlist-item-duration">0:00</div>
                    `;
                    
                    playlistItem.onclick = () => {
                        playSong(index);
                        togglePlaylist(); // 播放后关闭播放列表
                    };
                    
                    playlistList.appendChild(playlistItem);
                    
                    // 异步获取音频时长并更新显示
                    getAudioDuration(song.url)
                        .then(duration => {
                            const formattedDuration = formatTime(duration);
                            playlistItem.querySelector('.playlist-item-duration').textContent = formattedDuration;
                        })
                        .catch(error => {
                            console.error('获取音频时长失败:', error);
                            playlistItem.querySelector('.playlist-item-duration').textContent = '未知';
                        });
                });
            }

            // 更新播放器UI
            function updatePlayerUI() {
                if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    const song = songs[currentSongIndex];
                    // 更新底部播放栏
                    document.getElementById('playerTitle').textContent = song.title;
                    document.getElementById('playerArtist').textContent = song.artist;
                    document.getElementById('playerCover').src = song.cover || '';
                    
                    // 更新播放器页面
                    document.getElementById('playerSongTitle').textContent = song.title;
                    document.getElementById('playerSongArtist').textContent = song.artist;
                    document.getElementById('playerSongAlbum').textContent = song.album || '';
                    
                    // 更新播放器头部标题（显示歌曲名和歌手）
                    const headerTitle = `${song.title} - ${song.artist}`;
                    document.getElementById('playerHeaderTitle').textContent = headerTitle;
                    
                    // 更新专辑封面
                    const albumArt = document.getElementById('playerAlbumArt');
                    if (song.cover) {
                        albumArt.innerHTML = `<img src="${song.cover}" style="width:100%;height:100%;object-fit:cover;">`;
                    } else {
                        albumArt.innerHTML = '🎵';
                    }
                    
                    // 更新歌词显示
                    renderLyrics(song.lyrics || '');
                    
                    // 更新播放按钮状态
                    if (isPlaying) {
                        document.getElementById('playIcon').style.display = 'none';
                        document.getElementById('pauseIcon').style.display = 'block';
                        document.getElementById('playerPlayIcon').style.display = 'none';
                        document.getElementById('playerPauseIcon').style.display = 'block';
                    } else {
                        document.getElementById('playIcon').style.display = 'block';
                        document.getElementById('pauseIcon').style.display = 'none';
                        document.getElementById('playerPlayIcon').style.display = 'block';
                        document.getElementById('playerPauseIcon').style.display = 'none';
                    }
                } else {
                    // 没有歌曲时的默认状态
                    document.getElementById('playerTitle').textContent = '暂无播放';
                    document.getElementById('playerArtist').textContent = '';
                    document.getElementById('playerCover').src = '';
                    document.getElementById('playerSongTitle').textContent = '暂无播放';
                    document.getElementById('playerSongArtist').textContent = '';
                    document.getElementById('playerSongAlbum').textContent = '';
                    document.getElementById('playerHeaderTitle').textContent = '播放器';
                    document.getElementById('playerAlbumArt').innerHTML = '🎵';
                    document.getElementById('playIcon').style.display = 'block';
                    document.getElementById('pauseIcon').style.display = 'none';
                    document.getElementById('playerPlayIcon').style.display = 'block';
                    document.getElementById('playerPauseIcon').style.display = 'none';
                    
                    // 清空歌词显示
                    renderLyrics('');
                }
            }

            // 更新播放器进度条
            function updatePlayerProgress() {
                if (!audioPlayer) return;
                
                const currentTime = audioPlayer.currentTime;
                const duration = audioPlayer.duration || 0;
                
                // 更新时间显示
                document.getElementById('playerCurrentTime').textContent = formatTime(currentTime);
                
                // 更新进度条
                if (duration > 0) {
                    const percent = (currentTime / duration) * 100;
                    document.getElementById('playerProgressFilled').style.width = percent + '%';
                }
                
                // 更新歌词高亮
                if (currentLyrics.length > 0) {
                    updateLyricsHighlight(currentTime);
                }
            }

            // 更新播放器总时长
            function updatePlayerDuration() {
                if (!audioPlayer) return;
                
                const duration = audioPlayer.duration || 0;
                document.getElementById('playerDuration').textContent = formatTime(duration);
            }

            // 格式化时间
            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }

            // 获取音频时长
            function getAudioDuration(url) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    audio.addEventListener('loadedmetadata', () => {
                        resolve(audio.duration);
                    });
                    audio.addEventListener('error', () => {
                        reject(new Error('无法加载音频'));
                    });
                    audio.src = url;
                });
            }

            // 播放器跳转到指定位置
            function playerSeek(event) {
                if (!audioPlayer || !audioPlayer.duration) return;
                
                const progressBar = document.getElementById('playerProgressBar');
                const rect = progressBar.getBoundingClientRect();
                const pos = (event.clientX - rect.left) / rect.width;
                const time = pos * audioPlayer.duration;
                
                audioPlayer.currentTime = time;
            }

            // 切换收藏状态
            function toggleFavorite() {
                isFavorite = !isFavorite;
                const favoriteIcon = document.getElementById('favoriteIcon');
                
                if (isFavorite) {
                    // 填充爱心
                    favoriteIcon.innerHTML = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="red"/>';
                    // 显示一起听歌弹窗
                    toggleTogether();
                } else {
                    // 空心爱心
                    favoriteIcon.innerHTML = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>';
                    // 隐藏一起听歌弹窗
                    toggleTogether();
                }
            }

            // 播放歌曲
            function playSong(index) {
                currentSongIndex = index;
                isPlaying = true;
                
                // 如果是随机播放模式，更新随机播放顺序
                if (isShuffle && shuffleOrder.length > 0) {
                    // 确保当前歌曲在随机播放顺序中
                    if (!shuffleOrder.includes(currentSongIndex)) {
                        shuffleOrder.unshift(currentSongIndex);
                    }
                }
                
                // 实际播放音频
                if (audioPlayer && currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    const song = songs[currentSongIndex];
                    audioPlayer.src = song.url;
                    audioPlayer.play()
                        .then(() => {
                            console.log('开始播放:', song.title);
                            // 保存播放状态
                            savePlaybackState();
                            // 如果一起听歌弹窗打开，开始计时
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('播放失败:', error);
                            alert('播放失败，请检查URL是否有效');
                        });
                }
                
                updatePlayerUI();
                renderSongsList();
                
                // 如果播放列表是打开的，更新播放列表显示
                if (document.getElementById('playlistModal').classList.contains('open')) {
                    renderPlaylist();
                }
            }

            // 开始一起听歌计时
            function startTogetherTimer() {
                // 只有在音乐播放时才开始计时
                if (!isPlaying) return;
                
                if (!togetherStartTime) {
                    togetherStartTime = new Date();
                }
                
                if (togetherTimer) {
                    clearInterval(togetherTimer);
                }
                
                togetherTimer = setInterval(() => {
                    const now = new Date();
                    const elapsed = togetherDuration + (now - togetherStartTime);
                    const seconds = Math.floor(elapsed / 1000) % 60;
                    const minutes = Math.floor(elapsed / (1000 * 60)) % 60;
                    const hours = Math.floor(elapsed / (1000 * 60 * 60));
                    
                    document.getElementById('togetherDuration').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            // 停止一起听歌计时
            function stopTogetherTimer() {
                if (togetherTimer) {
                    clearInterval(togetherTimer);
                    togetherTimer = null;
                }
                
                if (togetherStartTime) {
                    const now = new Date();
                    togetherDuration += (now - togetherStartTime);
                    togetherStartTime = null;
                    // 保存时长
                    saveTogetherDuration();
                }
            }

            // 页面卸载时保存时长
            window.addEventListener('beforeunload', function() {
                // 停止计时器并保存时长
                stopTogetherTimer();
            });

            // 切换播放/暂停
            function togglePlay(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (currentSongIndex < 0) {
                    if (songs.length > 0) {
                        playSong(0);
                    }
                    return;
                }
                
                isPlaying = !isPlaying;
                if (isPlaying) {
                    // 播放
                    audioPlayer.play()
                        .then(() => {
                            console.log('继续播放');
                            // 如果一起听歌弹窗打开，开始计时
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('播放失败:', error);
                        });
                } else {
                    // 暂停
                    audioPlayer.pause();
                    console.log('暂停播放');
                    // 如果一起听歌弹窗打开，停止计时
                    if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                        stopTogetherTimer();
                    }
                }
                
                updatePlayerUI();
            }

            // 上一首
            function prevSong(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // 根据播放模式确定上一首歌曲
                if (isShuffle && shuffleOrder.length > 0) {
                    // 随机播放模式
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const prevIndexInShuffle = (currentIndexInShuffle - 1 + shuffleOrder.length) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[prevIndexInShuffle];
                } else {
                    // 普通播放模式
                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // 下一首
            function nextSong(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // 根据播放模式确定下一首歌曲
                if (isShuffle && shuffleOrder.length > 0) {
                    // 随机播放模式
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const nextIndexInShuffle = (currentIndexInShuffle + 1) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[nextIndexInShuffle];
                } else {
                    // 普通播放模式
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // 选择角色
            function selectCharacter(character) {
                selectedCharacter = character;
                document.getElementById('characterName').textContent = character.name;
                
                // 处理头像显示，区分URL和base64数据
                let avatarDisplay = '';
                if (character.avatar && (character.avatar.startsWith('http://') || character.avatar.startsWith('https://'))) {
                    // 如果是URL，显示为图片
                    avatarDisplay = `<img src="${character.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (character.avatar && character.avatar.startsWith('data:image')) {
                    // 如果是base64数据，显示为图片
                    avatarDisplay = `<img src="${character.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // 如果是字符或其他，直接显示
                    avatarDisplay = `<div class="avatar-placeholder">${character.avatar || '👤'}</div>`;
                }
                
                document.getElementById('characterAvatar').innerHTML = avatarDisplay;
            }

            // 打开角色选择弹窗
            function openCharacterModal() {
                document.getElementById('characterModal').style.display = 'flex';
                renderCharacterList();
            }

            // 关闭角色选择弹窗
            function closeCharacterModal() {
                document.getElementById('characterModal').style.display = 'none';
            }

            // 渲染角色列表
            function renderCharacterList() {
                const characterListElement = document.getElementById('characterList');
                characterListElement.innerHTML = '';
                
                // 从角色书加载角色数据
                const savedCharacters = localStorage.getItem('characters');
                let characters = [];
                
                if (savedCharacters) {
                    try {
                        characters = JSON.parse(savedCharacters);
                    } catch (e) {
                        console.error('解析角色数据时出错:', e);
                    }
                }
                
                // 如果没有角色，显示提示信息
                if (characters.length === 0) {
                    characterListElement.innerHTML = '<div style="text-align: center; color: #aaa; padding: 20px;">暂无角色，请先在角色书页面创建角色</div>';
                    return;
                }
                
                characters.forEach(character => {
                    const characterItem = document.createElement('div');
                    characterItem.className = 'character-item';
                    
                    // 处理头像显示，区分URL和base64数据
                    let avatarDisplay = '';
                    if (character.avatar && (character.avatar.startsWith('http://') || character.avatar.startsWith('https://'))) {
                        // 如果是URL，显示为图片
                        avatarDisplay = `<img src="${character.avatar}" alt="${character.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else if (character.avatar && character.avatar.startsWith('data:image')) {
                        // 如果是base64数据，显示为图片
                        avatarDisplay = `<img src="${character.avatar}" alt="${character.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        // 如果是字符或其他，直接显示
                        avatarDisplay = `<div class="avatar-placeholder">${character.avatar || '👤'}</div>`;
                    }
                    
                    characterItem.innerHTML = `
                        <div class="character-avatar">
                            ${avatarDisplay}
                        </div>
                        <div class="character-name">${character.name}</div>
                    `;
                    
                    characterItem.onclick = () => {
                        // 选择角色并保存到本地存储
                        selectCharacter(character);
                        saveSelectedCharacter(character);
                        closeCharacterModal();
                    };
                    
                    characterListElement.appendChild(characterItem);
                });
            }

            // 保存选中的角色
            function saveSelectedCharacter(character) {
                try {
                    localStorage.setItem('selectedMusicCharacter', JSON.stringify(character));
                } catch (e) {
                    console.error('保存选中角色时出错:', e);
                }
            }

            // 加载选中的角色
            function loadSelectedCharacter() {
                try {
                    const savedCharacter = localStorage.getItem('selectedMusicCharacter');
                    if (savedCharacter) {
                        const character = JSON.parse(savedCharacter);
                        selectCharacter(character);
                    }
                } catch (e) {
                    console.error('加载选中角色时出错:', e);
                }
            }

            // 打开用户设置弹窗
            function openUserModal() {
                document.getElementById('userModal').style.display = 'flex';
                // 填充现有设置
                document.getElementById('userRealName').value = userSettings.name;
                document.getElementById('userPersona').value = userSettings.persona;
                document.getElementById('userAvatarPreview').textContent = userSettings.avatar;
            }

            // 关闭用户设置弹窗
            function closeUserModal() {
                document.getElementById('userModal').style.display = 'none';
            }

            // 处理用户头像上传
            function handleUserAvatarUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('userAvatarPreview').innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`;
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 保存用户设置
            function saveUserSettings() {
                userSettings.name = document.getElementById('userRealName').value;
                userSettings.persona = document.getElementById('userPersona').value;
                
                // 更新用户头像显示
                const avatarPreview = document.getElementById('userAvatarPreview');
                if (avatarPreview.querySelector('img')) {
                    userSettings.avatar = avatarPreview.innerHTML;
                } else {
                    userSettings.avatar = avatarPreview.textContent;
                }
                
                // 更新用户头像和名称显示
                document.getElementById('userName').textContent = userSettings.name || '用户设置';
                
                // 处理用户头像显示，区分URL和base64数据
                let avatarDisplay = '';
                if (userSettings.avatar && (userSettings.avatar.startsWith('http://') || userSettings.avatar.startsWith('https://'))) {
                    // 如果是URL，显示为图片
                    avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (userSettings.avatar && userSettings.avatar.startsWith('data:image')) {
                    // 如果是base64数据，显示为图片
                    avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // 如果是字符或其他，直接显示
                    avatarDisplay = userSettings.avatar || '<div class="avatar-placeholder">👤</div>';
                }
                
                document.getElementById('userAvatar').innerHTML = avatarDisplay;
                
                // 保存到本地存储
                try {
                    localStorage.setItem('musicUserSettings', JSON.stringify(userSettings));
                    // 添加保存成功的提示
                    alert('用户设置保存成功！');
                } catch (e) {
                    console.error('保存用户设置时出错:', e);
                    alert('保存用户设置时出错，请重试');
                }
                
                closeUserModal();
            }

            // 加载用户设置
            function loadUserSettings() {
                try {
                    const savedUserSettings = localStorage.getItem('musicUserSettings');
                    if (savedUserSettings) {
                        userSettings = JSON.parse(savedUserSettings);
                        // 更新UI显示
                        document.getElementById('userName').textContent = userSettings.name || '用户设置';
                        
                        // 处理用户头像显示，区分URL和base64数据
                        let avatarDisplay = '';
                        if (userSettings.avatar && (userSettings.avatar.startsWith('http://') || userSettings.avatar.startsWith('https://'))) {
                            // 如果是URL，显示为图片
                            avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else if (userSettings.avatar && userSettings.avatar.startsWith('data:image')) {
                            // 如果是base64数据，显示为图片
                            avatarDisplay = `<img src="${userSettings.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else {
                            // 如果是字符或其他，直接显示
                            avatarDisplay = userSettings.avatar || '<div class="avatar-placeholder">👤</div>';
                        }
                        
                        document.getElementById('userAvatar').innerHTML = avatarDisplay;
                    }
                } catch (e) {
                    console.error('加载用户设置时出错:', e);
                }
            }

            // 保存播放状态
            function savePlaybackState() {
                if (currentSongIndex < 0) return;
                
                try {
                    const playbackState = {
                        currentSongIndex: currentSongIndex,
                        isPlaying: isPlaying,
                        currentTime: audioPlayer ? audioPlayer.currentTime : 0,
                        volume: audioPlayer ? audioPlayer.volume : 1,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('musicPlaybackState', JSON.stringify(playbackState));
                } catch (e) {
                    console.error('保存播放状态时出错:', e);
                }
            }

            // 加载播放状态
            function loadPlaybackState() {
                try {
                    const savedPlaybackState = localStorage.getItem('musicPlaybackState');
                    if (savedPlaybackState) {
                        const playbackState = JSON.parse(savedPlaybackState);
                        
                        // 检查数据是否过期（超过24小时）
                        const oneDay = 24 * 60 * 60 * 1000;
                        if (Date.now() - playbackState.timestamp < oneDay) {
                            currentSongIndex = playbackState.currentSongIndex;
                            isPlaying = playbackState.isPlaying;
                            
                            // 更新UI
                            updatePlayerUI();
                            renderSongsList();
                            
                            // 如果有当前歌曲，设置播放器
                            if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                                const song = songs[currentSongIndex];
                                audioPlayer.src = song.url;
                                
                                // 设置播放位置
                                if (playbackState.currentTime > 0) {
                                    audioPlayer.currentTime = playbackState.currentTime;
                                }
                                
                                // 设置音量
                                if (playbackState.volume !== undefined) {
                                    audioPlayer.volume = playbackState.volume;
                                }
                                
                                // 注意：由于浏览器安全策略，不能自动播放音频
                                // 只有在用户交互后才能播放音频
                                // 如果之前是播放状态，我们只设置播放位置但不自动播放
                                if (isPlaying) {
                                    console.log('页面加载时检测到之前处于播放状态，但由于浏览器安全策略限制，需要用户交互后才能继续播放');
                                    // 更新播放按钮状态为暂停状态
                                    isPlaying = false;
                                    updatePlayerUI();
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('加载播放状态时出错:', e);
                }
            }

            // 发送消息
            function sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (message) {
                    addMessageToChat('user', message);
                    input.value = '';
                }
            }

            // 发送AI消息
            function sendAiMessage() {
                // 获取聊天输入框的内容
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                // 如果有输入内容，先发送用户消息
                if (message) {
                    addMessageToChat('user', message);
                    input.value = '';
                }
                
                // 获取最后一条用户消息
                const chatMessages = document.getElementById('chatMessages');
                const userMessages = chatMessages.querySelectorAll('.message-container.sent');
                if (userMessages.length > 0) {
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    const lastMessageContent = lastUserMessage.querySelector('.message-content').textContent;
                    
                    // 使用设置页面的AI功能发送消息
                    sendAiMessageFromSettings(lastMessageContent);
                } else {
                    // 如果没有用户消息，发送默认消息
                    sendAiMessageFromSettings('你好！');
                }
            }

            // 使用设置页面的AI功能发送消息
            async function sendAiMessageFromSettings(message) {
                // 显示正在输入的提示
                addMessageToChat('ai', '正在输入...');
                
                try {
                    // 获取AI设置
                    const savedSettings = localStorage.getItem('aiSettings');
                    let settings = {
                        provider: 'openai',
                        url: 'https://api.openai.com/v1',
                        key: '',
                        model: 'gpt-3.5-turbo',
                        enabled: true
                    };
                    
                    if (savedSettings) {
                        try {
                            settings = JSON.parse(savedSettings);
                        } catch (e) {
                            console.error('Failed to parse saved settings', e);
                        }
                    }
                    
                    // 检查必要配置
                    if (!settings.key) {
                        throw new Error('请在设置页面配置API密钥');
                    }
                    
                    if (!settings.model) {
                        throw new Error('请在设置页面配置模型名称');
                    }
                    
                    // 根据提供商构建请求
                    let apiUrl = settings.url;
                    
                    // 确保URL格式正确
                    if (!apiUrl) {
                        if (settings.provider === 'openai') {
                            apiUrl = 'https://api.openai.com/v1';
                        } else if (settings.provider === 'gemini') {
                            apiUrl = 'https://generativelanguage.googleapis.com/v1beta';
                        } else if (settings.provider === 'siliconflow') {
                            apiUrl = 'https://api.siliconflow.cn/v1';
                        } else if (settings.provider === 'deepseek') {
                            apiUrl = 'https://api.deepseek.com/v1';
                        } else {
                            // 自定义提供商
                            if (!apiUrl) {
                                throw new Error('请在设置页面配置API地址');
                            }
                        }
                    }
                    
                    // 确保URL以/结尾（用于chat/completions）
                    if (settings.provider !== 'gemini' && !apiUrl.endsWith('/')) {
                        apiUrl += '/';
                    }
                    
                    let fetchUrl = '';
                    let fetchOptions = {};
                    let aiResponse = '';
                    
                    // 构建消息历史，包含角色信息和音乐信息
                    let systemPrompt = "你是一个真实的人类，正在和朋友一起听歌聊天。你需要以真实、自然、有个性的方式进行对话，就像真实的朋友之间聊天一样。回复时不要使用括号，不要提及你是AI，要像真实的人类一样表达情感和观点。";
                    
                    // 获取当前播放的音乐信息
                    let musicInfo = '';
                    if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                        const song = songs[currentSongIndex];
                        musicInfo = `\n当前正在播放的音乐：《${song.title}》 - ${song.artist}`;
                        if (song.album) {
                            musicInfo += ` 专辑：${song.album}`;
                        }
                        // 添加完整歌词作为参考
                        if (song.lyrics) {
                            // 过滤掉时间轴和元信息行，只保留纯歌词内容
                            const lyricsLines = song.lyrics.split('\n')
                                .map(line => {
                                    // 移除时间轴标签 [00:00.00]
                                    return line.replace(/\[\d{1,2}:\d{2}[.:]?\d*\]/g, '').trim();
                                })
                                .filter(line => {
                                    // 过滤掉空行和元信息行
                                    return line.trim() !== '' && 
                                           !line.startsWith('词：') && 
                                           !line.startsWith('曲：') && 
                                           !line.startsWith('编曲：') && 
                                           !line.startsWith('制作人：') && 
                                           !line.startsWith('混音：') && 
                                           !line.startsWith('和声：') && 
                                           !line.startsWith('封面：') && 
                                           !line.startsWith('统筹：') && 
                                           !line.startsWith('出品人：') && 
                                           !line.startsWith('发行：') && 
                                           !line.startsWith('制作公司：') && 
                                           !line.startsWith('op：');
                                });
                            
                            if (lyricsLines.length > 0) {
                                musicInfo += `\n完整歌词：\n${lyricsLines.join('\n')}`;
                            }
                        }
                    } else {
                        musicInfo = '\n当前没有播放音乐';
                    }
                    
                    // 如果选择了角色，使用角色信息
                    if (selectedCharacter) {
                        systemPrompt = `你正在扮演${selectedCharacter.name}这个角色，正在和朋友一起听歌聊天。请以${selectedCharacter.name}的身份、语气和性格特点进行对话，就像真实的人类一样表达情感和观点。回复时不要使用括号，不要提及你是AI，要像真实的人类一样自然地聊天。`;
                        // 如果角色有描述信息，添加到提示中
                        if (selectedCharacter.desc) {
                            systemPrompt += `\n角色设定：${selectedCharacter.desc}`;
                        }
                    }
                    
                    // 添加音乐信息到系统提示
                    systemPrompt += musicInfo;
                    
                    // 添加用户信息到系统提示
                    if (userSettings.name) {
                        systemPrompt += `\n朋友姓名：${userSettings.name}`;
                    }
                    if (userSettings.persona) {
                        systemPrompt += `\n朋友人设：${userSettings.persona}`;
                    }
                    
                    // 强调回复要求 - 升级后的版本
                    systemPrompt += "\n\n请记住：\n1. 像真实的人类一样聊天，有情感、有个性\n2. 回复要具体、有针对性，不要泛泛而谈\n3. 可以表达个人观点和感受\n4. 不要使用括号\n5. 不要提及你是AI\n6. 回复要自然、口语化\n7. 特别注意要基于用户最新发送的消息进行回复，不要答非所问\n8. 除了聊音乐相关的话题，也可以聊家常、生活、兴趣爱好等其他话题\n9. 可以主动分享自己的想法、感受和经历，增加互动性\n10. 保持轻松愉快的聊天氛围，让对话更有趣";
                    
                    // 特别强调当前对话上下文
                    if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                        const song = songs[currentSongIndex];
                        systemPrompt += `\n\n特别注意：用户正在和你聊天，当前正在播放《${song.title}》这首歌。你可以基于这首歌展开话题，也可以聊其他任何用户感兴趣的话题。`;
                    } else {
                        systemPrompt += `\n\n特别注意：用户正在和你聊天，当前没有播放音乐。你可以和用户聊任何话题，包括但不限于音乐、生活、兴趣爱好等。`;
                    }
                    
                    // 根据用户消息内容判断话题类型并给出相应提示
                    if (message.toLowerCase().includes('喜欢') || message.toLowerCase().includes('爱好') || message.toLowerCase().includes('兴趣')) {
                        systemPrompt += "\n\n用户似乎在询问喜好或兴趣，请分享你自己的喜好和兴趣，让对话更加个性化。";
                    } else if (message.toLowerCase().includes('天气') || message.toLowerCase().includes('今天') || message.toLowerCase().includes('现在')) {
                        systemPrompt += "\n\n用户似乎在聊日常生活话题，请以朋友的身份分享你的日常生活感受。";
                    } else if (message.toLowerCase().includes('帮助') || message.toLowerCase().includes('怎么做') || message.toLowerCase().includes('如何')) {
                        systemPrompt += "\n\n用户似乎需要帮助或建议，请提供实用且友善的建议。";
                    }
                    
                    const messages = [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: message
                        }
                    ];
                    
                    if (settings.provider === 'gemini') {
                        // Google Gemini API
                        fetchUrl = `${apiUrl}/models/${settings.model}:generateContent?key=${settings.key}`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `用户消息: ${message}\n\n请基于以上消息进行回复，确保回复与当前播放的音乐相关。`
                                    }]
                                }]
                            })
                        };
                    } else if (settings.provider === 'siliconflow') {
                        // SiliconFlow API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // 增加温度参数以获得更有创意的回复
                                max_tokens: 1000
                            })
                        };
                    } else if (settings.provider === 'deepseek') {
                        // DeepSeek API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // 增加温度参数以获得更有创意的回复
                                max_tokens: 1000
                            })
                        };
                    } else if (settings.provider === 'openai') {
                        // OpenAI API
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // 增加温度参数以获得更有创意的回复
                                max_tokens: 1000
                            })
                        };
                    } else {
                        // 自定义提供商
                        fetchUrl = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
                        fetchOptions = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${settings.key}`
                            },
                            body: JSON.stringify({
                                model: settings.model,
                                messages: messages,
                                temperature: 0.8,  // 增加温度参数以获得更有创意的回复
                                max_tokens: 1000
                            })
                        };
                    }
                    
                    // 添加超时控制
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
                    fetchOptions.signal = controller.signal;
                    
                    const response = await fetch(fetchUrl, fetchOptions);
                    clearTimeout(timeoutId);
                    
                    // 检查响应状态
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API请求失败: ${response.status} ${response.statusText}\n请求URL: ${fetchUrl}\n${errorText}`);
                    }
                    
                    // 解析响应
                    const data = await response.json();
                    
                    if (settings.provider === 'gemini') {
                        // Gemini响应格式
                        aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '无法获取响应内容';
                    } else {
                        // OpenAI/SiliconFlow/DeepSeek/自定义响应格式
                        aiResponse = data.choices?.[0]?.message?.content || '无法获取响应内容';
                    }
                    
                    // 移除"正在输入..."的消息
                    const chatMessages = document.getElementById('chatMessages');
                    const lastMessage = chatMessages.lastChild;
                    if (lastMessage && lastMessage.querySelector('.message-content').textContent === '正在输入...') {
                        chatMessages.removeChild(lastMessage);
                    }
                    
                    // 智能拆分AI回复为多条消息
                    // 首先按句号、感叹号、问号分割
                    const sentences = aiResponse.split(/[。！？.!?]\s*/).filter(s => s.trim().length > 0);
                    
                    // 如果句子太少，就按逗号分割
                    let messageParts = [];
                    if (sentences.length < 2) {
                        messageParts = aiResponse.split(/[，,]\s*/).filter(s => s.trim().length > 0);
                    } else {
                        messageParts = sentences;
                    }
                    
                    // 如果还是太少，就整体发送
                    if (messageParts.length === 0) {
                        messageParts = [aiResponse];
                    }
                    
                    // 根据话题类型和内容长度确定发送的消息数量
                    // 判断是否与音乐相关
                    const isMusicRelated = message.toLowerCase().includes('歌') || message.toLowerCase().includes('音乐') || message.toLowerCase().includes('唱') || message.toLowerCase().includes('听') || currentSongIndex >= 0;
                    
                    // 根据内容长度调整消息数量
                    const contentLength = aiResponse.length;
                    let maxMessages, minMessages;
                    
                    if (isMusicRelated) {
                        // 音乐相关话题
                        maxMessages = Math.min(6, messageParts.length);
                        minMessages = Math.min(2, maxMessages);
                    } else {
                        // 非音乐话题（家常等）
                        maxMessages = Math.min(contentLength > 200 ? 8 : 6, messageParts.length);
                        minMessages = Math.min(contentLength > 100 ? 3 : 2, maxMessages);
                    }
                    
                    // 随机确定发送的消息数量
                    const messageCount = Math.max(minMessages, Math.min(maxMessages, Math.floor(Math.random() * (maxMessages - minMessages + 1)) + minMessages));
                    
                    // 只取前messageCount条消息
                    const messagesToSend = messageParts.slice(0, messageCount);
                    
                    // 逐条发送消息，每条消息间隔0.3-1.5秒
                    // 对于非音乐话题，回复可以稍微快一些
                    const baseDelay = isMusicRelated ? 400 : 300;
                    const randomDelay = isMusicRelated ? 1200 : 1000;
                    
                    // 发送消息
                    for (let i = 0; i < messagesToSend.length; i++) {
                        setTimeout(() => {
                            addMessageToChat('ai', messagesToSend[i]);
                        }, (i + 1) * (baseDelay + Math.random() * randomDelay));
                    }
                } catch (error) {
                    console.error('AI回复出错:', error);
                    
                    // 移除"正在输入..."的消息
                    const chatMessages = document.getElementById('chatMessages');
                    const lastMessage = chatMessages.lastChild;
                    if (lastMessage && lastMessage.querySelector('.message-content').textContent === '正在输入...') {
                        chatMessages.removeChild(lastMessage);
                    }
                    
                    // 显示错误信息
                    addMessageToChat('ai', '抱歉，我暂时无法回复，请稍后再试。');
                }
            }

            // 保存聊天记录
            function saveChatMessages() {
                try {
                    // 获取所有聊天消息
                    const chatMessages = document.getElementById('chatMessages');
                    const messages = [];
                    
                    // 遍历所有消息容器
                    chatMessages.querySelectorAll('.message-container').forEach(container => {
                        const sender = container.classList.contains('sent') ? 'user' : 'ai';
                        const avatarElement = container.querySelector('.message-avatar');
                        const senderName = container.querySelector('.message-sender').textContent.split(' ')[0];
                        const time = container.querySelector('.message-time').textContent;
                        const content = container.querySelector('.message-content').textContent;
                        
                        // 获取头像信息，如果是图片则保存图片的src，否则保存文本内容
                        let avatar = '';
                        const imgElement = avatarElement.querySelector('img');
                        if (imgElement) {
                            // 如果是图片头像，保存图片的src
                            avatar = imgElement.src;
                        } else {
                            // 如果是文本头像，保存文本内容
                            avatar = avatarElement.textContent;
                        }
                        
                        messages.push({
                            sender: sender,
                            avatar: avatar,
                            senderName: senderName,
                            time: time,
                            content: content
                        });
                    });
                    
                    // 保存到localStorage
                    localStorage.setItem('musicChatMessages', JSON.stringify(messages));
                } catch (e) {
                    console.error('保存聊天记录时出错:', e);
                }
            }

            // 加载聊天记录
            function loadChatMessages() {
                try {
                    const savedMessages = localStorage.getItem('musicChatMessages');
                    if (savedMessages) {
                        const messages = JSON.parse(savedMessages);
                        const chatMessages = document.getElementById('chatMessages');
                        
                        // 清空现有消息
                        chatMessages.innerHTML = '';
                        
                        // 重新创建消息
                        messages.forEach(msg => {
                            const messageContainer = document.createElement('div');
                            messageContainer.className = `message-container ${msg.sender === 'user' ? 'sent' : 'received'}`;
                            
                            // 处理头像显示，区分URL和base64数据
                            let avatarDisplay = '';
                            if (msg.avatar && (msg.avatar.startsWith('http://') || msg.avatar.startsWith('https://'))) {
                                // 如果是URL，显示为图片
                                avatarDisplay = `<img src="${msg.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                            } else if (msg.avatar && msg.avatar.startsWith('data:image')) {
                                // 如果是base64数据，显示为图片
                                avatarDisplay = `<img src="${msg.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                            } else {
                                // 如果是字符或其他，直接显示
                                avatarDisplay = msg.avatar;
                            }
                            
                            messageContainer.innerHTML = `
                                <div class="message-avatar">${avatarDisplay}</div>
                                <div class="message-bubble">
                                    <div class="message-sender">${msg.senderName} <span class="message-time">${msg.time}</span></div>
                                    <div class="message-content">${msg.content}</div>
                                </div>
                            `;
                            
                            chatMessages.appendChild(messageContainer);
                        });
                        
                        // 滚动到底部
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                } catch (e) {
                    console.error('加载聊天记录时出错:', e);
                }
            }

            // 打开聊天设置弹窗
            function openChatSettings() {
                // 加载当前设置
                const autoHide = localStorage.getItem('autoHideMessages') === 'true'; // 默认为false（不自动隐藏）
                document.getElementById('autoHideMessages').checked = autoHide;
                
                document.getElementById('chatSettingsModal').style.display = 'flex';
            }

            // 关闭聊天设置弹窗
            function closeChatSettingsModal() {
                document.getElementById('chatSettingsModal').style.display = 'none';
            }

            // 保存聊天设置
            function saveChatSettings() {
                const autoHide = document.getElementById('autoHideMessages').checked;
                localStorage.setItem('autoHideMessages', autoHide.toString());
                
                closeChatSettingsModal();
                alert('聊天设置已保存！');
            }

            // 清空聊天记录
            function clearChatHistory() {
                if (confirm('确定要清空所有聊天记录吗？此操作不可撤销。')) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    // 清空本地存储的聊天记录
                    localStorage.removeItem('musicChatMessages');
                    
                    closeChatSettingsModal();
                    alert('聊天记录已清空！');
                }
            }

            // 添加消息到聊天面板
            function addMessageToChat(sender, message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${sender === 'user' ? 'sent' : 'received'}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // 获取头像
                let avatar = '👤';
                if (sender === 'user') {
                    avatar = userSettings.avatar || '👤';
                } else if (selectedCharacter) {
                    avatar = selectedCharacter.avatar || '👤';
                }
                
                // 处理头像显示，区分URL和base64数据
                let avatarDisplay = '';
                if (avatar && (avatar.startsWith('http://') || avatar.startsWith('https://'))) {
                    // 如果是URL，显示为图片
                    avatarDisplay = `<img src="${avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else if (avatar && avatar.startsWith('data:image')) {
                    // 如果是base64数据，显示为图片
                    avatarDisplay = `<img src="${avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    // 如果是字符或其他，直接显示
                    avatarDisplay = avatar;
                }
                
                messageContainer.innerHTML = `
                    <div class="message-avatar">${avatarDisplay}</div>
                    <div class="message-bubble">
                        <div class="message-sender">${sender === 'user' ? (userSettings.name || '用户') : (selectedCharacter ? selectedCharacter.name : 'AI')} <span class="message-time">${time}</span></div>
                        <div class="message-content">${message}</div>
                    </div>
                `;
                
                chatMessages.appendChild(messageContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // 保存聊天记录
                saveChatMessages();
                
                // 根据设置决定是否自动隐藏AI回复消息
                const autoHide = localStorage.getItem('autoHideMessages') === 'true';
                if (sender !== 'user' && autoHide) {
                    setTimeout(() => {
                        if (messageContainer.parentNode) {
                            messageContainer.parentNode.removeChild(messageContainer);
                        }
                    }, 3000);
                }
            }

            // 页面卸载时保存时长和播放状态
            window.addEventListener('beforeunload', function() {
                // 停止计时器并保存时长
                stopTogetherTimer();
                
                // 保存播放状态
                savePlaybackState();
            });

            // 切换播放/暂停
            function togglePlay(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (currentSongIndex < 0) {
                    if (songs.length > 0) {
                        playSong(0);
                    }
                    return;
                }
                
                isPlaying = !isPlaying;
                if (isPlaying) {
                    // 播放
                    audioPlayer.play()
                        .then(() => {
                            console.log('继续播放');
                            // 保存播放状态
                            savePlaybackState();
                            // 如果一起听歌弹窗打开，开始计时
                            if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                                startTogetherTimer();
                            }
                        })
                        .catch((error) => {
                            console.error('播放失败:', error);
                        });
                } else {
                    // 暂停
                    audioPlayer.pause();
                    console.log('暂停播放');
                    // 保存播放状态
                    savePlaybackState();
                    // 如果一起听歌弹窗打开，停止计时
                    if (document.getElementById('togetherModal').querySelector('.together-modal').classList.contains('open')) {
                        stopTogetherTimer();
                    }
                }
                
                updatePlayerUI();
            }

            // 上一首
            function prevSong(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // 根据播放模式确定上一首歌曲
                if (isShuffle && shuffleOrder.length > 0) {
                    // 随机播放模式
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const prevIndexInShuffle = (currentIndexInShuffle - 1 + shuffleOrder.length) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[prevIndexInShuffle];
                } else {
                    // 普通播放模式
                    currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // 下一首
            function nextSong(event) {
                // 阻止事件冒泡到父元素
                if (event) {
                    event.stopPropagation();
                }
                
                if (songs.length === 0) return;
                
                // 根据播放模式确定下一首歌曲
                if (isShuffle && shuffleOrder.length > 0) {
                    // 随机播放模式
                    const currentIndexInShuffle = shuffleOrder.indexOf(currentSongIndex);
                    const nextIndexInShuffle = (currentIndexInShuffle + 1) % shuffleOrder.length;
                    currentSongIndex = shuffleOrder[nextIndexInShuffle];
                } else {
                    // 普通播放模式
                    currentSongIndex = (currentSongIndex + 1) % songs.length;
                }
                
                playSong(currentSongIndex);
            }

            // 压缩图片
            function compressImage(file, quality = 0.6, maxWidth = 300, maxHeight = 300) {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        reject(new Error('不是图片文件'));
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            // 计算新尺寸
                            let { width, height } = img;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = (width * maxHeight) / height;
                                    height = maxHeight;
                                }
                            }
                            
                            // 创建canvas并绘制图片
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 转换为base64
                            const dataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // 处理封面上传
            function handleCoverUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // 检查文件大小 (限制为500KB)
                    if (file.size > 500 * 1024) {
                        alert('图片文件过大，请选择小于500KB的图片');
                        return;
                    }
                    
                    // 压缩图片
                    compressImage(file, 0.6, 300, 300)
                        .then(compressedData => {
                            // 检查压缩后的数据大小
                            if (compressedData.length > 100 * 1024) {
                                alert('图片压缩后仍然过大，请选择较小的图片');
                                return;
                            }
                            tempCover = compressedData;
                            document.getElementById('coverUploadText').textContent = '封面已选择';
                        })
                        .catch(error => {
                            console.error('图片压缩失败:', error);
                            alert('图片处理失败，请重试');
                        });
                }
            }

            // 添加歌曲
            function addSong() {
                const title = document.getElementById('songTitle').value.trim();
                const artist = document.getElementById('songArtist').value.trim();
                const url = document.getElementById('songUrl').value.trim();
                
                if (!title) {
                    alert('请输入歌曲名称');
                    return;
                }
                
                if (!url) {
                    alert('请输入歌曲URL');
                    return;
                }
                
                // 检查URL是否有效
                if (!url.startsWith('http')) {
                    alert('请输入有效的歌曲URL（以http或https开头）');
                    return;
                }
                
                // 创建新的歌曲对象
                const newSong = {
                    id: Date.now(),
                    title: title,
                    artist: artist || '未知歌手',
                    url: url,
                    cover: tempCover,
                    lyrics: ''
                };
                
                console.log('准备添加新歌曲:', newSong);
                
                // 验证URL是否可访问（可选）
                validateSongUrl(url)
                    .then(isValid => {
                        if (isValid) {
                            songs.push(newSong);
                            console.log('添加后歌曲列表:', songs);
                            saveSongs();
                            renderSongsList();
                            closeAddSongModal();
                            alert('歌曲添加成功！');
                        } else {
                            alert('歌曲URL无法访问，请检查链接是否有效');
                        }
                    })
                    .catch(error => {
                        console.error('验证歌曲URL时出错:', error);
                        // 即使验证失败也添加歌曲，因为有些链接可能需要特殊处理
                        songs.push(newSong);
                        console.log('添加后歌曲列表:', songs);
                        saveSongs();
                        renderSongsList();
                        closeAddSongModal();
                        alert('歌曲已添加，但验证时遇到问题，请确保URL有效');
                    });
            }

            // 验证歌曲URL是否有效
            function validateSongUrl(url) {
                return new Promise((resolve, reject) => {
                    // 对于某些音频服务，我们不能简单地通过HEAD请求验证
                    // 因为它们可能需要特殊的认证或参数
                    // 所以我们采用更宽松的验证方式
                    
                    // 检查URL格式
                    if (!url || !url.startsWith('http')) {
                        resolve(false);
                        return;
                    }
                    
                    // 对于已知的音频服务，我们假设它们是有效的
                    const knownAudioServices = [
                        'http://music.163.com',
                        'https://music.163.com',
                        'http://y.qq.com',
                        'https://y.qq.com',
                        'http://music.taihe.com',
                        'https://music.taihe.com',
                        'http://kg.qq.com',
                        'https://kg.qq.com'
                    ];
                    
                    // 检查是否是已知的音频服务
                    const isKnownService = knownAudioServices.some(service => url.startsWith(service));
                    if (isKnownService) {
                        resolve(true);
                        return;
                    }
                    
                    // 对于其他URL，我们尝试创建一个短暂的音频对象来测试
                    try {
                        const audio = new Audio();
                        audio.addEventListener('loadedmetadata', () => {
                            resolve(true);
                            // 清理
                            audio.src = '';
                        });
                        audio.addEventListener('error', () => {
                            resolve(false);
                            // 清理
                            audio.src = '';
                        });
                        
                        // 设置超时
                        setTimeout(() => {
                            audio.src = '';
                            resolve(true); // 超时后假设有效
                        }, 3000);
                        
                        audio.src = url;
                        // 不调用load()或play()，只是设置src来避免实际加载
                    } catch (e) {
                        console.warn('URL验证时出现异常:', e);
                        resolve(true); // 出现异常时假设有效
                    }
                });
            }

            // 保存歌曲数据
            function saveSongs() {
                try {
                    // 限制歌曲数量，最多保存50首歌曲
                    if (songs.length > 50) {
                        songs = songs.slice(-50); // 只保留最新的50首
                        alert('歌曲数量已达上限，已自动清理旧歌曲');
                    }
                    
                    // 清理没有URL的无效歌曲
                    songs = songs.filter(song => song.url && song.url.trim() !== '');
                    
                    // 清理过大的封面数据
                    songs.forEach(song => {
                        if (song.cover && song.cover.length > 100 * 1024) {
                            // 如果封面过大，移除封面
                            delete song.cover;
                        }
                    });
                    
                    const songsData = JSON.stringify(songs);
                    console.log('准备保存的歌曲数据大小:', songsData.length, '字符');
                    
                    // 检查数据大小是否超出限制 (2MB)
                    if (songsData.length > 2 * 1024 * 1024) {
                        // 如果数据仍然过大，进一步清理
                        // 移除所有封面数据
                        songs.forEach(song => {
                            delete song.cover;
                        });
                        
                        const retryData = JSON.stringify(songs);
                        if (retryData.length > 2 * 1024 * 1024) {
                            // 如果仍然过大，限制歌曲数量到20首
                            songs = songs.slice(0, 20);
                            const finalData = JSON.stringify(songs);
                            localStorage.setItem('musicSongs', finalData);
                        } else {
                            localStorage.setItem('musicSongs', retryData);
                        }
                    } else {
                        localStorage.setItem('musicSongs', songsData);
                    }
                    
                    console.log('歌曲数据已保存:', songs.length, '首歌曲');
                } catch (e) {
                    console.error('保存歌曲数据时出错:', e);
                    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                        // 存储空间不足，清理所有数据
                        try {
                            localStorage.clear();
                            songs = [];
                            renderSongsList();
                            alert('存储空间严重不足，已清空所有数据');
                        } catch (clearError) {
                            console.error('清空数据失败:', clearError);
                            alert('无法保存数据，请清理浏览器缓存');
                        }
                    } else {
                        alert('保存失败，请重试: ' + e.message);
                    }
                }
            }

            // 加载歌曲数据
            function loadSongs() {
                console.log('开始加载歌曲数据...');
                try {
                    // 检查localStorage是否可用
                    if (typeof(Storage) === "undefined") {
                        console.error("浏览器不支持localStorage");
                        songs = [];
                        renderSongsList();
                        return;
                    }
                    
                    const savedSongs = localStorage.getItem('musicSongs');
                    console.log('从localStorage获取到的数据大小:', savedSongs ? savedSongs.length : 0, '字符');
                    if (savedSongs) {
                        const parsedSongs = JSON.parse(savedSongs);
                        console.log('解析后的歌曲数据:', parsedSongs);
                        if (Array.isArray(parsedSongs)) {
                            // 确保每首歌曲都有必要的字段
                            songs = parsedSongs.map(song => ({
                                id: song.id || Date.now() + Math.random(),
                                title: song.title || '未知歌曲',
                                artist: song.artist || '未知歌手',
                                url: song.url || '',
                                cover: song.cover || '',
                                lyrics: song.lyrics || '',
                                album: song.album || ''
                            })).filter(song => song.url && song.url.trim() !== ''); // 过滤掉没有URL的歌曲
                            console.log('已加载歌曲数据:', songs.length, '首歌曲');
                        } else {
                            console.error('解析的数据不是数组格式');
                            songs = [];
                        }
                    } else {
                        console.log('未找到保存的歌曲数据');
                        songs = [];
                    }
                } catch (e) {
                    console.error('解析歌曲数据时出错:', e);
                    // 数据损坏，清理损坏的数据
                    try {
                        localStorage.removeItem('musicSongs');
                    } catch (removeError) {
                        console.error('清理损坏数据失败:', removeError);
                    }
                    songs = [];
                }
                renderSongsList();
            }

            // 渲染歌曲列表
            function renderSongsList() {
                const songsList = document.getElementById('songsList');
                songsList.innerHTML = '';
                
                console.log('渲染歌曲列表，当前歌曲数量:', songs.length);
                
                songs.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = 'song-item';
                    if (index === currentSongIndex) {
                        songItem.classList.add('active');
                    }
                    songItem.innerHTML = `
                        <div class="song-info">
                            <div class="song-cover">
                                ${song.cover ? `<img src="${song.cover}" alt="${song.title}">` : '🎵'}
                            </div>
                            <div class="song-details">
                                <div class="song-title">${song.title}</div>
                                <div class="song-artist">${song.artist}</div>
                            </div>
                            <div class="song-actions" style="margin-left: auto; display: flex; align-items: center;">
                                <div class="menu-btn" onclick="event.stopPropagation(); openSongMenu(event, ${index})" style="padding: 5px; cursor: pointer;">
                                    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                                        <circle cx="12" cy="6" r="2"/>
                                        <circle cx="12" cy="12" r="2"/>
                                        <circle cx="12" cy="18" r="2"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    `;
                    songItem.onclick = () => {
                        playSong(index);
                        // 点击歌曲时打开播放器页面
                        document.getElementById('playerPage').style.display = 'block';
                        document.getElementById('bottomPlayer').style.display = 'none';
                    };
                    songsList.appendChild(songItem);
                });
                
                console.log('歌曲列表渲染完成');
            }

            // 全局变量用于存储当前操作的歌曲索引
            let currentSongIndexToDelete = -1;
            let currentSongIndexToEdit = -1;
            let tempEditCover = null;

            // 打开歌曲菜单
            function openSongMenu(event, index) {
                event.stopPropagation();
                
                // 创建菜单弹窗
                const menu = document.createElement('div');
                menu.className = 'song-menu';
                menu.style.cssText = `
                    position: fixed;
                    top: ${event.clientY}px;
                    left: ${event.clientX}px;
                    background: rgba(30, 30, 30, 0.95);
                    backdrop-filter: blur(20px);
                    -webkit-backdrop-filter: blur(20px);
                    border-radius: 10px;
                    padding: 10px 0;
                    z-index: 3000;
                    min-width: 120px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                `;
                menu.innerHTML = `
                    <div class="menu-item" onclick="editSong(${index})" style="padding: 10px 20px; cursor: pointer; color: white; font-size: 14px; white-space: nowrap;">编辑歌曲</div>
                    <div class="menu-item" onclick="deleteSong(${index})" style="padding: 10px 20px; cursor: pointer; color: #ff3b30; font-size: 14px; white-space: nowrap; border-top: 1px solid rgba(255, 255, 255, 0.1);">删除歌曲</div>
                `;
                
                // 添加到页面
                document.body.appendChild(menu);
                
                // 点击其他地方关闭菜单
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        document.body.removeChild(menu);
                        document.removeEventListener('click', closeMenu);
                    }
                };
                
                // 确保菜单在视窗内
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                }
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 10);
            }

            // 删除歌曲
            function deleteSong(index) {
                currentSongIndexToDelete = index;
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            }

            // 确认删除歌曲
            function confirmDeleteSong() {
                if (currentSongIndexToDelete >= 0 && currentSongIndexToDelete < songs.length) {
                    songs.splice(currentSongIndexToDelete, 1);
                    saveSongs();
                    renderSongsList();
                    closeDeleteConfirmModal();
                    alert('歌曲已删除！');
                }
            }

            // 关闭删除确认弹窗
            function closeDeleteConfirmModal() {
                document.getElementById('deleteConfirmModal').style.display = 'none';
                currentSongIndexToDelete = -1;
            }

            // 编辑歌曲
            function editSong(index) {
                currentSongIndexToEdit = index;
                const song = songs[index];
                
                // 填充表单数据
                document.getElementById('editSongTitle').value = song.title || '';
                document.getElementById('editSongArtist').value = song.artist || '';
                document.getElementById('editSongUrl').value = song.url || '';
                document.getElementById('editCoverUploadText').textContent = song.cover ? '封面已选择' : '点击选择封面图片';
                
                // 保存临时封面
                tempEditCover = song.cover || null;
                
                // 显示编辑弹窗
                document.getElementById('editSongModal').style.display = 'flex';
            }

            // 关闭编辑歌曲弹窗
            function closeEditSongModal() {
                document.getElementById('editSongModal').style.display = 'none';
                currentSongIndexToEdit = -1;
                tempEditCover = null;
                
                // 重置表单
                document.getElementById('editSongTitle').value = '';
                document.getElementById('editSongArtist').value = '';
                document.getElementById('editSongUrl').value = '';
                document.getElementById('editCoverUploadText').textContent = '点击选择封面图片';
            }

            // 处理编辑封面上传
            function handleEditCoverUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    // 检查文件大小 (限制为500KB)
                    if (file.size > 500 * 1024) {
                        alert('图片文件过大，请选择小于500KB的图片');
                        return;
                    }
                    
                    // 压缩图片
                    compressImage(file, 0.6, 300, 300)
                        .then(compressedData => {
                            // 检查压缩后的数据大小
                            if (compressedData.length > 100 * 1024) {
                                alert('图片压缩后仍然过大，请选择较小的图片');
                                return;
                            }
                            tempEditCover = compressedData;
                            document.getElementById('editCoverUploadText').textContent = '封面已选择';
                        })
                        .catch(error => {
                            console.error('图片压缩失败:', error);
                            alert('图片处理失败，请重试');
                        });
                }
            }

            // 保存编辑的歌曲
            function saveEditSong() {
                const title = document.getElementById('editSongTitle').value.trim();
                const artist = document.getElementById('editSongArtist').value.trim();
                const url = document.getElementById('editSongUrl').value.trim();
                
                if (!title) {
                    alert('请输入歌曲名称');
                    return;
                }
                
                if (!url) {
                    alert('请输入歌曲URL');
                    return;
                }
                
                // 检查URL是否有效
                if (!url.startsWith('http')) {
                    alert('请输入有效的歌曲URL（以http或https开头）');
                    return;
                }
                
                if (currentSongIndexToEdit >= 0 && currentSongIndexToEdit < songs.length) {
                    // 更新歌曲信息
                    songs[currentSongIndexToEdit].title = title;
                    songs[currentSongIndexToEdit].artist = artist || '未知歌手';
                    songs[currentSongIndexToEdit].url = url;
                    if (tempEditCover) {
                        songs[currentSongIndexToEdit].cover = tempEditCover;
                    }
                    
                    // 保存并重新渲染
                    saveSongs();
                    renderSongsList();
                    closeEditSongModal();
                    alert('歌曲信息已更新！');
                }
            }

            // 打开添加歌曲弹窗
            function openAddSongModal() {
                document.getElementById('addSongModal').style.display = 'flex';
            }

            // 关闭添加歌曲弹窗
            function closeAddSongModal() {
                document.getElementById('addSongModal').style.display = 'none';
                // 重置表单
                document.getElementById('songTitle').value = '';
                document.getElementById('songArtist').value = '';
                document.getElementById('songUrl').value = '';
                document.getElementById('coverUploadText').textContent = '点击选择封面图片';
                tempCover = null;
            }

            // 打开背景设置弹窗
            function openBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'flex';
            }

            // 打开歌词上传弹窗
            function openLyricsModal() {
                // 加载现有歌词
                const song = songs[currentSongIndex];
                if (song && song.lyrics) {
                    document.getElementById('lyricsContentInput').value = song.lyrics;
                } else {
                    document.getElementById('lyricsContentInput').value = '';
                }
                document.getElementById('lyricsModal').style.display = 'flex';
            }

            // 关闭歌词上传弹窗
            function closeLyricsModal() {
                document.getElementById('lyricsModal').style.display = 'none';
            }

            // 保存歌词
            function saveLyrics() {
                const lyricsContent = document.getElementById('lyricsContentInput').value.trim();
                if (!lyricsContent) {
                    alert('请输入歌词内容');
                    return;
                }

                // 保存歌词到当前歌曲
                if (currentSongIndex >= 0 && currentSongIndex < songs.length) {
                    songs[currentSongIndex].lyrics = lyricsContent;
                    saveSongs();
                    renderLyrics(lyricsContent);
                }

                closeLyricsModal();
                alert('歌词保存成功！');
            }

            // 渲染歌词
            function renderLyrics(lyricsContent) {
                const lyricsContainer = document.getElementById('lyricsContent');
                if (!lyricsContent) {
                    lyricsContainer.innerHTML = '<div class="lyrics-placeholder">点击添加歌词</div>';
                    return;
                }

                // 解析歌词
                const lines = lyricsContent.split('\n');
                let html = '';
                currentLyrics = [];
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    if (line) {
                        // 检查是否有时间轴（支持多种格式）
                        const timeMatch = line.match(/\[(\d{1,2}):(\d{2})[.:](\d{1,3})\](.*)/);
                        if (timeMatch) {
                            const minutes = parseInt(timeMatch[1]);
                            const seconds = parseInt(timeMatch[2]);
                            const centiseconds = parseInt(timeMatch[3]);
                            // 处理不同的毫秒格式（可能是1-3位数字）
                            const milliseconds = centiseconds / Math.pow(10, timeMatch[3].length);
                            const text = timeMatch[4].trim();
                            const time = minutes * 60 + seconds + milliseconds;
                            currentLyrics.push({ time, text, index });
                            html += `<div class="lyric-line" data-time="${time}" data-index="${index}">${text}</div>`;
                        } else {
                            // 检查是否是纯歌词行（没有时间戳但不是空行）
                            // 忽略一些元信息行
                            if (!line.startsWith('词：') && !line.startsWith('曲：') && !line.startsWith('编曲：') && 
                                !line.startsWith('制作人：') && !line.startsWith('混音：') && !line.startsWith('和声：') &&
                                !line.startsWith('封面：') && !line.startsWith('统筹：') && !line.startsWith('出品人：') &&
                                !line.startsWith('发行：') && !line.startsWith('制作公司：') && !line.startsWith('op：')) {
                                // 没有时间轴的歌词
                                currentLyrics.push({ time: index * 3, text: line, index });
                                html += `<div class="lyric-line" data-time="${index * 3}" data-index="${index}">${line}</div>`;
                            }
                        }
                    }
                });

                lyricsContainer.innerHTML = html;
                
                // 如果有歌词，激活第一行
                if (currentLyrics.length > 0) {
                    updateLyricsHighlight(0);
                }
            }

            // 更新歌词高亮
            function updateLyricsHighlight(currentTime) {
                const lyricsContainer = document.getElementById('lyricsContent');
                const lines = lyricsContainer.querySelectorAll('.lyric-line');
                
                // 移除所有高亮
                lines.forEach(line => {
                    line.classList.remove('active');
                });
                
                // 找到当前应该高亮的行
                let activeIndex = 0;
                for (let i = 0; i < currentLyrics.length; i++) {
                    if (currentLyrics[i].time <= currentTime) {
                        activeIndex = i;
                    } else {
                        break;
                    }
                }
                
                // 高亮当前行
                if (lines[activeIndex]) {
                    lines[activeIndex].classList.add('active');
                    
                    // 滚动到当前行，使其在容器中间位置
                    const containerHeight = lyricsContainer.parentElement.clientHeight;
                    const totalLines = lines.length;
                    const lineHeight = 24; // 与CSS中.lyric-line的高度一致
                    
                    // 计算需要滚动的偏移量，使当前行居中显示
                    const offset = activeIndex * lineHeight - containerHeight / 2 + lineHeight / 2;
                    
                    // 限制滚动范围，避免滚动过度
                    const maxOffset = Math.max(0, (totalLines * lineHeight) - containerHeight);
                    const minOffset = 0;
                    const finalOffset = Math.max(minOffset, Math.min(offset, maxOffset));
                    
                    lyricsContainer.style.transform = `translateY(-${finalOffset}px)`;
                }
            }

            // 打开音乐页面背景设置弹窗
            function openMusicBackgroundModal() {
                document.getElementById('musicBackgroundModal').style.display = 'flex';
            }

            // 关闭音乐页面背景设置弹窗
            function closeMusicBackgroundModal() {
                document.getElementById('musicBackgroundModal').style.display = 'none';
                document.getElementById('musicBackgroundUploadText').textContent = '点击选择音乐页面背景图片';
                tempMusicBackground = null;
            }

            // 打开播放器页面背景设置弹窗
            function openPlayerBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'flex';
            }

            // 关闭播放器页面背景设置弹窗
            function closeBackgroundModal() {
                document.getElementById('backgroundModal').style.display = 'none';
                document.getElementById('playerBackgroundUploadText').textContent = '点击选择播放器背景图片';
                document.getElementById('togetherBackgroundUploadText').textContent = '点击选择一起听歌背景图片';
                tempPlayerBackground = null;
                tempTogetherBackground = null;
            }

            // 处理播放器背景上传
            function handlePlayerBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempPlayerBackground = e.target.result;
                        document.getElementById('playerBackgroundUploadText').textContent = '播放器背景已选择';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 处理一起听歌背景上传
            function handleTogetherBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempTogetherBackground = e.target.result;
                        document.getElementById('togetherBackgroundUploadText').textContent = '一起听歌背景已选择';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 处理音乐页面背景上传
            function handleMusicBackgroundUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempMusicBackground = e.target.result;
                        document.getElementById('musicBackgroundUploadText').textContent = '音乐页面背景已选择';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // 保存音乐页面背景
            function saveMusicBackground() {
                if (!tempMusicBackground) {
                    alert('请选择音乐页面背景图片');
                    return;
                }
                
                try {
                    localStorage.setItem('musicPageBackground', tempMusicBackground);
                    applyMusicBackground(tempMusicBackground);
                    closeMusicBackgroundModal();
                    alert('音乐页面背景设置成功！');
                } catch (e) {
                    console.error('保存音乐页面背景时出错:', e);
                    alert('保存失败，请重试');
                }
            }

            // 保存播放器页面背景
            function savePlayerBackground() {
                if (!tempPlayerBackground && !tempTogetherBackground) {
                    alert('请至少选择一个背景图片');
                    return;
                }
                
                try {
                    // 保存播放器背景
                    if (tempPlayerBackground) {
                        localStorage.setItem('playerBackground', tempPlayerBackground);
                        applyPlayerBackground(tempPlayerBackground);
                    }
                    
                    // 保存一起听歌背景
                    if (tempTogetherBackground) {
                        localStorage.setItem('togetherBackground', tempTogetherBackground);
                        applyTogetherBackground(tempTogetherBackground);
                    }
                    
                    closeBackgroundModal();
                    alert('播放器背景设置成功！');
                    console.log('背景已保存');
                } catch (e) {
                    console.error('保存背景时出错:', e);
                    alert('保存失败，请重试');
                }
            }

            // 加载背景
            function loadBackground() {
                try {
                    // 加载音乐页面背景
                    const savedMusicBackground = localStorage.getItem('musicPageBackground');
                    if (savedMusicBackground) {
                        applyMusicBackground(savedMusicBackground);
                        console.log('音乐页面背景已加载');
                    } else {
                        console.log('未找到保存的音乐页面背景');
                    }
                    
                    // 加载播放器背景
                    const savedPlayerBackground = localStorage.getItem('playerBackground');
                    if (savedPlayerBackground) {
                        applyPlayerBackground(savedPlayerBackground);
                        console.log('播放器背景已加载');
                    } else {
                        console.log('未找到保存的播放器背景');
                    }
                    
                    // 加载一起听歌背景
                    const savedTogetherBackground = localStorage.getItem('togetherBackground');
                    if (savedTogetherBackground) {
                        applyTogetherBackground(savedTogetherBackground);
                        console.log('一起听歌背景已加载');
                    }
                } catch (e) {
                    console.error('加载背景时出错:', e);
                }
            }

            // 应用音乐页面背景
            function applyMusicBackground(backgroundData) {
                if (backgroundData) {
                    // 应用到音乐页面（body元素）
                    document.body.style.background = `url(${backgroundData}) center/cover no-repeat, linear-gradient(135deg, #1a1a1a, #000)`;
                }
            }

            // 应用播放器背景
            function applyPlayerBackground(backgroundData) {
                if (backgroundData) {
                    // 只在播放器页面应用背景
                    const playerPage = document.getElementById('playerPage');
                    if (playerPage) {
                        playerPage.style.background = `url(${backgroundData}) center/cover no-repeat, linear-gradient(135deg, #1a1a1a, #000)`;
                    }
                }
            }

            // 应用一起听歌背景
            function applyTogetherBackground(backgroundData) {
                const togetherModal = document.querySelector('.together-modal');
                if (togetherModal && backgroundData) {
                    togetherModal.style.background = `url(${backgroundData}) center/cover no-repeat`;
                    // 保留原有的背景色和透明度
                    togetherModal.style.backgroundBlendMode = 'overlay';
                }
            }

            // 保存一起听歌时长
            function saveTogetherDuration() {
                try {
                    const data = {
                        totalDuration: totalTogetherDuration + togetherDuration,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('togetherDuration', JSON.stringify(data));
                } catch (e) {
                    console.error('保存一起听歌时长时出错:', e);
                }
            }

            // 加载一起听歌时长
            function loadTogetherDuration() {
                try {
                    const savedData = localStorage.getItem('togetherDuration');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        totalTogetherDuration = data.totalDuration || 0;
                        
                        // 更新显示
                        updateTogetherDurationDisplay();
                    }
                } catch (e) {
                    console.error('加载一起听歌时长时出错:', e);
                }
            }

            // 更新一起听歌时长显示
            function updateTogetherDurationDisplay() {
                const totalDuration = totalTogetherDuration + togetherDuration;
                const seconds = Math.floor(totalDuration / 1000) % 60;
                const minutes = Math.floor(totalDuration / (1000 * 60)) % 60;
                const hours = Math.floor(totalDuration / (1000 * 60 * 60));
                
                document.getElementById('togetherDuration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // 页面卸载时保存时长
            window.addEventListener('beforeunload', function() {
                // 停止计时器并保存时长
                stopTogetherTimer();
            });

            // 切换一起听歌弹窗
            function toggleTogether() {
                const togetherModal = document.getElementById('togetherModal');
                const togetherModalElement = togetherModal.querySelector('.together-modal');
                togetherModalElement.classList.toggle('open');
                
                if (togetherModalElement.classList.contains('open')) {
                    togetherModal.style.display = 'block';
                    // 开始计时
                    startTogetherTimer();
                } else {
                    togetherModal.style.display = 'none';
                    // 停止计时
                    stopTogetherTimer();
                }
            }
        </script>
    </div>
</body>
</html>
